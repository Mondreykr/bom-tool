---
phase: 05-state-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/ui/state.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "All 22 global state variables are defined in js/ui/state.js"
    - "Flat BOM tab reads/writes state through imported state object"
    - "Hierarchy tab reads/writes state through imported state object"
    - "No inline `let` declarations remain for Flat BOM or Hierarchy tab state variables"
    - "Automated tests pass (no regressions from state centralization)"
  artifacts:
    - path: "js/ui/state.js"
      provides: "Centralized state object with all 22 global variables"
      exports: ["state"]
    - path: "index.html"
      provides: "Updated imports using state module for Flat BOM and Hierarchy tabs"
  key_links:
    - from: "index.html"
      to: "js/ui/state.js"
      via: "import { state } from './js/ui/state.js'"
      pattern: "state\\."
---

<objective>
Create the centralized state module and migrate Flat BOM tab + Hierarchy tab state variables.

Purpose: Establish the state centralization pattern and migrate the two smaller tabs (8 variables, ~70 references), leaving the large Comparison tab for Plan 02.
Output: js/ui/state.js with all 22 state variables; index.html updated so Flat BOM and Hierarchy tabs use `state.xxx` instead of bare variable names.
</objective>

<execution_context>
@C:\Users\amcallister\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\amcallister\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@index.html
@js/core/tree.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create js/ui/state.js with all 22 state variables</name>
  <files>js/ui/state.js</files>
  <action>
Create directory `js/ui/` if it doesn't exist, then create `js/ui/state.js`.

**Design decision: State object pattern.** Export a single `state` object (NOT individual getter/setter functions). Rationale:
- tree.js getter pattern works for 3 variables but would require 44+ functions for 22 variables
- State object keeps imports simple: `import { state } from './js/ui/state.js'`
- Code changes are minimal and mechanical: `csvData` becomes `state.csvData`
- Object properties like `state.oldBomInfo.partNumber` read naturally
- Low-risk decision, easily changed later

The state.js file must:
1. Export a single `state` object containing ALL 22 variables with their original default values
2. Have NO DOM dependencies (tests run in Node.js)
3. Include clear section comments matching the original code structure

**Exact state object contents:**

```javascript
// state.js - Centralized application state
// All global state variables consolidated from index.html

export const state = {
    // ========================================
    // FLAT BOM TAB STATE
    // ========================================
    csvData: null,
    flattenedBOM: null,
    treeRoot: null,
    uploadedFilename: null,

    // ========================================
    // COMPARISON TAB STATE
    // ========================================
    oldBomData: null,
    oldBomFlattened: null,
    oldBomInfo: { partNumber: '', revision: '', description: '' },
    oldBomFilename: null,
    oldBomTree: null,
    oldSelectedNode: null,

    newBomData: null,
    newBomFlattened: null,
    newBomInfo: { partNumber: '', revision: '', description: '' },
    newBomFilename: null,
    newBomTree: null,
    newSelectedNode: null,

    comparisonResults: [],
    currentFilter: 'all',

    // ========================================
    // HIERARCHY TAB STATE
    // ========================================
    hierarchyData: null,
    hierarchyTree: null,
    hierarchyFilename: null,
    hierarchyRootInfo: { partNumber: '', revision: '', description: '' }
};
```

**IMPORTANT:** The `oldBomInfo`, `newBomInfo`, and `hierarchyRootInfo` objects may have dynamic properties added at runtime (e.g., `.scopedPartNumber`, `.isScoped`). Using a plain object allows this naturally.
  </action>
  <verify>
Verify the file exists and has correct structure:
- `node -e "import('./js/ui/state.js').then(m => { const s = m.state; console.log('Keys:', Object.keys(s).length); console.log('csvData:', s.csvData); console.log('oldBomInfo:', JSON.stringify(s.oldBomInfo)); console.log('comparisonResults:', JSON.stringify(s.comparisonResults)); console.log('currentFilter:', s.currentFilter); })"` (run from project root)
- Should show 22 keys, correct default values
  </verify>
  <done>js/ui/state.js exports a `state` object with exactly 22 properties matching the original default values. No DOM dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate Flat BOM and Hierarchy tab state to state module</name>
  <files>index.html</files>
  <action>
Update index.html to import and use the state module for Flat BOM tab (4 variables) and Hierarchy tab (4 variables).

**Step 1: Add import statement.**
Add to the existing import block (after the compare.js import, before the `// Global state` comment):
```javascript
import { state } from './js/ui/state.js';
```

**Step 2: Remove Flat BOM tab `let` declarations (lines ~400-404).**
Remove these 4 lines:
```javascript
let csvData = null;
let flattenedBOM = null;
let treeRoot = null;
let uploadedFilename = null;
```
Replace with a comment: `// Flat BOM tab state: state.csvData, state.flattenedBOM, state.treeRoot, state.uploadedFilename`

**Step 3: Remove Hierarchy tab `let` declarations (lines ~2191-2194).**
Remove these 4 lines:
```javascript
let hierarchyData = null;
let hierarchyTree = null;
let hierarchyFilename = null;
let hierarchyRootInfo = { partNumber: '', revision: '', description: '' };
```
Replace with a comment: `// Hierarchy tab state: state.hierarchyData, state.hierarchyTree, state.hierarchyFilename, state.hierarchyRootInfo`

**Step 4: Update ALL references in Flat BOM tab code.**
Every occurrence of these bare variable names in the Flat BOM section (~lines 400-1042) must be prefixed with `state.`:
- `csvData` → `state.csvData` (reads AND writes, ~14 occurrences)
- `flattenedBOM` → `state.flattenedBOM` (reads AND writes, ~10 occurrences)
- `treeRoot` → `state.treeRoot` (reads AND writes, ~4 occurrences)
- `uploadedFilename` → `state.uploadedFilename` (reads AND writes, ~10 occurrences)

**CRITICAL:** Be precise with replacements. Do NOT change:
- DOM element const names (e.g., `fileNameDisplay` is NOT a state variable)
- Function parameter names
- String literals
- `oldBomFilename`, `newBomFilename` (those are Comparison tab — Plan 02)

**Step 5: Update ALL references in Hierarchy tab code.**
Every occurrence of these bare variable names in the Hierarchy section (~lines 2187-end) must be prefixed with `state.`:
- `hierarchyData` → `state.hierarchyData` (~8 occurrences)
- `hierarchyTree` → `state.hierarchyTree` (~10 occurrences)
- `hierarchyFilename` → `state.hierarchyFilename` (~6 occurrences)
- `hierarchyRootInfo` → `state.hierarchyRootInfo` (~8 occurrences)

**CRITICAL:** Do NOT change:
- DOM element const names starting with `hierarchy` (e.g., `hierarchyUploadZone`, `hierarchyFileInput`, etc.)
- Only change the 4 state variable names listed above

**Assignment patterns to watch for:**
- `csvData = parsedData;` → `state.csvData = parsedData;`
- `flattenedBOM = sortBOM(flattenBOM(treeRoot, unitQty));` → `state.flattenedBOM = sortBOM(flattenBOM(state.treeRoot, unitQty));`
- `hierarchyRootInfo = { partNumber: '', ... }` → `state.hierarchyRootInfo = { partNumber: '', ... }`
- `hierarchyRootInfo.partNumber = ...` → `state.hierarchyRootInfo.partNumber = ...`

**Reset function patterns to watch for:**
Reset functions typically set state variables back to null. Make sure all of these are updated:
- `csvData = null;` → `state.csvData = null;`
- `flattenedBOM = null;` → `state.flattenedBOM = null;`
- etc.
  </action>
  <verify>
1. Run automated tests: `cd test && node run-tests.js` — all tests that were passing before must still pass
2. Grep for remaining bare declarations: search index.html for `let csvData`, `let flattenedBOM`, `let treeRoot`, `let uploadedFilename`, `let hierarchyData`, `let hierarchyTree`, `let hierarchyFilename`, `let hierarchyRootInfo` — NONE should remain
3. Grep for `import { state }` in index.html — must exist exactly once
4. Verify no bare `csvData` references remain in Flat BOM section (all should be `state.csvData`)
5. Verify no bare `hierarchyData` references remain in Hierarchy section (all should be `state.hierarchyData`)
  </verify>
  <done>
- 8 `let` declarations removed from index.html (4 Flat BOM + 4 Hierarchy)
- All ~70 references updated to `state.xxx` pattern
- Import statement added for state module
- Automated tests pass with no regressions
  </done>
</task>

</tasks>

<verification>
1. `cd test && node run-tests.js` — automated tests pass (same results as before Phase 5)
2. `grep -c "let csvData\|let flattenedBOM\|let treeRoot\|let uploadedFilename\|let hierarchyData\|let hierarchyTree\|let hierarchyFilename\|let hierarchyRootInfo" index.html` — returns 0
3. `grep -c "import { state }" index.html` — returns 1
4. `node -e "import('./js/ui/state.js').then(m => console.log('state keys:', Object.keys(m.state).length))"` — returns 22
5. Comparison tab `let` declarations still present (they move in Plan 02)
</verification>

<success_criteria>
- js/ui/state.js exists with 22 state properties and correct defaults
- Flat BOM tab (4 vars, ~38 refs) migrated to state module
- Hierarchy tab (4 vars, ~32 refs) migrated to state module
- 8 inline `let` declarations removed
- Automated tests pass with identical outputs
- Comparison tab state declarations untouched (Plan 02 scope)
</success_criteria>

<output>
After completion, create `.planning/phases/05-state-management/05-01-SUMMARY.md`
</output>
