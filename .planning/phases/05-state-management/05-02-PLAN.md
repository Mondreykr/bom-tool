---
phase: 05-state-management
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - index.html
autonomous: true

must_haves:
  truths:
    - "All 14 Comparison tab state variables use state module"
    - "No inline `let` declarations remain for any of the 22 state variables"
    - "Comparison tab functionality preserved (file upload, tree selection, comparison, filtering, exports all reference correct state)"
    - "Automated tests pass (no regressions)"
  artifacts:
    - path: "index.html"
      provides: "Fully migrated state — zero bare state variable declarations"
  key_links:
    - from: "index.html"
      to: "js/ui/state.js"
      via: "state.oldBomData, state.newBomData, state.comparisonResults, etc."
      pattern: "state\\.(old|new)Bom"
---

<objective>
Migrate all 14 Comparison tab state variables to the centralized state module.

Purpose: Complete state centralization by migrating the largest tab (14 variables, ~156 references). After this plan, all 22 global state variables use the state module.
Output: index.html with zero bare state variable declarations — all 22 variables accessed through `state.xxx`.
</objective>

<execution_context>
@C:\Users\amcallister\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\amcallister\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-state-management/05-01-SUMMARY.md
@index.html
@js/ui/state.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Comparison tab state declarations to state module</name>
  <files>index.html</files>
  <action>
Remove the 14 Comparison tab `let` declarations (~lines 1048-1063) and replace with a comment.

**Remove these exact declarations:**
```javascript
let oldBomData = null;
let oldBomFlattened = null;
let oldBomInfo = { partNumber: '', revision: '', description: '' };
let oldBomFilename = null;
let oldBomTree = null;
let oldSelectedNode = null;

let newBomData = null;
let newBomFlattened = null;
let newBomInfo = { partNumber: '', revision: '', description: '' };
let newBomFilename = null;
let newBomTree = null;
let newSelectedNode = null;

let comparisonResults = [];
let currentFilter = 'all';
```

**Replace with comment:**
```javascript
// Comparison tab state: state.oldBomData, state.oldBomFlattened, state.oldBomInfo, state.oldBomFilename,
//   state.oldBomTree, state.oldSelectedNode, state.newBomData, state.newBomFlattened, state.newBomInfo,
//   state.newBomFilename, state.newBomTree, state.newSelectedNode, state.comparisonResults, state.currentFilter
```
  </action>
  <verify>Search index.html for `let oldBomData`, `let newBomData`, `let comparisonResults`, `let currentFilter` — none should remain.</verify>
  <done>14 Comparison tab `let` declarations removed from index.html.</done>
</task>

<task type="auto">
  <name>Task 2: Update all Comparison tab state references to use state module</name>
  <files>index.html</files>
  <action>
Update ALL ~156 references to the 14 Comparison tab state variables throughout the Comparison section of index.html (~lines 1044-2186). Every bare variable name must be prefixed with `state.`.

**Variables to migrate (with approximate occurrence counts):**

| Variable | Occurrences | Pattern Examples |
|----------|-------------|-----------------|
| `oldBomData` | ~9 | `oldBomData = data;`, `if (oldBomData)` |
| `oldBomFlattened` | ~6 | `oldBomFlattened = flattenBOM(...)` |
| `oldBomInfo` | ~20 | `oldBomInfo.partNumber`, `oldBomInfo = { ... }` |
| `oldBomFilename` | ~11 | `oldBomFilename = file.name`, `oldBomFilename || 'N/A'` |
| `oldBomTree` | ~10 | `oldBomTree = buildTree(...)`, `oldBomTree.partNumber` |
| `oldSelectedNode` | ~12 | `oldSelectedNode = node`, `if (oldSelectedNode)` |
| `newBomData` | ~9 | `newBomData = data;`, `if (newBomData)` |
| `newBomFlattened` | ~6 | `newBomFlattened = flattenBOM(...)` |
| `newBomInfo` | ~20 | `newBomInfo.partNumber`, `newBomInfo = { ... }` |
| `newBomFilename` | ~11 | `newBomFilename = file.name` |
| `newBomTree` | ~10 | `newBomTree = buildTree(...)` |
| `newSelectedNode` | ~12 | `newSelectedNode = node` |
| `comparisonResults` | ~14 | `comparisonResults = compareBOMs(...)`, `comparisonResults.filter(...)` |
| `currentFilter` | ~6 | `currentFilter = 'all'`, `if (currentFilter === 'all')` |

**CRITICAL replacement rules:**

1. **Simple reads:** `oldBomData` → `state.oldBomData`
2. **Assignments:** `oldBomData = data;` → `state.oldBomData = data;`
3. **Property access:** `oldBomInfo.partNumber` → `state.oldBomInfo.partNumber`
4. **Property assignment:** `oldBomInfo.partNumber = x` → `state.oldBomInfo.partNumber = x`
5. **Object reset:** `oldBomInfo = { partNumber: '', ... }` → `state.oldBomInfo = { partNumber: '', ... }`
6. **Null checks:** `if (oldBomData)` → `if (state.oldBomData)`
7. **Template literals:** `` `${oldBomInfo.partNumber}` `` → `` `${state.oldBomInfo.partNumber}` ``
8. **Ternary:** `oldBomFilename || 'N/A'` → `state.oldBomFilename || 'N/A'`
9. **Method calls on state:** `comparisonResults.filter(...)` → `state.comparisonResults.filter(...)`
10. **Array checks:** `comparisonResults.length` → `state.comparisonResults.length`

**DO NOT change:**
- DOM element const names (e.g., `oldBomZone`, `oldBomInput`, `oldBomFileInfo`, `oldBomFileName`, `oldBomFileMeta`, `newBomZone`, `newBomInput`, `newBomFileInfo`, `newBomFileName`, `newBomFileMeta`, `compareBtn`, `resetCompareBtn`, `resetScopeBtn`, `compareMessage`, `compareResults`, `compareBody`, `exportCompareExcelBtn`, `exportCompareHtmlBtn`, tree panel DOM elements like `oldBomTreePanel`, `oldBomPanelName`, `oldBomTreeContainer`, `oldBomSelectedDisplay`, `oldBomChangeFile`, `oldBomScopeDisplay`, and their `new` counterparts)
- Function names (e.g., `renderSelectionTree`, `renderSelectionNode`, `selectNode`)
- Function parameters that shadow variable names
- String literals or HTML attribute values
- CSS class names

**Approach:** Work through the Comparison section systematically from top to bottom. The section starts at the `// BOM COMPARISON - STATE & DOM ELEMENTS` comment and ends at the `// HIERARCHY VIEW - STATE & DOM ELEMENTS` comment.

**Watch for the reset function pattern:** The comparison reset function sets all 14 variables back to defaults. Make sure every one is updated:
```javascript
// Before:
oldBomData = null;
oldBomFlattened = null;
oldBomInfo = { partNumber: '', revision: '', description: '' };
// etc.

// After:
state.oldBomData = null;
state.oldBomFlattened = null;
state.oldBomInfo = { partNumber: '', revision: '', description: '' };
// etc.
```

**Watch for the scoped comparison patterns:** The scoped comparison code manipulates `oldSelectedNode`, `newSelectedNode`, `oldBomTree`, `newBomTree` extensively. Every reference must be updated.

**Watch for export function patterns:** The Excel and HTML export functions in the Comparison section reference `oldBomInfo`, `newBomInfo`, `oldBomFilename`, `newBomFilename`, `comparisonResults`. All must be updated.
  </action>
  <verify>
1. Run automated tests: `cd test && node run-tests.js` — all tests that were passing before must still pass
2. Search for bare state variable references that should have been migrated:
   - `grep -n "[^.]oldBomData[^A-Z]" index.html` should only show the state comment and `state.oldBomData` patterns
   - `grep -n "let oldBomData\|let newBomData\|let comparisonResults\|let currentFilter" index.html` returns 0 matches
   - `grep -n "let oldBomFlattened\|let newBomFlattened\|let oldBomInfo\|let newBomInfo" index.html` returns 0 matches
   - `grep -n "let oldBomFilename\|let newBomFilename\|let oldBomTree\|let newBomTree" index.html` returns 0 matches
   - `grep -n "let oldSelectedNode\|let newSelectedNode" index.html` returns 0 matches
3. Verify NO `let` declarations remain for ANY of the 22 state variables in the entire file
4. Count `state.` occurrences — should be approximately 226 (70 from Plan 01 + 156 from this plan)
  </verify>
  <done>
- All ~156 Comparison tab state references updated to `state.xxx` pattern
- Zero bare state variable `let` declarations remain in index.html
- All 22 state variables now accessed through centralized state module
- Automated tests pass with no regressions
  </done>
</task>

</tasks>

<verification>
1. `cd test && node run-tests.js` — automated tests pass (same results as before Phase 5)
2. Verify ZERO `let` declarations for any state variable:
   ```
   grep -c "let csvData\|let flattenedBOM\|let treeRoot\|let uploadedFilename" index.html  → 0
   grep -c "let oldBomData\|let oldBomFlattened\|let oldBomInfo\|let oldBomFilename" index.html  → 0
   grep -c "let oldBomTree\|let oldSelectedNode\|let newBomData\|let newBomFlattened" index.html  → 0
   grep -c "let newBomInfo\|let newBomFilename\|let newBomTree\|let newSelectedNode" index.html  → 0
   grep -c "let comparisonResults\|let currentFilter\|let hierarchyData\|let hierarchyTree" index.html  → 0
   grep -c "let hierarchyFilename\|let hierarchyRootInfo" index.html  → 0
   ```
3. `node -e "import('./js/ui/state.js').then(m => console.log('state keys:', Object.keys(m.state).length))"` — returns 22
4. `grep -c "state\." index.html` — approximately 226 occurrences
</verification>

<success_criteria>
- All 14 Comparison tab state variables migrated to state module
- Zero bare state variable declarations remain in index.html (all 22 migrated)
- All ~156 Comparison tab references updated to `state.xxx`
- Automated tests pass with identical outputs
- Phase 5 complete: STATE-01, STATE-02, STATE-03 all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-state-management/05-02-SUMMARY.md`
</output>
