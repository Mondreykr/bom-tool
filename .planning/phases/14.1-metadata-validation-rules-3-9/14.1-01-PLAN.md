---
phase: 14.1-metadata-validation-rules-3-9
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - js/core/tree.js
  - js/core/validate.js
  - test/validation-tests.js
autonomous: true

must_haves:
  truths:
    - "Invalid part numbers block merge with descriptive error citing Rule 3"
    - "Empty descriptions block merge with descriptive error citing Rule 4"
    - "Non-integer revisions block merge with descriptive error citing Rule 5"
    - "Invalid NS Item Type values block merge with descriptive error citing Rule 6"
    - "Invalid Component Type values block merge with descriptive error citing Rule 7"
    - "Invalid UoM values block merge with descriptive error citing Rule 8"
    - "Cross-field inconsistencies block merge with descriptive error citing Rule 9"
    - "Metadata validation runs on every node before merge-level validation"
    - "All metadata errors collected alongside merge errors"
  artifacts:
    - "js/core/tree.js — rawLength field on BOMNode"
    - "js/core/validate.js — validateMetadata function for Rules 3-9"
    - "test/validation-tests.js — tests for Rules 3-9"
  key_links:
    - "validate.js:validateMetadata called inside walkAndValidate before Rules 0-2"
---

<objective>
Implement metadata validation Rules 3-9 as specified in docs/validation-logic.md.

Purpose: Catch invalid metadata (part number format, empty descriptions, non-integer revisions, invalid whitelisted values, cross-field inconsistencies) before merge execution. All rules are hard blocks.

Output: Working metadata validation with full test coverage, integrated into the existing validateBOM() walker.
</objective>

<execution_context>
@C:/Users/amcallister/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/amcallister/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/validation-logic.md
@js/core/validate.js
@js/core/tree.js
@test/validation-tests.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rawLength field to BOMNode and implement validateMetadata function</name>
  <files>js/core/tree.js, js/core/validate.js</files>
  <action>
**BOMNode change (js/core/tree.js):**
Add `this.rawLength = rowData.Length || '';` to the BOMNode constructor, BEFORE the existing `this.length = parseLength(rowData.Length)` line. This preserves the raw string value from XML/CSV for Rule 9 cross-field validation of Length.

**Metadata validation (js/core/validate.js):**

Create and export a `validateMetadata(node, ancestorPath)` function that checks Rules 3-9 on a single node. Returns an array of error objects (same format as existing errors: `{message, path, rule}`).

Rule implementations:

**Rule 3 — Part Number Format:**
- Regex: `^(1\d{6}(-\d{2}(-\d)?)?|[23]\d{5})$`
- Test `node.partNumber` against regex
- Rule ID: `'invalid-part-number'`
- Error: `{PartNumber} at {path}: Part number does not match expected format (1xxxxxx, 2xxxxx, or 3xxxxx)`

**Rule 4 — Description Required:**
- Check `!node.description || node.description.trim() === ''`
- Rule ID: `'missing-description'`
- Error: `{PartNumber} at {path}: Description is empty — every part must have a description`

**Rule 5 — Revision Must Be Integer:**
- Check `node.revision` is a string representing a whole number: `/^\d+$/.test(String(node.revision).trim())`
- Rule ID: `'invalid-revision'`
- Error: `{PartNumber} at {path}: Revision '{value}' is not a valid integer`

**Rule 6 — NS Item Type Whitelist:**
- Allowed: `['Inventory', 'Lot Numbered Inventory', 'Assembly']`
- Only check if `node.nsItemType` is present and non-empty (missing is caught by existing check)
- Rule ID: `'invalid-ns-item-type'`
- Error: `{PartNumber} at {path}: NS Item Type '{value}' is not a recognized type (expected Inventory, Lot Numbered Inventory, or Assembly)`

**Rule 7 — Component Type Whitelist:**
- Allowed: `['Purchased', 'Manufactured', 'Raw Stock', 'Assembly']`
- Rule ID: `'invalid-component-type'`
- Error: `{PartNumber} at {path}: Component Type '{value}' is not a recognized type (expected Purchased, Manufactured, Raw Stock, or Assembly)`

**Rule 8 — Unit of Measure Whitelist:**
- Allowed: `['ea', 'in', 'sq in']`
- Rule ID: `'invalid-uofm'`
- Error: `{PartNumber} at {path}: Unit of Measure '{value}' is not recognized (expected ea, in, or sq in)`

**Rule 9 — Cross-Field Consistency:**
- Only run if NS Item Type passed Rule 6 (is a valid value)
- Use `node.rawLength` for Length checks (NOT `node.length` which is processed)

Sub-rules by NS Item Type:

If "Inventory":
- UoM must be `ea` → error if not
- rawLength must be empty, blank, or `-` → error if has a value
- Component Type must be `Purchased` or `Manufactured` → error if not

If "Assembly":
- UoM must be `ea` → error if not
- rawLength must be empty, blank, or `-` → error if has a value
- Component Type must be `Assembly` or `Manufactured` → error if not

If "Lot Numbered Inventory":
- UoM must be `in` or `sq in` → error if not
- rawLength must be a decimal number, optionally with "in" suffix (regex: `/^\d+(\.\d+)?(in)?$/`) → error if not matching
- Component Type must be `Raw Stock` → error if not

Rule ID for all Rule 9 errors: `'cross-field-inconsistency'`
Error format: `{PartNumber} at {path}: {FieldName} '{value}' is not valid for NS Item Type '{nsItemType}' (expected {expectedValues})`

**Integration into validateBOM (js/core/validate.js):**

In the `walkAndValidate` function, AFTER the missing-NS-Item-Type check and BEFORE the Released assembly rules, add a call to `validateMetadata(node, currentPath)` and push all returned errors into the `errors` array. This ensures metadata validation runs on EVERY node (not just Released assemblies) before merge-level rules.

Specifically: After the block that checks `!node.nsItemType || node.nsItemType === ''` and returns early, add:
```javascript
// Metadata validation (Rules 3-9) — runs on every node
const metadataErrors = validateMetadata(node, currentPath || node.partNumber);
errors.push(...metadataErrors);
```

This placement ensures:
1. Missing NS Item Type is caught first (existing check)
2. Metadata rules run on every node that HAS an NS Item Type
3. Merge rules (0-2) still run after metadata rules
4. All errors are collected together
  </action>
  <verify>Read validate.js and tree.js to confirm: rawLength field exists, validateMetadata is exported, all 7 rules implemented with correct regex/whitelists, integration point in walkAndValidate exists.</verify>
  <done>validateMetadata function exists with Rules 3-9, rawLength field on BOMNode, integration into walkAndValidate complete.</done>
</task>

<task type="auto">
  <name>Task 2: Write tests for Rules 3-9 and run full test suite</name>
  <files>test/validation-tests.js</files>
  <action>
Add tests 16-30 to the existing test/validation-tests.js file. Follow the existing test pattern (runTest function, makeNode helper, return errors array).

**Update makeNode helper:** Add `uofm`, `length` (raw length string) parameters with defaults. The makeNode rowData object already has `UofM` and `Length` fields — update them to use the new parameters instead of empty strings. Default `uofm` to `'ea'`, default `length` to `''`.

**Also update the `revision` default** in makeNode from `'A'` to `'1'` — the current default of `'A'` would fail Rule 5 (revision must be integer). This change makes existing tests produce valid metadata by default.

**Tests to add:**

**Rule 3 — Part Number Format (tests 16-18):**
- Test 16: Valid part numbers pass — test `1000123`, `1000123-01`, `1000123-01-1`, `200001`, `300001` all pass validation
- Test 17: Invalid part numbers blocked — test `ABC123`, `400001`, `10001`, `1000123-1` (1-digit suffix where 2 expected) all produce errors with rule `'invalid-part-number'`
- Test 18: Part number validation includes path in error message

**Rule 4 — Description Required (test 19):**
- Test 19: Empty/blank description blocked — test both `''` and `'   '` (whitespace only) produce errors with rule `'missing-description'`

**Rule 5 — Revision Must Be Integer (test 20):**
- Test 20: Non-integer revision blocked — test `'A'`, `'1.5'`, `''` produce errors with rule `'invalid-revision'`; test `'1'`, `'15'` pass

**Rule 6 — NS Item Type Whitelist (test 21):**
- Test 21: Invalid NS Item Type blocked — test `'Widget'` produces error with rule `'invalid-ns-item-type'`; `'Inventory'`, `'Lot Numbered Inventory'`, `'Assembly'` all pass

**Rule 7 — Component Type Whitelist (test 22):**
- Test 22: Invalid Component Type blocked — test `'Custom'` produces error with rule `'invalid-component-type'`; `'Purchased'`, `'Manufactured'`, `'Raw Stock'`, `'Assembly'` all pass

**Rule 8 — Unit of Measure Whitelist (test 23):**
- Test 23: Invalid UoM blocked — test `'ft'` produces error with rule `'invalid-uofm'`; `'ea'`, `'in'`, `'sq in'` all pass

**Rule 9 — Cross-Field Consistency (tests 24-27):**
- Test 24: Inventory with UoM='in' blocked (expected 'ea') — rule `'cross-field-inconsistency'`
- Test 25: Inventory with non-empty Length blocked — rule `'cross-field-inconsistency'`
- Test 26: Lot Numbered Inventory with UoM='ea' blocked (expected 'in' or 'sq in') — rule `'cross-field-inconsistency'`
- Test 27: Lot Numbered Inventory with valid fields passes — nsItemType='Lot Numbered Inventory', uofm='in', length='12.5in', componentType='Raw Stock'

**Integration tests (tests 28-30):**
- Test 28: Metadata errors collected alongside merge errors — build tree with WIP GA (Rule 0) AND invalid part number (Rule 3), verify both errors collected
- Test 29: All metadata rules checked on every node — build tree where child nodes have different metadata issues, verify errors collected for each
- Test 30: Valid metadata with valid merge passes — full valid tree passes with zero errors

**Register all tests** in the "RUN ALL TESTS" section at the bottom, following the existing pattern.

**Run the test suite:**
```bash
cd test && node run-tests.js
node validation-tests.js
```

Both must pass. The 4 automated BOM tests must still pass (metadata changes must not break existing functionality). The 15 existing validation tests must still pass (the makeNode default changes must be compatible).
  </action>
  <verify>
Run `cd C:/Users/amcallister/Projects/bom-tool/test && node validation-tests.js` — all 30 tests pass.
Run `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` — all 4 automated BOM tests pass.
  </verify>
  <done>All 30 validation tests pass (15 existing + 15 new for Rules 3-9). All 4 automated BOM tests pass. No regressions.</done>
</task>

</tasks>

<verification>
1. `cd test && node validation-tests.js` — 30/30 tests pass
2. `cd test && node run-tests.js` — 4/4 automated BOM tests pass
3. validate.js exports `validateMetadata` function
4. BOMNode has `rawLength` field
5. Metadata validation runs on every node inside walkAndValidate before Rules 0-2
6. All error messages match the format specified in docs/validation-logic.md
7. Rule IDs are traceable: `invalid-part-number`, `missing-description`, `invalid-revision`, `invalid-ns-item-type`, `invalid-component-type`, `invalid-uofm`, `cross-field-inconsistency`
</verification>

<success_criteria>
- Rules 3-9 implemented exactly as specified in docs/validation-logic.md
- All metadata rules are hard blocks (same enforcement as Rules 0-2)
- Metadata validation runs on every node before merge-level validation
- Metadata errors collected alongside merge errors (user sees all issues at once)
- 30/30 validation tests pass, 4/4 BOM tests pass
- No regressions to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/14.1-metadata-validation-rules-3-9/14.1-01-SUMMARY.md`
</output>
