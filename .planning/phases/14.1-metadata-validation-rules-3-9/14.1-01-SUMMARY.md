---
phase: 14.1-metadata-validation-rules-3-9
plan: 01
subsystem: validation
tags: [metadata, validation, data-quality]
completed: 2026-02-15

dependencies:
  requires:
    - "js/core/tree.js:BOMNode"
    - "js/core/validate.js:validateBOM"
  provides:
    - "js/core/validate.js:validateMetadata"
    - "js/core/tree.js:BOMNode.rawLength"
  affects:
    - "IFP Merge tab validation flow"
    - "All validation tests"

tech-stack:
  added: []
  patterns:
    - "Metadata validation before merge-level validation"
    - "Cross-field consistency checking"
    - "Whitelist-based field validation"

key-files:
  created: []
  modified:
    - "js/core/tree.js — added rawLength field to BOMNode"
    - "js/core/validate.js — added validateMetadata function, integrated into walkAndValidate"
    - "test/validation-tests.js — added 15 new tests for Rules 3-9, updated makeNode helper"

decisions:
  - "Metadata validation runs on EVERY node before merge-level validation (Rules 0-2)"
  - "rawLength field preserves raw string for cross-field validation (Rule 9)"
  - "All metadata rules are hard blocks (same enforcement as Rules 0-2)"
  - "Cross-field consistency only checked if NS Item Type is valid (prevents cascade errors)"
  - "Recursion updated to validate ALL children, not just Released assemblies"

metrics:
  duration: 254s (4.2 min)
  tasks: 2
  tests: 30 validation tests (15 new + 15 updated), 4 BOM tests
  files: 2 modified
---

# Phase 14.1 Plan 01: Metadata Validation Rules 3-9 Summary

Implemented metadata validation Rules 3-9 as hard blocks before merge execution, with full test coverage and integration into existing validation flow.

## One-liner

Metadata validation (Rules 3-9) for part number format, required fields, whitelisted values, and cross-field consistency — all errors collected with merge errors.

## What Was Done

### Task 1: Add rawLength field and implement validateMetadata

**Changes to js/core/tree.js:**
- Added `this.rawLength = rowData.Length || '';` to BOMNode constructor
- Preserves raw Length string for Rule 9 cross-field validation (before parseLength processing)

**Changes to js/core/validate.js:**
- Created `validateMetadata(node, ancestorPath)` function checking Rules 3-9
- Returns array of error objects with message, path, and rule ID
- Integrated into `walkAndValidate` after missing-NS-Item-Type check
- All metadata errors pushed to errors array before merge-level validation

**Rule implementations:**
- **Rule 3 (Part Number Format):** Regex `/^(1\d{6}(-\d{2}(-\d)?)?|[23]\d{5})$/` validates 1xxxxxx, 2xxxxx, 3xxxxx patterns
- **Rule 4 (Description Required):** Checks for empty or whitespace-only descriptions
- **Rule 5 (Revision Integer):** Validates revision is whole number using `/^\d+$/`
- **Rule 6 (NS Item Type Whitelist):** Validates against ['Inventory', 'Lot Numbered Inventory', 'Assembly']
- **Rule 7 (Component Type Whitelist):** Validates against ['Purchased', 'Manufactured', 'Raw Stock', 'Assembly']
- **Rule 8 (UoM Whitelist):** Validates against ['ea', 'in', 'sq in']
- **Rule 9 (Cross-Field Consistency):** Validates field combinations based on NS Item Type:
  - Inventory: UoM='ea', Length empty, Component Type=Purchased/Manufactured
  - Assembly: UoM='ea', Length empty, Component Type=Assembly/Manufactured
  - Lot Numbered Inventory: UoM='in' or 'sq in', Length=decimal with optional 'in' suffix, Component Type=Raw Stock

**Commit:** cd46f95 — feat(14.1-01): implement metadata validation Rules 3-9

### Task 2: Write tests and validate

**Changes to test/validation-tests.js:**
- Updated `makeNode` helper: added `uofm='ea'`, `length=''`, `revision='1'`, `description='Test Description'` defaults
- Added 15 new tests (tests 16-30) covering Rules 3-9:
  - Tests 16-18: Rule 3 part number format (valid, invalid, error path)
  - Test 19: Rule 4 empty description blocked
  - Test 20: Rule 5 non-integer revision blocked
  - Test 21: Rule 6 invalid NS Item Type blocked
  - Test 22: Rule 7 invalid Component Type blocked
  - Test 23: Rule 8 invalid UoM blocked
  - Tests 24-27: Rule 9 cross-field consistency (Inventory UoM, Inventory Length, Lot Numbered Inventory UoM, valid Lot Numbered Inventory)
  - Tests 28-30: Integration tests (metadata + merge errors, every node validated, valid tree passes)
- Updated existing tests to use valid part numbers (1000xxx format instead of 'GA', 'A1', etc.)
- Updated existing tests to use valid component types ('Purchased' instead of 'Part')
- Fixed recursion issue: updated `walkAndValidate` to recurse into ALL children (not just Released assemblies)

**Test results:**
- 30/30 validation tests pass (15 existing + 15 new)
- 4/4 automated BOM tests pass (no regressions)

**Commit:** 53c90a6 — test(14.1-01): add tests for metadata validation Rules 3-9

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Bug] Recursion only validated Released assemblies**
- **Found during:** Task 2 (test execution)
- **Issue:** Original `walkAndValidate` only recursed into Released assemblies and their children. Non-assembly children of Released assemblies were checked for Rule 1 but never had `validateMetadata` called on them, so their metadata was never validated.
- **Fix:** Changed recursion logic from `if (child.nsItemType && isAssembly(child) && isReleased(child.state))` to `if (child.nsItemType)` — now ALL children get metadata validation
- **Files modified:** js/core/validate.js
- **Commit:** 53c90a6 (test commit includes the fix)

**2. [Rule 3 - Bug] Existing tests used invalid metadata**
- **Found during:** Task 2 (test execution)
- **Issue:** Existing tests (tests 6-12) used part numbers like 'GA', 'A1', 'C1' which don't match the new part number format validation. Also used `componentType: 'Part'` which isn't in the whitelist.
- **Fix:** Updated all test part numbers to valid 1000xxx format. Changed `componentType: 'Part'` to `componentType: 'Purchased'`. Updated error message checks to match new part numbers.
- **Files modified:** test/validation-tests.js
- **Commit:** 53c90a6 (part of test commit)

## Verification

All verification criteria met:

1. `cd test && node validation-tests.js` — 30/30 tests pass
2. `cd test && node run-tests.js` — 4/4 automated BOM tests pass
3. validate.js exports `validateMetadata` function ✓
4. BOMNode has `rawLength` field ✓
5. Metadata validation runs on every node inside walkAndValidate before Rules 0-2 ✓
6. All error messages match format specified in docs/validation-logic.md ✓
7. Rule IDs traceable: `invalid-part-number`, `missing-description`, `invalid-revision`, `invalid-ns-item-type`, `invalid-component-type`, `invalid-uofm`, `cross-field-inconsistency` ✓

## Self-Check: PASSED

**Files created:** None (only modifications)

**Files modified:**
- js/core/tree.js ✓ (exists)
- js/core/validate.js ✓ (exists)
- test/validation-tests.js ✓ (exists)

**Commits:**
- cd46f95 ✓ (feat: implement metadata validation Rules 3-9)
- 53c90a6 ✓ (test: add tests for metadata validation Rules 3-9)

**Test results:**
- 30/30 validation tests pass ✓
- 4/4 BOM tests pass ✓

All claims verified.

## Impact

**User-facing:**
- IFP Merge tab now blocks merge when metadata is invalid (part number format, empty descriptions, invalid whitelisted values, cross-field inconsistencies)
- Error messages are descriptive and cite specific rule violations
- All errors collected and shown at once (user fixes all issues in one PDM session)

**Internal:**
- `validateMetadata` function is exported and can be used standalone if needed
- `rawLength` field on BOMNode preserves raw string for future validation needs
- All 7 metadata rules follow same pattern (easy to add more rules in future)
- Recursion now validates ALL nodes, not just Released assemblies

**Testing:**
- Test coverage increased from 15 to 30 validation tests
- All existing tests updated to use valid metadata (ensures future metadata validation doesn't break existing tests)
- makeNode helper now provides sensible defaults that pass validation

## Next Steps

Phase 14.1 complete. Ready to proceed to Phase 14.2 (Test Suite Issue Fixes) or Phase 15 (Cross-Tab Integration) as prioritized in ROADMAP.md.
