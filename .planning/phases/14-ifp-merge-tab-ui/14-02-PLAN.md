---
phase: 14-ifp-merge-tab-ui
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - js/ui/ifp-merge.js
  - css/styles.css
autonomous: false

must_haves:
  truths:
    - "Clicking Merge BOM executes the merge and updates the tree in place"
    - "After merge, grafted content highlighted in soft yellow"
    - "Merge summary stat cards show counts: passed through, grafted, placeholders"
    - "Hide B(n-1) substitutions toggle hides grafted rows"
    - "Export B(n) downloads JSON artifact with correct filename"
    - "IFP revision number input controls the exported revision"
    - "Merge warnings display to user"
  artifacts:
    - path: "js/ui/ifp-merge.js"
      provides: "Merge execution, result display, grafted highlighting, export logic"
      contains: "mergeBOM"
    - path: "css/styles.css"
      provides: "Merge summary stat card colors, warning display styles"
      contains: "ifp-summary"
  key_links:
    - from: "js/ui/ifp-merge.js"
      to: "js/core/merge.js"
      via: "mergeBOM for merge execution"
      pattern: "import.*mergeBOM.*merge"
    - from: "js/ui/ifp-merge.js"
      to: "js/core/artifact.js"
      via: "exportArtifact and generateFilename for B(n) export"
      pattern: "import.*exportArtifact.*artifact"
    - from: "js/ui/ifp-merge.js"
      to: "DOM tree rows"
      via: "ifp-row-grafted class on grafted rows"
      pattern: "ifp-row-grafted"
---

<objective>
Wire up merge execution, result display, and artifact export to complete the IFP Merge tab.

Purpose: Deliver the complete merge-and-export workflow — Engineering clicks Merge, sees the tree transform with grafted highlights and summary stats, reviews warnings, then exports B(n) as a JSON artifact.

Output: Fully functional IFP Merge tab covering all UI requirements (UI-01 through UI-11).
</objective>

<execution_context>
@C:/Users/amcallister/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/amcallister/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/Users/amcallister/Projects/bom-tool/.planning/PROJECT.md
@C:/Users/amcallister/Projects/bom-tool/.planning/ROADMAP.md
@C:/Users/amcallister/Projects/bom-tool/.planning/STATE.md
@C:/Users/amcallister/Projects/bom-tool/.planning/phases/14-ifp-merge-tab-ui/14-CONTEXT.md
@C:/Users/amcallister/Projects/bom-tool/.planning/phases/14-ifp-merge-tab-ui/14-01-SUMMARY.md
@C:/Users/amcallister/Projects/bom-tool/.planning/phases/11-core-merge-engine/11-02-SUMMARY.md
@C:/Users/amcallister/Projects/bom-tool/.planning/phases/12-json-artifact-format/12-01-SUMMARY.md

@C:/Users/amcallister/Projects/bom-tool/js/ui/ifp-merge.js
@C:/Users/amcallister/Projects/bom-tool/js/core/merge.js
@C:/Users/amcallister/Projects/bom-tool/js/core/artifact.js
@C:/Users/amcallister/Projects/bom-tool/css/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge execution, summary display, grafted highlighting, and view toggles</name>
  <files>js/ui/ifp-merge.js, css/styles.css</files>
  <action>
Update `js/ui/ifp-merge.js` to add merge execution and post-merge display.

**Add import** (if not already present from plan 01):
```javascript
import { mergeBOM } from '../core/merge.js';
import { exportArtifact, generateFilename } from '../core/artifact.js';
```

**Replace the placeholder merge button handler** with real merge logic:

```
ifpMergeBtn click handler:
1. Get priorRoot:
   - If REV0 mode: priorRoot = null
   - If REV1+: priorRoot = state.ifpPriorArtifact.bom
2. Call mergeBOM(state.ifpSourceTree, priorRoot)
   - Returns { mergedTree, warnings, summary }
3. Store results:
   - state.ifpMergedTree = mergedTree
   - state.ifpMergeSummary = summary
   - state.ifpMergeWarnings = warnings
4. Re-render tree with merged data:
   - Call displayIfpTree(state.ifpMergedTree) — the same tree renderer from plan 01
   - After rendering, apply grafted row highlighting (see below)
5. Display merge summary stat cards
6. Display warnings (if any)
7. Enable export button
8. Show success message
```

**Grafted row highlighting:**
After tree rendering, walk the DOM rows in `#ifpTreeBody`. Each row's corresponding node data should be accessible. During `displayIfpTree` rendering (from plan 01), store a reference to each node on its row element: `row._bomNode = node` or use a data attribute `data-source="grafted"` or `data-source="current"`. Then after rendering:
- For each row with `data-source="grafted"`: add class `ifp-row-grafted` (yellow background, already defined in plan 01 CSS).
- The CSS `.ifp-row-grafted` provides soft yellow background (#fef9c3) with hover state (#fef08a).

**Merge summary stat cards:**
Show `ifpSummaryStats` container. Update the three stat card values:
- `ifpPassedCount.textContent = summary.passedThrough`
- `ifpGraftedCount.textContent = summary.grafted`
- `ifpPlaceholderCount.textContent = summary.placeholders`

Add CSS for stat card left-border colors (append to styles.css):
```css
.ifp-stat-passed {
    border-left: 4px solid #10b981;
}
.ifp-stat-passed .stat-value {
    color: #10b981;
}
.ifp-stat-grafted {
    border-left: 4px solid #f59e0b;
}
.ifp-stat-grafted .stat-value {
    color: #f59e0b;
}
.ifp-stat-placeholders {
    border-left: 4px solid #f97316;
}
.ifp-stat-placeholders .stat-value {
    color: #f97316;
}
```

Apply these classes to the stat cards dynamically in JS when showing stats: `document.getElementById('ifpPassedCount').closest('.stat-card').classList.add('ifp-stat-passed')` etc. Or if plan 01 already included the classes in HTML, they will already be present.

**Merge warnings display:**
If `warnings.length > 0`, show them below the summary stats. Create a warnings container or reuse the message area:
- Show a bordered info box (not error — warnings are informational per design decision).
- Style: amber/yellow border, light yellow background.
- List each warning.

Add CSS:
```css
.ifp-warnings {
    background: #fffbeb;
    border: 1px solid #f59e0b;
    border-left: 4px solid #f59e0b;
    border-radius: 6px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    color: #92400e;
    line-height: 1.6;
}
.ifp-warnings .warning-title {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 0.8125rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
}
.ifp-warnings .warning-item {
    padding: 0.25rem 0;
    padding-left: 1rem;
    border-left: 2px solid #fcd34d;
    margin-bottom: 0.25rem;
}
```

Add a warnings div in the ifpResults section (or create it dynamically). Use `id="ifpWarnings"`.

**Hide B(n-1) Substitutions toggle:**
Wire up `ifpHideGraftedToggle` (created in plan 01 as non-functional):
- Toggle active class on click.
- When active: for each row with `data-source="grafted"`, add class `grafted-hidden`.
- When inactive: remove `grafted-hidden` from all rows.
- CSS: `.grafted-hidden { display: none; }` — add to styles.css.
- Note: this hides the entire grafted row, not just the highlight. Per user decision: "toggle hides/shows B(n-1) substitutions" (UI-09).

**Source indicator column:**
During tree rendering, the Source column was created in plan 01 but may have been empty for pre-merge display. After merge, the `_source` property exists on every node. Update `displayIfpTree` to populate the Source column:
- If `node._source === 'grafted'`: show text "B(n-1)" in a subtle style.
- If `node._source === 'current'`: leave blank (current is the default expectation, cleaner display).
- Use row background color (soft yellow) as the primary grafted indicator. The Source column provides additional text clarity.
  </action>
  <verify>
Run `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` — all 4 baseline tests + all merge/artifact/validation tests pass.
Verify ifp-merge.js contains "mergeBOM" import and call.
Verify CSS has ifp-stat-passed, ifp-stat-grafted, ifp-stat-placeholders classes.
  </verify>
  <done>
Merge button executes the merge algorithm. Tree transforms in place with grafted rows highlighted in soft yellow. Summary stat cards show passed through / grafted / placeholder counts. Warnings display in amber info box. Hide B(n-1) toggle hides grafted rows. Source column shows "B(n-1)" for grafted nodes. Export button enabled after merge.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export B(n) artifact with revision input and filename generation</name>
  <files>js/ui/ifp-merge.js</files>
  <action>
Wire up the Export B(n) button in `js/ui/ifp-merge.js`.

**Export button click handler:**

```
ifpExportBtn click handler (async):
1. Read user inputs:
   - revision = parseInt(ifpRevisionInput.value) || 0
   - jobNumber = ifpJobNumber.value.trim()
   - If jobNumber is empty, show error message "Job number is required" and return.
2. Build source files metadata:
   - sourceFiles = { xn: state.ifpSourceFilename, bn1: state.ifpPriorFilename || null }
3. Call exportArtifact (async):
   const artifact = await exportArtifact({
       mergedTree: state.ifpMergedTree,
       summary: state.ifpMergeSummary,
       revision: revision,
       jobNumber: jobNumber,
       sourceFiles: sourceFiles
   });
4. Generate filename:
   const filename = generateFilename(jobNumber, revision);
5. Convert to JSON string:
   const jsonString = JSON.stringify(artifact, null, 2);
6. Trigger download using Save As behavior:
   - Create a Blob from jsonString with type 'application/json'
   - Create an <a> element, set href to URL.createObjectURL(blob)
   - Set download attribute to filename
   - Per user decision: "Export B(n) uses Save As behavior (user chooses save location)"
   - NOTE: In browsers, setting the `download` attribute on an <a> tag and clicking it triggers the browser's save dialog (which may be a direct download or Save As depending on browser settings). This is the standard web approach. There is no pure-JS way to force the native Save As dialog — the browser controls this. The `download` attribute with a filename is the closest web equivalent.
   - Click the link, then revoke the object URL.
7. Show success message: "Exported: {filename}"
```

**Revision and Job Number auto-population:**
This was partially handled in plan 01 (during B(n-1) upload). Ensure these additional cases:
- When REV0 mode is toggled ON: set revision to 0, set job number to "1J" + root PN (if source tree loaded).
- When REV0 is toggled OFF and prior artifact exists: set revision to `suggestRevision(state.ifpPriorArtifact)`, set job number to `suggestJobNumber(state.ifpPriorArtifact, state.ifpSourceTree.partNumber)`.
- These should be in the REV0 toggle handler and the `updateMergeReadiness` function.

**Export button state:**
- Disabled by default.
- Enabled only after successful merge (`state.ifpMergedTree !== null`).
- Disabled again on reset.

**Edge cases:**
- If user changes revision/job number input after merge but before export, use the current input values (not the auto-suggested ones). The inputs are user-overridable per ARTF-06.
- If merged tree is null when export is clicked (shouldn't happen since button is disabled), show error and return.
  </action>
  <verify>
Run `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` — all tests pass.
Verify ifp-merge.js contains "exportArtifact" and "generateFilename" calls.
Verify the export handler creates a Blob and triggers download.
Grep for "application/json" in ifp-merge.js to confirm blob creation.
  </verify>
  <done>
Export B(n) button downloads JSON artifact with auto-generated filename following company pattern. Revision and job number inputs are pre-populated from B(n-1) (or REV0 defaults) and user-overridable. Download triggers browser save dialog. All tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of complete IFP Merge tab</name>
  <files>none</files>
  <action>
Human verifies the complete IFP Merge tab functionality after pushing to GitHub Pages.

Complete IFP Merge tab (4th tab) has been built with:
1. Side-by-side upload zones for X(n) XML and B(n-1) JSON
2. REV0 toggle that disables B(n-1) zone
3. State-aware hierarchy tree with green/red pills on every node
4. Validation error banner blocking merge when BOM has issues
5. Merge button executing the merge algorithm
6. Merged tree with grafted content highlighted in soft yellow
7. Summary stat cards (passed through, grafted, placeholders)
8. Hide WIP Content and Hide B(n-1) Substitutions toggles
9. Export B(n) button downloading JSON artifact
  </action>
  <verify>
After pushing to v2.2-ifp-merge branch and deploying to GitHub Pages:

1. Navigate to the BOM Tool and click the "IFP Merge" tab
2. Verify 4 tabs are visible: Flat BOM, BOM Comparison, Hierarchy View, IFP Merge

**REV0 flow:**
3. Check "First IFP (REV0)" — B(n-1) zone should grey out
4. Upload an XML source export — tree should appear with state pills
5. If all assemblies are Released: merge button should be enabled
6. Click Merge — summary should show all "Passed Through", zero grafted/placeholders
7. Click Export B(n) — JSON file should download

**Standard merge flow:**
8. Uncheck REV0
9. Upload X(n) XML (one with WIP assemblies)
10. Upload a B(n-1) JSON artifact
11. Verify revision auto-suggests, job number auto-fills
12. Verify grafted content shows yellow highlighting
13. Verify summary stat cards show correct counts
14. Toggle "Hide WIP Content" — WIP assembly children should disappear
15. Toggle "Hide B(n-1) Substitutions" — grafted rows should disappear
16. Click Export B(n) — verify filename follows pattern

**Validation testing:**
17. Upload an X(n) with a WIP GA root — should see red error banner, merge blocked
18. Upload an X(n) with WIP parts under Released assemblies — should see errors listing each violation

**Existing functionality:**
19. Switch to other tabs (Flat BOM, Comparison, Hierarchy) — all should still work normally
  </verify>
  <done>User confirms all IFP Merge tab functionality works correctly in browser. All existing tab functionality unaffected.</done>
</task>

</tasks>

<verification>
1. All 4 baseline tests pass: `cd test && node run-tests.js`
2. All merge tests pass (19 tests)
3. All artifact tests pass (26 tests)
4. All validation tests pass (15 tests)
5. IFP Merge tab fully functional with all UI requirements met
6. Existing tabs unaffected
</verification>

<success_criteria>
- Merge button executes mergeBOM and updates tree in place (UI-08, UI-10)
- Grafted content highlighted in soft yellow (UI-08)
- Hide B(n-1) substitutions toggle works (UI-09)
- Merge summary shows correct counts (UI-10)
- Export B(n) downloads JSON artifact with proper filename (UI-11, ARTF-05)
- IFP revision input near Export button, user-overridable (ARTF-06)
- Source indicator visible on nodes (VALID-03)
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/14-ifp-merge-tab-ui/14-02-SUMMARY.md`
</output>
