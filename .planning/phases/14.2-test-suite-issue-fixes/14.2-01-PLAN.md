---
phase: 14.2-test-suite-issue-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/core/merge.js
  - js/core/validate.js
  - js/core/artifact.js
  - js/ui/ifp-merge.js
autonomous: true

must_haves:
  truths:
    - "Source column shows resolved labels X(2), B(1), or New (WIP) — never abstract B(n-1) or blank"
    - "Warnings include assembly description in parentheses for assemblies no longer visible in merged tree"
    - "Warnings and source labels resolve B(n-1) and X(n) to actual revision numbers everywhere"
    - "Validation errors include raw PDM state in square brackets like [Checked Out]"
    - "Job number defaults to just 1J when GA PN starts with 1, full 1J{PN} otherwise"
    - "Export button disabled until job number matches 1Jxxxxxx pattern"
    - "IFP revision auto-increments to B(n-1)+1 when prior artifact loaded"
    - "258758 XML no longer produces false positive Missing NS Item Type errors for nodes with empty Part Number"
  artifacts:
    - path: "js/core/merge.js"
      provides: "Resolved source labels and description in warnings"
      contains: "node.description"
    - path: "js/core/validate.js"
      provides: "Raw PDM state in error messages, skip empty-PN nodes"
      contains: "\\[.*\\]"
    - path: "js/core/artifact.js"
      provides: "Conditional job number logic based on GA PN first digit"
      contains: "startsWith"
    - path: "js/ui/ifp-merge.js"
      provides: "Resolved source labels in tree, job number validation, revision auto-increment fix"
      contains: "1Jxxxxxx"
  key_links:
    - from: "js/core/merge.js"
      to: "js/ui/ifp-merge.js"
      via: "mergeBOM returns resolved source labels and description in warnings"
      pattern: "_source.*X\\(|B\\("
    - from: "js/core/artifact.js"
      to: "js/ui/ifp-merge.js"
      via: "suggestJobNumber returns conditional value"
      pattern: "suggestJobNumber"
---

<objective>
Fix core logic bugs discovered during test suite 1: resolve abstract B(n-1)/X(n) labels to actual revision numbers in source column, warnings, and merge summary; add descriptions to warning messages; include raw PDM state in validation errors; implement conditional job number prepopulation; fix IFP revision auto-increment; investigate and fix 258758 XML false positive errors.

Purpose: All user-facing text must show resolved, specific references (B(1) not B(n-1)) for traceability. Job number and revision fields must behave correctly.
Output: Updated merge.js, validate.js, artifact.js, ifp-merge.js with all core logic fixes.
</objective>

<execution_context>
@C:/Users/amcallister/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/amcallister/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14.2-test-suite-issue-fixes/14.2-CONTEXT.md
@js/core/merge.js
@js/core/validate.js
@js/core/artifact.js
@js/ui/ifp-merge.js
@test-data/test-suite-1-20260215.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Resolve source labels, add descriptions to warnings, include PDM state in errors</name>
  <files>js/core/merge.js, js/core/validate.js, js/ui/ifp-merge.js</files>
  <action>
**merge.js — mergeBOM function signature and source tags:**
- Change `mergeBOM(sourceRoot, priorRoot)` to `mergeBOM(sourceRoot, priorRoot, options = {})` where options accepts `{ sourceRevision, priorRevision }` — these are the actual revision numbers (e.g., 2 and 1) passed from the UI.
- For grafted nodes (line ~220): instead of `tagSource(grafted, 'grafted')`, tag with resolved label: `tagSource(grafted, 'B(' + options.priorRevision + ')')` so every grafted node's `_source` is like "B(1)".
- For current/passed-through nodes (line ~241-258): tag `_source` as `'X(' + options.sourceRevision + ')'` instead of `'current'`.
- For placeholder nodes (line ~228): tag `_source` as `'New (WIP)'` instead of `'grafted'`.
- Update `tagSource` to accept the resolved label string (no changes needed — it already takes a string).

**merge.js — warning messages with description and resolved references:**
- Placeholder warning (line ~231): Change to `${sourceNode.partNumber} (${sourceNode.description}) [${sourceNode.state}] has no prior released BOM — included as empty placeholder`
- Missing assembly warning (line ~275-276): Change to `${priorPN} (${priorNode.description}) was in B(${options.priorRevision}) but not found in X(${options.sourceRevision}) — may be deleted or suppressed`. To get description, change `collectAllAssemblyPNs` to return a `Map<string, {description: string}>` instead of a `Set<string>`, so we can include description in the warning.

**validate.js — include raw PDM state in error messages:**
- Rule 0 (wip-ga, line ~211): Already includes state — keep as is.
- Rule 1 (wip-non-assembly, line ~269): Change message to include PDM state: `At ${childPath} > ${child.partNumber}: WIP non-assembly item [${child.state}] under released assembly — Release ${child.partNumber} in PDM before creating IFP artifact`
- Missing NS Item Type errors (lines ~224-226 and ~249-254): Add a guard — if node.partNumber is empty or blank, skip validation entirely for that node (do NOT generate "Missing NS Item Type" error). This fixes the 258758 XML false positive where parent XML nodes have empty Part Number, Revision, Description fields but still have child rows. Add a check at the top of `walkAndValidate`: `if (!node.partNumber || node.partNumber.trim() === '') return;` — skip empty-PN nodes entirely, but still recurse into their children.

**ifp-merge.js — pass revision numbers to mergeBOM:**
- In the merge button click handler (line ~624): Extract the source revision from the XML filename or from the source tree's revision field. Extract the prior revision from `state.ifpPriorArtifact.metadata.revision` (or 0 for REV0). Pass these as options: `mergeBOM(state.ifpSourceTree, priorRoot, { sourceRevision: sourceRev, priorRevision: priorRev })`.
- For REV0 mode (no prior): pass `priorRevision: null` — merge.js should handle null by using "N/A" or similar.
- In `renderTreeNode` source cell (line ~400-411): Instead of checking `node._source === 'grafted'`, display `node._source` directly since it now contains the resolved label ("X(2)", "B(1)", or "New (WIP)"). Style "B(n)" labels in grey, "New (WIP)" in orange, and "X(n)" can be subtle or omitted per discretion. ALL rows should show their source label (no blank source column).

**ifp-merge.js — update toggle button selectors:**
- Hide WIP toggle (line ~568): Update selector from `data-wip-assembly="true"` — this is correct but verify.
- Hide Grafted toggle (line ~600): Update selector from `data-source="grafted"` to match the new resolved label pattern. Since `_source` is now "B(1)" etc, check `row.dataset.source` — update `renderTreeNode` to set `row.dataset.source = 'grafted'` when `node._source` starts with 'B(' and `row.dataset.source = 'placeholder'` when `node._source === 'New (WIP)'` and `row.dataset.source = 'current'` when `node._source` starts with 'X('. The hide-grafted toggle should hide rows where `dataset.source === 'grafted'`.
  </action>
  <verify>
- Load test file 258758-Rev3-20260205.XML — should NOT produce "Missing NS Item Type" false positives for empty-PN parent nodes
- After merge with prior artifact: source column shows "X(2)", "B(1)", "New (WIP)" — never blank, never "B(n-1)"
- Validation error for WIP component includes raw state in brackets: "[Checked Out]"
- Warning for missing assembly includes description in parentheses
  </verify>
  <done>
All source labels resolve to actual revision numbers. Warnings include descriptions. Validation errors include PDM state. 258758 XML false positives eliminated by skipping empty-PN nodes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix job number conditional logic and IFP revision auto-increment</name>
  <files>js/core/artifact.js, js/ui/ifp-merge.js</files>
  <action>
**artifact.js — suggestJobNumber conditional logic:**
- Change `suggestJobNumber(priorArtifact, rootPartNumber)` to implement the locked decision:
  - If GA PN starts with '1': return just "1J" (user must type 6 more digits)
  - If GA PN does NOT start with '1': return "1J" + rootPartNumber (full prepopulation)
  - REV1+ (priorArtifact exists): return prior artifact's job number (unchanged)

**ifp-merge.js — job number validation for export:**
- Add job number validation: the pattern must be `1J` followed by exactly 6 digits: `/^1J\d{6}$/`
- Disable the export button if job number does not match this pattern
- Add an `input` event listener on `ifpJobNumber` field that calls `updateExportReadiness()` (new function or extend existing)
- The export button should be disabled until: (a) merged tree exists AND (b) job number matches `1J\d{6}`
- Show a subtle validation indicator on the job number field (red border if invalid, green if valid)

**ifp-merge.js — REV0 toggle job number:**
- In the REV0 toggle handler (line ~82) and handleSourceFile (line ~159): apply the same conditional logic — if `state.ifpSourceTree.partNumber` starts with '1', set `ifpJobNumber.value = '1J'`, otherwise set `ifpJobNumber.value = '1J' + state.ifpSourceTree.partNumber`.

**ifp-merge.js — IFP revision auto-increment fix:**
- In `handlePriorFile` (line ~235-237): The code already calls `suggestRevision(state.ifpPriorArtifact)` which returns `priorArtifact.metadata.revision + 1`. Verify this is working — the bug report says "IFP revision thought it was still REV0 even though I had uploaded a json at IFP REV0". The issue may be that `handlePriorFile` only sets revision when `state.ifpSourceTree` exists (line 235 check). If user uploads JSON before XML, the revision won't update. Fix: always set revision when prior artifact loads, regardless of whether source XML is loaded yet. Move `ifpRevisionInput.value = suggestRevision(state.ifpPriorArtifact)` outside the `if (state.ifpSourceTree)` block.
  </action>
  <verify>
- Upload XML for GA 1035704 (starts with '1') — job number defaults to "1J" only, not "1J1035704"
- Upload XML for GA 258730 (starts with '2') — job number defaults to "1J258730"
- Export button stays disabled when job number is "1J" (too short)
- Export button enables when job number is "1J250000" (valid pattern)
- Upload JSON B(0) artifact — IFP revision auto-increments to 1 (not stuck at 0)
- Upload JSON before XML — revision still auto-increments correctly
  </verify>
  <done>
Job number conditionally prepopulates based on GA PN first digit. Export disabled until valid 1Jxxxxxx pattern. IFP revision correctly auto-increments from prior artifact revision.
  </done>
</task>

</tasks>

<verification>
- Run `cd test && node run-tests.js` — all 4 automated tests must still pass (these test flattening/comparison, not IFP merge, but must not regress)
- Load 258758-Rev3-20260205.XML — no false positive "Missing NS Item Type" errors for empty-PN parent nodes
- Complete a full merge cycle with test suite files: verify source column shows resolved labels, warnings have descriptions, job number logic is conditional
</verification>

<success_criteria>
1. Source column in merged tree shows X(n), B(n), or New (WIP) with resolved revision numbers — never blank or abstract
2. Warning messages include assembly description in parentheses
3. Validation errors include raw PDM state in square brackets
4. Job number defaults to "1J" when GA starts with 1, "1J{PN}" otherwise
5. Export disabled until job number matches 1J + 6 digits
6. IFP revision auto-increments from prior artifact even if XML not yet loaded
7. 258758 XML loads without false positive errors for empty-PN parent nodes
8. All 4 automated tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14.2-test-suite-issue-fixes/14.2-01-SUMMARY.md`
</output>
