---
phase: 14.2-test-suite-issue-fixes
plan: 02
type: execute
wave: 2
depends_on: ["14.2-01"]
files_modified:
  - index.html
  - css/styles.css
  - js/ui/ifp-merge.js
autonomous: false

must_haves:
  truths:
    - "Prior IFP B(n-1) upload panel is on the LEFT, Source Export X(n) is on the RIGHT"
    - "When B(n-1) JSON is uploaded, its tree renders immediately in a preview beneath the upload zone with state pills"
    - "When X(n) XML is uploaded, its tree renders in a preview beneath its upload zone with state pills"
    - "Hide WIP Content toggle hides children of WIP assemblies (WIP assembly row stays visible)"
    - "Hide B(n-1) Substitutions toggle hides all grafted rows in merged tree"
  artifacts:
    - path: "index.html"
      provides: "Swapped upload panel order, tree preview containers for both panels"
      contains: "ifpPriorContainer"
    - path: "css/styles.css"
      provides: "Styles for upload tree previews, consistent state pill styling"
      contains: "ifp-upload-preview"
    - path: "js/ui/ifp-merge.js"
      provides: "JSON tree preview rendering, working toggle buttons"
      contains: "renderUploadPreview"
  key_links:
    - from: "js/ui/ifp-merge.js"
      to: "index.html"
      via: "renderUploadPreview targets preview containers in each upload panel"
      pattern: "ifpSourcePreview|ifpPriorPreview"
    - from: "js/ui/ifp-merge.js"
      to: "css/styles.css"
      via: "Toggle buttons add/remove wip-hidden and grafted-hidden classes"
      pattern: "wip-hidden|grafted-hidden"
---

<objective>
Fix UI/layout bugs: swap upload panel sides (Prior LEFT, Source RIGHT), add side-by-side tree previews with state pills when files are uploaded, and fix broken toggle buttons for Hide WIP Content and Hide B(n-1) Substitutions.

Purpose: Upload panel layout should read left-to-right (old to new). Users need to see BOM trees immediately on upload (especially JSON) to verify before merging. Toggle buttons must work for filtering the merged tree view.
Output: Updated index.html layout, CSS styles, and ifp-merge.js with working previews and toggles.
</objective>

<execution_context>
@C:/Users/amcallister/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/amcallister/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14.2-test-suite-issue-fixes/14.2-CONTEXT.md
@.planning/phases/14.2-test-suite-issue-fixes/14.2-01-SUMMARY.md
@index.html
@css/styles.css
@js/ui/ifp-merge.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Swap upload panels and add tree preview containers</name>
  <files>index.html, css/styles.css</files>
  <action>
**index.html — swap upload panel order:**
- In the upload grid (line ~406), move the `ifpPriorContainer` div to be the FIRST child (LEFT side) and the Source Export div to be the SECOND child (RIGHT side).
- Update the labels: Prior panel label should say "Prior IFP B(n-1)" and Source panel label should say "Source Export X(n)" (already correct, just verify after swap).
- Add a tree preview container beneath EACH upload zone (inside each panel div, after the file-info div):
  ```html
  <div class="ifp-upload-preview" id="ifpPriorPreview"></div>
  ```
  and
  ```html
  <div class="ifp-upload-preview" id="ifpSourcePreview"></div>
  ```

**css/styles.css — upload preview styles:**
- Add `.ifp-upload-preview` class:
  - `max-height: 300px; overflow-y: auto; margin-top: 0.75rem; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.8125rem;`
  - Hidden by default: `display: none;`
  - `.ifp-upload-preview.show { display: block; }`
- Add `.ifp-upload-preview table` styles: compact table matching the main tree table but smaller
- Add `.ifp-upload-preview .state-pill` — reuse existing state-pill styles (they should already work)
- Ensure `.ifp-upload-preview .tree-cell` has appropriate smaller padding
  </action>
  <verify>
- Open index.html — Prior IFP panel is on the LEFT, Source Export panel is on the RIGHT
- Both panels have empty hidden preview containers beneath their file info areas
  </verify>
  <done>Upload panels swapped to Prior LEFT / Source RIGHT layout. Preview containers added to both panels.</done>
</task>

<task type="auto">
  <name>Task 2: JSON tree preview on upload and fix toggle buttons</name>
  <files>js/ui/ifp-merge.js</files>
  <action>
**JSON tree preview — render B(n-1) tree on upload:**
- Add a new function `renderUploadPreview(rootNode, containerId)` that renders a compact read-only tree into the specified container. This is a simplified version of `renderTreeNode` — it should:
  - Create a `<table>` with columns: Part Number, Qty, Description, State (pill)
  - Render the tree hierarchically with indentation (simpler than the full tree — just padding-left based on depth)
  - Include state pills (Released = green, WIP = red) using the same `isReleased()` check
  - First level expanded, deeper levels collapsed (same default as main tree)
  - Show the container with `.show` class after rendering
- In `handlePriorFile` (after successful load ~line 244): call `renderUploadPreview(state.ifpPriorArtifact.bom, 'ifpPriorPreview')` to immediately show the JSON tree
- In `handleSourceFile` (after successful load ~line 145): call `renderUploadPreview(state.ifpSourceTree, 'ifpSourcePreview')` to show the XML tree preview

**Fix toggle buttons — investigate and fix:**
The toggle buttons at lines 561-609 look structurally correct. The likely issue is that:
1. The `wip-hidden` and `grafted-hidden` CSS classes may not have `!important` to override other display states
2. The toggles query `#ifpTreeBody` which is correct
3. After Plan 01, `data-source` values changed — the hide-grafted toggle needs to check `dataset.source === 'grafted'` which Plan 01 should set correctly

Verify these CSS rules exist and work:
```css
.wip-hidden { display: none !important; }
.grafted-hidden { display: none !important; }
```

If `.wip-hidden` and `.grafted-hidden` in styles.css do NOT have `!important`, add it — this is likely the root cause since collapsed/expanded state classes may override the hidden class.

Also verify: when "Hide WIP Content" is toggled ON and then the tree is re-rendered (e.g., after merge), the toggle state should be reapplied. Currently the tree re-renders and wipes the hidden classes but doesn't recheck toggle state. Add a call after `displayIfpTree` in the merge handler to reapply toggle states if active.

**Reset handler — clear previews:**
- In the reset handler (line ~722): add cleanup for preview containers:
  ```javascript
  document.getElementById('ifpSourcePreview').innerHTML = '';
  document.getElementById('ifpSourcePreview').classList.remove('show');
  document.getElementById('ifpPriorPreview').innerHTML = '';
  document.getElementById('ifpPriorPreview').classList.remove('show');
  ```
  </action>
  <verify>
- Upload a JSON artifact file — tree preview appears immediately beneath the Prior IFP upload zone with state pills
- Upload an XML file — tree preview appears beneath the Source Export upload zone with state pills
- After merge: click "Hide WIP Content" — children of WIP assemblies disappear, WIP assembly row stays visible
- After merge: click "Hide B(n-1) Substitutions" — all grafted (B(n)) rows disappear
- Click "Start Over" — both previews clear
  </verify>
  <done>JSON and XML trees preview on upload with state pills. Both toggle buttons work correctly to filter merged tree view. Reset clears previews.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete test suite issue fixes: source labels resolved, warnings with descriptions, conditional job number, revision auto-increment, swapped upload panels, tree previews, working toggles, 258758 XML fix</what-built>
  <how-to-verify>
    1. Deploy to GitHub Pages and visit https://mondreykr.github.io/bom-tool/
    2. Go to IFP Merge tab — verify Prior IFP is on LEFT, Source Export on RIGHT
    3. Upload a JSON artifact (e.g., B(0) from test suite) — verify tree preview appears immediately with state pills
    4. Upload corresponding XML — verify tree preview appears on right side
    5. Run merge — verify source column shows "X(2)", "B(1)", "New (WIP)" etc. (no blanks, no abstract labels)
    6. Check any warnings include description in parentheses and resolved revision numbers
    7. Click "Hide WIP Content" — verify WIP assembly children hide
    8. Click "Hide B(n-1) Substitutions" — verify grafted rows hide
    9. Test job number: upload XML for GA starting with 1 (e.g., 1035704) — job should default to "1J" only
    10. Test job number: upload XML for GA starting with 2 (e.g., 258758) — job should default to "1J258758"
    11. Verify export disabled until job number is 1J + 6 digits
    12. Load 258758-Rev3-20260205.XML — verify no false positive "Missing NS Item Type" errors
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Run `cd test && node run-tests.js` — all 4 automated tests pass
- Visual verification of all fixes through checkpoint
</verification>

<success_criteria>
1. Upload panels swapped: Prior LEFT, Source RIGHT
2. Tree previews render on both JSON and XML upload with state pills
3. Hide WIP Content toggle hides WIP assembly children
4. Hide B(n-1) Substitutions toggle hides grafted rows
5. All visual elements verified by user through checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/14.2-test-suite-issue-fixes/14.2-02-SUMMARY.md`
</output>
