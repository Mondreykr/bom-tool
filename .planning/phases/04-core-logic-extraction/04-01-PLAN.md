---
phase: 04-core-logic-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/core/tree.js
  - js/core/compare.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "BOMNode class works from js/core/tree.js import (not inline)"
    - "buildTree produces sorted children (Component Type > Description > Length)"
    - "flattenBOM and sortBOM work from js/core/flatten.js import"
    - "parseXML works from js/core/parser.js import"
    - "compareBOMs returns results with attributesChanged and lengthFractional fields"
    - "Root info accessible via getRootPartNumber/getRootRevision/getRootDescription getters"
    - "Root info resettable via resetRootInfo()"
    - "All 4 automated tests pass with identical outputs"
    - "Zero inline core logic definitions remain in index.html"
  artifacts:
    - path: "js/core/tree.js"
      provides: "BOMNode, buildTree (with sortChildren), root info getters, resetRootInfo"
      exports: ["BOMNode", "buildTree", "getRootPartNumber", "getRootRevision", "getRootDescription", "resetRootInfo"]
    - path: "js/core/compare.js"
      provides: "compareBOMs with attributesChanged and lengthFractional, extractSubtree, findNodeByPartNumber"
      exports: ["compareBOMs", "extractSubtree", "findNodeByPartNumber"]
    - path: "index.html"
      provides: "Application using imported modules instead of inline definitions"
      contains: "import.*from.*js/core/tree.js"
  key_links:
    - from: "index.html"
      to: "js/core/tree.js"
      via: "ES6 import"
      pattern: "import.*BOMNode.*buildTree.*from.*tree.js"
    - from: "index.html"
      to: "js/core/flatten.js"
      via: "ES6 import"
      pattern: "import.*flattenBOM.*sortBOM.*from.*flatten.js"
    - from: "index.html"
      to: "js/core/parser.js"
      via: "ES6 import"
      pattern: "import.*parseXML.*from.*parser.js"
    - from: "index.html"
      to: "js/core/compare.js"
      via: "ES6 import"
      pattern: "import.*compareBOMs.*extractSubtree.*from.*compare.js"
    - from: "index.html compareBOMs call"
      to: "compareBOMs function"
      via: "params + return value"
      pattern: "comparisonResults = compareBOMs\\(oldBomFlattened, newBomFlattened\\)"
---

<objective>
Extract all core business logic from inline definitions in index.html to ES6 module imports. After this plan, index.html has zero inline definitions of BOMNode, buildTree, flattenBOM, sortBOM, parseXML, compareBOMs, extractSubtree, or createCompositeKey. All core logic runs from js/core/ modules.

Purpose: Eliminate code duplication between inline HTML and modules. Establishes single source of truth for all business logic. Makes future feature additions (IFP Merge) target modules only.

Output: Updated tree.js and compare.js modules matching inline behavior, index.html importing from all core modules with inline definitions removed.
</objective>

<execution_context>
@C:\Users\amcallister\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\amcallister\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-logic-extraction/04-RESEARCH.md
@.planning/phases/03-utilities-extraction/03-01-SUMMARY.md

Critical source files to read before starting:
@js/core/tree.js
@js/core/compare.js
@js/core/flatten.js
@js/core/parser.js
@js/core/utils.js
@test/run-tests.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update modules to match inline HTML behavior</name>
  <files>js/core/tree.js, js/core/compare.js</files>
  <action>
Two modules need updates before the HTML can import them. The inline HTML versions have features the current modules lack.

**1. Update js/core/tree.js -- add sortChildren to buildTree and add resetRootInfo export:**

The inline `buildTree` (index.html ~line 684-713) sorts all children recursively after tree construction. The module `buildTree` does NOT sort. This affects hierarchy view display order. Add the `sortChildren` nested function inside `buildTree`, called after getting the root node and before setting root info.

Add this sortChildren function inside buildTree, after `const root = nodes.get('1')` and the root null check, BEFORE the root info capture lines:

```javascript
// Pass 3: Sort all children recursively
function sortChildren(node) {
    if (node.children.length > 0) {
        // Sort by: Component Type > Description > Length (decimal)
        node.children.sort((a, b) => {
            if (a.componentType !== b.componentType) {
                return a.componentType.localeCompare(b.componentType);
            }
            if (a.description !== b.description) {
                return a.description.localeCompare(b.description, undefined, {
                    numeric: true,
                    sensitivity: 'base'
                });
            }
            if (a.length === null && b.length === null) return 0;
            if (a.length === null) return 1;
            if (b.length === null) return -1;
            return a.length - b.length;
        });
        node.children.forEach(child => sortChildren(child));
    }
}

sortChildren(root);
```

Also add a `resetRootInfo` exported function. The HTML reset button (index.html line ~1268) sets root info globals to null. With module pattern, we need an exported function to reset private vars:

```javascript
export function resetRootInfo() {
    _rootPartNumber = null;
    _rootRevision = null;
    _rootDescription = null;
}
```

**2. Update js/core/compare.js -- add attributesChanged and lengthFractional to compareBOMs output:**

The inline `compareBOMs` (index.html lines 1808-1903) includes two fields the module version lacks:
- `attributesChanged`: Array of strings like ["Qty", "Description", "Purchase Desc"] for Changed items; empty array `[]` for Added/Removed items
- `lengthFractional`: Carried through from the flattened item's `lengthFractional` property

The module `compareBOMs` already takes `(oldFlattened, newFlattened)` params and returns results, which is the CORRECT signature. The HTML will be updated to use this signature.

Add `attributesChanged` to all three result push blocks:
- Added items: `attributesChanged: []`
- Changed items: Build `changedAttrs` array checking qty/description/purchaseDescription changes, then `attributesChanged: changedAttrs`
- Removed items: `attributesChanged: []`

Add `lengthFractional` to all three result push blocks:
- Added items: `lengthFractional: newItem.lengthFractional`
- Changed items: `lengthFractional: newItem.lengthFractional` (use newItem since it's the current version)
- Removed items: `lengthFractional: oldItem.lengthFractional`

For Changed items, the current module version checks `qtyChanged`, `descChanged`, `purDescChanged` separately. Add the `changedAttrs` array construction matching the inline logic:

```javascript
const changedAttrs = [];
if (qtyChanged) changedAttrs.push('Qty');
if (descChanged) changedAttrs.push('Description');
if (purDescChanged) changedAttrs.push('Purchase Desc');
```

Then use `attributesChanged: changedAttrs` in the Changed result push.

IMPORTANT: Do NOT change the function signature. Keep `compareBOMs(oldFlattened, newFlattened)` with return value. Do NOT make it read from globals.

After changes, run tests:
```bash
cd test && node run-tests.js
```
Tests must still pass (4/4). The test harness checks comparison output fields but does not check attributesChanged or lengthFractional, so adding these fields is backward-compatible.
  </action>
  <verify>
Run `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` -- all 4 tests pass.

Verify tree.js exports:
```bash
grep -n "export function\|export class" js/core/tree.js
```
Expected: BOMNode, buildTree, getRootPartNumber, getRootRevision, getRootDescription, resetRootInfo

Verify compare.js has attributesChanged:
```bash
grep -n "attributesChanged" js/core/compare.js
```
Expected: 3+ matches (one in each result push block)

Verify tree.js has sortChildren:
```bash
grep -n "sortChildren" js/core/tree.js
```
Expected: function definition + call inside buildTree
  </verify>
  <done>
tree.js exports BOMNode, buildTree (with sortChildren), getRootPartNumber, getRootRevision, getRootDescription, and resetRootInfo. compare.js compareBOMs returns results with attributesChanged and lengthFractional fields. All 4 tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire HTML to modules and remove inline definitions</name>
  <files>index.html</files>
  <action>
Add core module imports to index.html and remove all inline core logic definitions. This follows the exact pattern established in Phase 3 (03-01) for utility extraction.

**Step 1: Add import statements**

After the existing utils.js import line (line 394), add these imports:

```javascript
import { BOMNode, buildTree, getRootPartNumber, getRootRevision, getRootDescription, resetRootInfo } from './js/core/tree.js';
import { flattenBOM, sortBOM } from './js/core/flatten.js';
import { parseXML } from './js/core/parser.js';
import { compareBOMs, extractSubtree } from './js/core/compare.js';
```

Note: Do NOT import `findNodeByPartNumber` -- it is not used in the HTML. Do NOT import `parseCSV` -- it is not used in the HTML (CSV parsing is handled by XLSX library directly in the file reader). Do NOT import `getCompositeKey` from utils.js for compareBOMs -- the module compareBOMs already uses it internally.

**Step 2: Remove inline function definitions**

Remove these inline definitions by searching for their function/class signature and deleting through the closing brace. Use the function signatures to locate them -- do NOT rely on line numbers (they shift as earlier removals happen).

Remove in this order (top to bottom in file to avoid line shift confusion):

1. `function parseXML(xmlText) {` -- approximately lines 535-628. Search for the line starting with `function parseXML(xmlText)` and remove through the matching closing `}`. This is a large function with nested `traverseDocument`.

2. `class BOMNode {` -- approximately lines 631-647. Search for `class BOMNode {` and remove through the matching closing `}`.

3. `function buildTree(rows) {` -- approximately lines 650-721. Search for `function buildTree(rows)` and remove through the matching closing `}`. This includes nested `sortChildren`.

4. `function flattenBOM(rootNode, unitQty) {` -- approximately lines 724-782. Search for `function flattenBOM(rootNode, unitQty)` and remove through the matching closing `}`. This includes nested `traverse`.

5. `function sortBOM(items) {` -- approximately lines 785-806. Search for `function sortBOM(items)` and remove through the matching closing `}`.

6. `function extractSubtree(node) {` -- approximately lines 1546-1566. Search for `function extractSubtree(node)` and remove through the matching closing `}`. This includes nested `cloneNode`.

7. `function compareBOMs() {` -- approximately lines 1808-1903. Search for `function compareBOMs() {` and remove through the matching closing `}`.

8. `function createCompositeKey(partNumber, length) {` -- approximately lines 1905-1910. Search for `function createCompositeKey(partNumber, length)` and remove through the matching closing `}`.

**Step 3: Remove root info global variable declarations**

Remove these 3 lines (approximately lines 400-402, they are together):
```javascript
let rootPartNumber = null;
let rootRevision = null;
let rootDescription = null;
```

**Step 4: Update compareBOMs call site**

Find the call at approximately line 1794 (after earlier removals, line number will be different):
```javascript
compareBOMs();
```

Replace with:
```javascript
comparisonResults = compareBOMs(oldBomFlattened, newBomFlattened);
```

The module `compareBOMs` takes two params and returns results, unlike the inline version which read globals and wrote to globals.

**Step 5: Replace root info variable reads with getter calls**

Find and replace all READ usages of rootPartNumber, rootRevision, rootDescription with their getter equivalents. These are in template literals and assignment expressions:

- `rootPartNumber` --> `getRootPartNumber()`
- `rootRevision` --> `getRootRevision()`
- `rootDescription` --> `getRootDescription()`

Specific locations to update (search for each and replace):

In the Flat BOM display section (~line 892-893 before removals):
- `` `${rootPartNumber} - ${rootDescription || ''}` `` --> `` `${getRootPartNumber()} - ${getRootDescription() || ''}` ``
- `rootRevision` --> `getRootRevision()`

In Flat BOM Excel export filename (~line 958):
- `` `${rootPartNumber}-Rev${rootRevision}` `` --> `` `${getRootPartNumber()}-Rev${getRootRevision()}` ``

In Flat BOM HTML export (~line 1016):
- `` `Flat BOM - ${rootPartNumber} Rev${rootRevision}` `` --> `` `Flat BOM - ${getRootPartNumber()} Rev${getRootRevision()}` ``

In Flat BOM HTML export body (~lines 1192-1193):
- `` `${rootPartNumber} - ${rootDescription || ''}` `` --> `` `${getRootPartNumber()} - ${getRootDescription() || ''}` ``
- `` `Revision: ${rootRevision}` `` --> `` `Revision: ${getRootRevision()}` ``

In Flat BOM HTML export filename (~line 1250):
- `` `${rootPartNumber}-Rev${rootRevision}` `` --> `` `${getRootPartNumber()}-Rev${getRootRevision()}` ``

In Hierarchy View root info capture (~lines 2721-2723):
- `partNumber: rootPartNumber` --> `partNumber: getRootPartNumber()`
- `revision: rootRevision` --> `revision: getRootRevision()`
- `description: rootDescription` --> `description: getRootDescription()`

**Step 6: Replace root info reset with resetRootInfo()**

Find the reset handler that sets root info to null (~lines 1268-1270 before removals):
```javascript
rootPartNumber = null;
rootRevision = null;
rootDescription = null;
```

Replace with:
```javascript
resetRootInfo();
```

**Step 7: Verify no inline core logic remains**

After all changes, verify with grep that ZERO inline definitions remain:

```bash
grep -n "class BOMNode\|function buildTree\|function flattenBOM\|function sortBOM\|function parseXML\|function compareBOMs\|function extractSubtree\|function createCompositeKey" index.html
```
Expected: ZERO matches.

```bash
grep -n "let rootPartNumber\|let rootRevision\|let rootDescription" index.html
```
Expected: ZERO matches.

```bash
grep -n "import.*from.*js/core/" index.html
```
Expected: 5 import lines (utils.js, tree.js, flatten.js, parser.js, compare.js).

**Step 8: Run tests**

```bash
cd test && node run-tests.js
```
Expected: 4/4 tests pass, ALL TESTS PASSED.
  </action>
  <verify>
1. Run: `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` -- 4/4 tests pass
2. Run: `grep -c "class BOMNode\|function buildTree\|function flattenBOM\|function sortBOM\|function parseXML\|function compareBOMs\|function extractSubtree\|function createCompositeKey" C:/Users/amcallister/Projects/bom-tool/index.html` -- returns 0
3. Run: `grep -c "let rootPartNumber\|let rootRevision\|let rootDescription" C:/Users/amcallister/Projects/bom-tool/index.html` -- returns 0
4. Run: `grep -c "import.*from.*js/core/" C:/Users/amcallister/Projects/bom-tool/index.html` -- returns 5
5. Run: `grep -c "getRootPartNumber\|getRootRevision\|getRootDescription" C:/Users/amcallister/Projects/bom-tool/index.html` -- returns 10+ (all read sites using getters)
6. Run: `grep -c "resetRootInfo" C:/Users/amcallister/Projects/bom-tool/index.html` -- returns 1+ (import + call site)
  </verify>
  <done>
index.html imports BOMNode, buildTree, getRootPartNumber, getRootRevision, getRootDescription, resetRootInfo from tree.js; flattenBOM, sortBOM from flatten.js; parseXML from parser.js; compareBOMs, extractSubtree from compare.js. Zero inline core logic definitions remain. compareBOMs call site passes params and captures return value. All root info reads use getter functions. Root info reset uses resetRootInfo(). All 4 automated tests pass with identical outputs.
  </done>
</task>

</tasks>

<verification>
1. All 4 automated tests pass: `cd test && node run-tests.js` shows "4/4 tests passed, ALL TESTS PASSED"
2. Zero inline core function definitions in index.html
3. Zero root info global variable declarations in index.html
4. Five import lines from js/core/ modules in index.html
5. All root info reads use getter functions
6. compareBOMs call site uses params + return value pattern
7. tree.js buildTree sorts children recursively (sortChildren function present)
8. compare.js compareBOMs includes attributesChanged and lengthFractional in results
</verification>

<success_criteria>
- All 4 automated tests pass with identical outputs to baseline
- index.html has zero inline definitions of: BOMNode, buildTree, flattenBOM, sortBOM, parseXML, compareBOMs, extractSubtree, createCompositeKey
- index.html has zero declarations of: rootPartNumber, rootRevision, rootDescription as let variables
- index.html imports from 5 core modules: utils.js, tree.js, flatten.js, parser.js, compare.js
- Module tree.js exports: BOMNode, buildTree, getRootPartNumber, getRootRevision, getRootDescription, resetRootInfo
- Module compare.js compareBOMs returns objects with attributesChanged and lengthFractional fields
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-logic-extraction/04-01-SUMMARY.md`
</output>
