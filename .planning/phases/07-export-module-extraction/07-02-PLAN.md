---
phase: 07-export-module-extraction
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - js/export/html.js
  - js/ui/flat-bom.js
  - js/ui/comparison.js
  - js/ui/hierarchy.js
autonomous: true

must_haves:
  truths:
    - "Flat BOM HTML export produces identical output to current behavior"
    - "Comparison HTML export produces identical output to current behavior"
    - "Hierarchy HTML export produces identical output with interactive tree toggles"
    - "HTML export filenames follow the same pattern as current behavior"
    - "Blob URL cleanup (revokeObjectURL) happens on every HTML export"
    - "Automated tests still pass at 2/4 baseline after all changes"
  artifacts:
    - path: "js/export/html.js"
      provides: "HTML export functions for all three tabs"
      exports: ["exportFlatBomHtml", "exportComparisonHtml", "exportHierarchyHtml"]
  key_links:
    - from: "js/export/html.js"
      to: "js/export/shared.js"
      via: "import shared utilities"
      pattern: "import.*from.*shared"
    - from: "js/ui/flat-bom.js"
      to: "js/export/html.js"
      via: "import and call in button handler"
      pattern: "import.*exportFlatBomHtml.*from.*export/html"
    - from: "js/ui/comparison.js"
      to: "js/export/html.js"
      via: "import and call in button handler"
      pattern: "import.*exportComparisonHtml.*from.*export/html"
    - from: "js/ui/hierarchy.js"
      to: "js/export/html.js"
      via: "import and call in button handler"
      pattern: "import.*exportHierarchyHtml.*from.*export/html"
---

<objective>
Extract all three HTML export functions into js/export/html.js and wire them into the UI modules, completing the export module extraction.

Purpose: Move the large HTML template-based export functions (296 + 321 + 399 = ~1016 lines total) out of UI modules into a dedicated html.js export module. This dramatically reduces UI module size and centralizes all HTML report generation. Uses shared utilities created in Plan 01.

Output: js/export/html.js (3 HTML functions), updated UI modules with import+call pattern replacing inline HTML export logic.
</objective>

<execution_context>
@C:/Users/amcallister/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/amcallister/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-export-module-extraction/07-RESEARCH.md
@.planning/phases/07-export-module-extraction/07-01-SUMMARY.md
@js/export/shared.js
@js/ui/flat-bom.js
@js/ui/comparison.js
@js/ui/hierarchy.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HTML export module with all three export functions</name>
  <files>js/export/html.js</files>
  <action>
Create js/export/html.js with three HTML export functions.

Import shared utilities: `import { formatDateString, formatGeneratedDate, createDownloadFilename, createComparisonFilename, downloadHtmlFile } from './shared.js';`
Import createDiff from utils: `import { createDiff, decimalToFractional } from '../core/utils.js';`

Each function generates a complete standalone HTML document with embedded CSS and downloads it via the shared `downloadHtmlFile()` function.

1. `exportFlatBomHtml(flattenedBOM, uploadedFilename, rootPartNumber, rootRevision, rootDescription, unitQty)` - Extract VERBATIM from flat-bom.js lines 301-596. The function must:
   - Call formatDateString() and formatGeneratedDate() from shared.js
   - Calculate component breakdown counts (Manufactured, Purchased, Raw Stock) from flattenedBOM
   - Build breakdownHTML string with conditional sections
   - Generate the full HTML template literal with ALL embedded CSS (~160 lines of CSS)
   - Handle purchase description line breaks: `item.purchaseDescription ? item.purchaseDescription.replace(/\n/g, '<br>') : ''`
   - Call createDownloadFilename() with reportType 'Flat BOM' and extension 'html'
   - Call downloadHtmlFile() to trigger download
   - CRITICAL: The HTML template, CSS, and data rendering must be BYTE-IDENTICAL to current output. Do not reformat, restructure, or "clean up" the template.

2. `exportComparisonHtml(comparisonResults, sortFn, oldBomFilename, oldBomInfo, newBomFilename, newBomInfo)` - Extract VERBATIM from comparison.js lines 683-1003. The function must:
   - Call formatDateString() and formatGeneratedDate() from shared.js
   - Calculate added/removed/changed counts from comparisonResults
   - Sort results using the passed sortFn callback
   - Build tableRows string with diff highlighting for Description and Purchase Description changes using createDiff() imported from utils.js
   - Handle delta quantity display with positive/negative styling
   - Generate the full HTML template with ALL embedded CSS (~165 lines of CSS including badge, diff, and delta styles)
   - The comparison HTML has DIFFERENT CSS than flat BOM (additional .badge, .diff-removed, .diff-added, .delta-positive, .delta-negative, .assembly-grid, .assembly-card styles)
   - Call createComparisonFilename() for the filename
   - Call downloadHtmlFile() to trigger download
   - CRITICAL: Preserve the exact tableRows building loop including all conditional diff highlighting logic

3. `exportHierarchyHtml(hierarchyTree, hierarchyFilename, hierarchyRootInfo, unitQty)` - Extract VERBATIM from hierarchy.js lines 461-859. The function must:
   - Call formatDateString() and formatGeneratedDate() from shared.js
   - Include the recursive `generateTreeHTML(node, depth, isLastChild, ancestorContinues, uQty)` function as a local function inside the export function
   - Use decimalToFractional() imported from utils.js for length conversion in tree nodes
   - Generate tree lines (vertical + horizontal) with position calculations based on depth
   - Generate expand/collapse toggles with `onclick="toggleNode(this)"` attributes
   - Include the FULL `<script>` block with the `toggleNode()` function (this is inline JavaScript in the exported HTML that makes the tree interactive)
   - The escaped closing script tag must be preserved: `<\/script>` in the template literal
   - CSS includes tree-specific styles: .tree-cell, .tree-lines, .tree-line-vertical, .tree-line-horizontal, .tree-toggle, tr.child-row.collapsed, tr.has-children.expanded
   - Call createDownloadFilename() with reportType 'Hierarchy' and extension 'html'
   - Call downloadHtmlFile() to trigger download
   - CRITICAL: The tree line calculations (baseIndent, indent, depth * 24, leftPos formulas) must be preserved exactly

Export all three functions as named exports.
  </action>
  <verify>
Verify file exists and has correct structure:
- `ls js/export/html.js` exists
- html.js exports: exportFlatBomHtml, exportComparisonHtml, exportHierarchyHtml
- html.js imports from ./shared.js (formatDateString, formatGeneratedDate, createDownloadFilename, createComparisonFilename, downloadHtmlFile)
- html.js imports from ../core/utils.js (createDiff, decimalToFractional)
- The Hierarchy HTML export includes the `<script>` block with toggleNode function
- No `async` keywords in the file
  </verify>
  <done>
js/export/html.js exists with all three HTML export functions as named exports. Each function generates a complete standalone HTML document identical to current behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire HTML exports into UI modules and remove inline HTML export code</name>
  <files>js/ui/flat-bom.js, js/ui/comparison.js, js/ui/hierarchy.js</files>
  <action>
Update each UI module to import from js/export/html.js and replace inline HTML export handlers with calls to the new functions.

**js/ui/flat-bom.js:**
1. Add import: `import { exportFlatBomHtml } from '../export/html.js';` (add next to the existing excel.js import from Plan 01)
2. Replace the entire exportHtmlBtn click handler (previously lines 301-596, now shorter after Plan 01 changes) with:
   ```
   exportHtmlBtn.addEventListener('click', () => {
       if (!state.flattenedBOM) return;
       const unitQty = parseInt(unitQtyInput.value);
       exportFlatBomHtml(state.flattenedBOM, state.uploadedFilename, getRootPartNumber(), getRootRevision(), getRootDescription(), unitQty);
   });
   ```
3. After this change, flat-bom.js should have NO template literals containing `<!DOCTYPE html>` or embedded CSS blocks.

**js/ui/comparison.js:**
1. Add import: `import { exportComparisonHtml } from '../export/html.js';` (add next to the existing excel.js import from Plan 01)
2. Replace the entire exportCompareHtmlBtn click handler (previously lines 683-1003) with:
   ```
   exportCompareHtmlBtn.addEventListener('click', () => {
       exportComparisonHtml(state.comparisonResults, sortComparisonResults, state.oldBomFilename, state.oldBomInfo, state.newBomFilename, state.newBomInfo);
   });
   ```
3. The createDiff import can be removed from comparison.js ONLY IF it's not used elsewhere in the file. Check: createDiff IS also used in renderComparisonTable() (lines 549 and 574-576). So the createDiff import MUST stay in comparison.js.

**js/ui/hierarchy.js:**
1. Add import: `import { exportHierarchyHtml } from '../export/html.js';` (add next to the existing excel.js import from Plan 01)
2. Replace the entire exportHierarchyHtmlBtn click handler (previously lines 461-859) with:
   ```
   exportHierarchyHtmlBtn.addEventListener('click', () => {
       const unitQty = parseInt(hierarchyUnitQtyInput.value) || 1;
       exportHierarchyHtml(state.hierarchyTree, state.hierarchyFilename, state.hierarchyRootInfo, unitQty);
   });
   ```
3. The decimalToFractional import MUST stay in hierarchy.js (it's used in renderTreeNode() at line 277 for display).

For each file, ensure:
- The inline HTML export code is completely removed (not just commented out)
- The new import statement is added at the top with other imports
- Guard clauses and data passing are correct
- No other code in the file is changed
- After removal, count the line reduction: flat-bom.js should lose ~295 lines, comparison.js ~320 lines, hierarchy.js ~398 lines
  </action>
  <verify>
Run automated tests: `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js`

Expected result: Same test results as before (2/4 passing baseline maintained). Tests don't directly test HTML exports, but they verify the codebase still loads and the core functions work.

Also verify:
- No `<!DOCTYPE html>` template literals remain in any js/ui/*.js file
- No `new Blob([html]` or `URL.createObjectURL` calls remain in any js/ui/*.js file
- flat-bom.js has `import { exportFlatBomHtml }` from export/html.js
- comparison.js has `import { exportComparisonHtml }` from export/html.js
- hierarchy.js has `import { exportHierarchyHtml }` from export/html.js
- comparison.js still imports createDiff from utils.js (used by renderComparisonTable)
- hierarchy.js still imports decimalToFractional from utils.js (used by renderTreeNode)
  </verify>
  <done>
All three UI modules import and call HTML export functions from js/export/html.js. Inline HTML export code (~1016 lines total) is removed from UI modules. Automated tests pass at the same baseline (2/4). Phase 7 export extraction is complete.
  </done>
</task>

</tasks>

<verification>
1. `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` passes at 2/4 baseline
2. `js/export/html.js` exists with 3 named exports
3. No `<!DOCTYPE html>` template literals in any js/ui/*.js file
4. No `new Blob` or `URL.createObjectURL` calls in any js/ui/*.js file
5. All 6 export functions (3 Excel + 3 HTML) live in js/export/ directory
6. UI modules only contain import+call pattern for all export buttons
7. js/export/shared.js utilities are used by both excel.js and html.js (no duplication)
</verification>

<success_criteria>
- js/export/html.js created with 3 HTML export functions
- Three UI modules updated with import+call pattern for HTML exports
- ~1016 lines of HTML template code removed from UI modules
- Automated tests pass at 2/4 baseline (zero regressions)
- All export functionality fully extracted to js/export/ directory
- Phase 7 complete: EXPORT-01 (Excel module), EXPORT-02 (HTML module), EXPORT-03 (Excel tests pass), EXPORT-04 (HTML identical behavior)
</success_criteria>

<output>
After completion, create `.planning/phases/07-export-module-extraction/07-02-SUMMARY.md`
</output>
