---
phase: 07-export-module-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/export/shared.js
  - js/export/excel.js
  - js/ui/flat-bom.js
  - js/ui/comparison.js
  - js/ui/hierarchy.js
autonomous: true

must_haves:
  truths:
    - "Flat BOM Excel export produces identical output to current behavior"
    - "Comparison Excel export produces identical output to current behavior"
    - "Hierarchy Excel export produces identical output to current behavior"
    - "All Excel export filenames follow the same pattern as current behavior"
    - "Automated tests pass with zero regressions (2/4 baseline maintained)"
  artifacts:
    - path: "js/export/shared.js"
      provides: "Common export utilities: date formatting, filename generation, HTML download"
      exports: ["formatDateString", "formatGeneratedDate", "createDownloadFilename", "createComparisonFilename", "downloadHtmlFile"]
    - path: "js/export/excel.js"
      provides: "Excel export functions for all three tabs"
      exports: ["exportFlatBomExcel", "exportComparisonExcel", "exportHierarchyExcel"]
  key_links:
    - from: "js/export/excel.js"
      to: "XLSX global"
      via: "direct reference to window.XLSX (CDN-loaded)"
      pattern: "XLSX\\.utils\\."
    - from: "js/ui/flat-bom.js"
      to: "js/export/excel.js"
      via: "import and call in button handler"
      pattern: "import.*exportFlatBomExcel.*from.*export/excel"
    - from: "js/ui/comparison.js"
      to: "js/export/excel.js"
      via: "import and call in button handler"
      pattern: "import.*exportComparisonExcel.*from.*export/excel"
    - from: "js/ui/hierarchy.js"
      to: "js/export/excel.js"
      via: "import and call in button handler"
      pattern: "import.*exportHierarchyExcel.*from.*export/excel"
---

<objective>
Extract shared export utilities and all three Excel export functions into dedicated modules, then wire them into the existing UI modules.

Purpose: Move Excel export logic out of UI modules into js/export/shared.js and js/export/excel.js. This is the critical extraction because automated tests validate Excel output against baseline control files. Excel exports must produce byte-identical output.

Output: js/export/shared.js (common utilities), js/export/excel.js (3 Excel functions), updated UI modules with import+call pattern replacing inline export logic.
</objective>

<execution_context>
@C:/Users/amcallister/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/amcallister/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-export-module-extraction/07-RESEARCH.md
@js/ui/flat-bom.js
@js/ui/comparison.js
@js/ui/hierarchy.js
@js/core/environment.js
@js/core/utils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared export utilities and Excel export module</name>
  <files>js/export/shared.js, js/export/excel.js</files>
  <action>
Create js/export/ directory with two files:

**js/export/shared.js** - Common utilities used by both Excel and HTML exports:

1. `formatDateString()` - Returns YYYYMMDD string. Extract the exact pattern from flat-bom.js:285-288:
   ```
   const today = new Date();
   return today.getFullYear() +
       String(today.getMonth() + 1).padStart(2, '0') +
       String(today.getDate()).padStart(2, '0');
   ```

2. `formatGeneratedDate()` - Returns "YYYY-MM-DD HH:MM:SS" string. Extract the exact pattern from flat-bom.js:311 (used by HTML exports, but define here for Plan 02).

3. `createDownloadFilename(uploadedFilename, rootPartNumber, rootRevision, reportType, dateStr, extension)` - Filename generation for Flat BOM and Hierarchy. Extract pattern from flat-bom.js:291-294:
   ```
   const baseFilename = uploadedFilename
       ? uploadedFilename.replace(/\.(csv|xml)$/i, '')
       : `${rootPartNumber}-Rev${rootRevision}`;
   return `${baseFilename}-${reportType}-${dateStr}.${extension}`;
   ```
   Note: Pass rootPartNumber and rootRevision as separate parameters (NOT calling getRootPartNumber()/getRootRevision() inside shared.js - those are tree.js functions that shouldn't be imported here).

4. `createComparisonFilename(oldFilename, oldInfo, newFilename, newInfo, dateStr, extension)` - Filename generation for Comparison tab. Extract pattern from comparison.js:635-641:
   ```
   const oldBase = oldFilename
       ? oldFilename.replace(/\.(csv|xml)$/i, '')
       : `${oldInfo.partNumber}-Rev${oldInfo.revision}`;
   const newBase = newFilename
       ? newFilename.replace(/\.(csv|xml)$/i, '')
       : `${newInfo.partNumber}-Rev${newInfo.revision}`;
   return `${oldBase}-vs-${newBase}-Comparison-${dateStr}.${extension}`;
   ```

5. `downloadHtmlFile(htmlContent, filename)` - Blob download pattern for HTML exports. Extract from flat-bom.js:589-595. Include URL.revokeObjectURL() cleanup.

All functions are synchronous (no async). Export all as named exports.

**js/export/excel.js** - Three Excel export functions:

Import shared utilities: `import { formatDateString, createDownloadFilename, createComparisonFilename } from './shared.js';`
Import decimalToFractional from utils: `import { decimalToFractional } from '../core/utils.js';`
Do NOT import XLSX from environment.js. Use the global `XLSX` directly (same as current UI modules do). The CDN script tag loads before modules execute.

1. `exportFlatBomExcel(flattenedBOM, uploadedFilename, rootPartNumber, rootRevision)` - Extract from flat-bom.js:261-298 VERBATIM. The data mapping with explicit column order MUST be preserved exactly:
   ```
   const excelData = flattenedBOM.map(item => ({
       'Qty': item.qty,
       'Part Number': item.partNumber,
       'Component Type': item.componentType,
       'Description': item.description,
       'Length (Decimal)': item.lengthDecimal !== null ? item.lengthDecimal : '',
       'Length (Fractional)': item.lengthFractional,
       'UofM': item.uofm,
       'Purchase Description': item.purchaseDescription || '',
       'State': item.state,
       'Revision': item.revision,
       'NS Item Type': item.nsItemType
   }));
   ```
   Use `XLSX.utils.json_to_sheet(excelData)` and sheet name `'Flat BOM'`.
   Use `createDownloadFilename(uploadedFilename, rootPartNumber, rootRevision, 'Flat BOM', dateStr, 'xlsx')`.
   Use `XLSX.writeFile(wb, filename)`.

2. `exportComparisonExcel(comparisonResults, sortFn, oldBomFilename, oldBomInfo, newBomFilename, newBomInfo)` - Extract from comparison.js:628-681. This uses `aoa_to_sheet` (array-of-arrays), NOT `json_to_sheet`. The `sortFn` parameter is the `sortComparisonResults` function passed from the UI module (it's a local function in comparison.js that's also used for display).

   CRITICAL: The header rows MUST be preserved exactly:
   ```
   const ws_data = [
       ['Old BOM:', oldBomFilename || 'N/A', `${oldBomInfo.partNumber} - ${oldBomInfo.description}`, `Rev ${oldBomInfo.revision}`, oldScopeText],
       ['New BOM:', newBomFilename || 'N/A', `${newBomInfo.partNumber} - ${newBomInfo.description}`, `Rev ${newBomInfo.revision}`, newScopeText],
       [],
       ['Change Type', 'Part Number', 'Component Type', 'Old Description', 'New Description', 'Length (Decimal)', 'Length (Fractional)', 'Old Qty', 'New Qty', 'Î” Qty', 'Old Purchase Description', 'New Purchase Description', 'Attributes Changed']
   ];
   ```
   Build scope text from `oldBomInfo.isScoped` / `newBomInfo.isScoped` and `.scopedPartNumber`.
   Sheet name: `'Comparison'`.
   Use `createComparisonFilename()` for filename.
   Use `XLSX.writeFile(wb, filename)`.

3. `exportHierarchyExcel(hierarchyTree, hierarchyFilename, hierarchyRootInfo, unitQty)` - Extract from hierarchy.js:416-459. Includes the recursive `traverseForExport()` as a local function inside the export function. Uses `decimalToFractional()` imported from utils.js. Column order MUST be preserved:
   ```
   {
       'Level': level,
       'Part Number': node.partNumber,
       'Qty': node.qty * unitQty,
       'Component Type': node.componentType,
       'Description': node.description,
       'Length (Decimal)': node.length !== null ? node.length : '',
       'Length (Fractional)': node.length !== null ? decimalToFractional(node.length) : '',
       'UofM': node.uofm || '',
       'Purchase Description': node.purchaseDescription || '',
       'Revision': node.revision || '',
       'NS Item Type': node.nsItemType || ''
   }
   ```
   Sheet name: `'Hierarchy'`.
   Use `createDownloadFilename(hierarchyFilename, hierarchyRootInfo.partNumber, hierarchyRootInfo.revision, 'Hierarchy', dateStr, 'xlsx')`.

All functions are synchronous (XLSX.writeFile is sync). Export all as named exports.
  </action>
  <verify>
Verify files exist and have correct exports:
- `ls js/export/shared.js js/export/excel.js` both exist
- shared.js exports: formatDateString, formatGeneratedDate, createDownloadFilename, createComparisonFilename, downloadHtmlFile
- excel.js exports: exportFlatBomExcel, exportComparisonExcel, exportHierarchyExcel
- excel.js imports from ./shared.js (not duplicating date/filename logic)
- excel.js does NOT import from environment.js (uses XLSX global directly)
- No `async` keywords in either file
  </verify>
  <done>
Two new files exist in js/export/ with all shared utility functions and all three Excel export functions as named exports. Functions match current behavior exactly (verbatim extraction with parameterization).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Excel exports into UI modules and remove inline export code</name>
  <files>js/ui/flat-bom.js, js/ui/comparison.js, js/ui/hierarchy.js</files>
  <action>
Update each UI module to import from js/export/excel.js and replace inline export handlers with calls to the new functions.

**js/ui/flat-bom.js:**
1. Add import: `import { exportFlatBomExcel } from '../export/excel.js';`
2. Replace the entire exportExcelBtn click handler (lines 261-298) with:
   ```
   exportExcelBtn.addEventListener('click', () => {
       if (!state.flattenedBOM) return;
       exportFlatBomExcel(state.flattenedBOM, state.uploadedFilename, getRootPartNumber(), getRootRevision());
   });
   ```
3. The guard `if (!state.flattenedBOM) return;` stays in the UI module (UI concern, not export concern).

**js/ui/comparison.js:**
1. Add import: `import { exportComparisonExcel } from '../export/excel.js';`
2. Replace the entire exportCompareExcelBtn click handler (lines 628-681) with:
   ```
   exportCompareExcelBtn.addEventListener('click', () => {
       exportComparisonExcel(state.comparisonResults, sortComparisonResults, state.oldBomFilename, state.oldBomInfo, state.newBomFilename, state.newBomInfo);
   });
   ```
3. The `sortComparisonResults` function stays in comparison.js (it's used for both display rendering and export). Pass it as a parameter to the export function.

**js/ui/hierarchy.js:**
1. Add import: `import { exportHierarchyExcel } from '../export/excel.js';`
2. Replace the entire exportHierarchyExcelBtn click handler (lines 416-459) with:
   ```
   exportHierarchyExcelBtn.addEventListener('click', () => {
       const unitQty = parseInt(hierarchyUnitQtyInput.value) || 1;
       exportHierarchyExcel(state.hierarchyTree, state.hierarchyFilename, state.hierarchyRootInfo, unitQty);
   });
   ```
3. The `decimalToFractional` import can remain in hierarchy.js (it's also used in display rendering at line 277). excel.js will have its own import.

For each file, ensure:
- The inline export code is completely removed (not just commented out)
- The new import statement is added at the top with other imports
- The button handler guard clauses and data passing are correct
- No other code in the file is changed

IMPORTANT: Do NOT change comparison.js's sortComparisonResults function. It must remain in comparison.js because it's used by renderComparisonTable() for display. The export function receives it as a callback parameter.
  </action>
  <verify>
Run automated tests: `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js`

Expected result: Same test results as before (2/4 passing baseline maintained). Tests validate flat BOM and comparison Excel output against control files, so any Excel format change would be caught here.

Also verify:
- flat-bom.js has `import { exportFlatBomExcel }` and no inline XLSX code
- comparison.js has `import { exportComparisonExcel }` and no inline XLSX code in the Excel handler
- hierarchy.js has `import { exportHierarchyExcel }` and no inline XLSX code in the Excel handler
- No XLSX.utils references remain in any export Excel handler (only in export/excel.js now)
  </verify>
  <done>
All three UI modules import and call Excel export functions from js/export/excel.js. Inline Excel export code is removed. Automated tests pass at the same baseline (2/4). No behavioral changes.
  </done>
</task>

</tasks>

<verification>
1. `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` passes at 2/4 baseline
2. `js/export/shared.js` exists with 5 named exports
3. `js/export/excel.js` exists with 3 named exports
4. No `XLSX.utils.json_to_sheet` or `XLSX.utils.aoa_to_sheet` calls remain in any js/ui/*.js Excel button handlers
5. Date formatting code (`new Date()...getFullYear()...padStart`) is NOT duplicated in Excel handlers (only in shared.js and excel.js)
</verification>

<success_criteria>
- Two new files created: js/export/shared.js and js/export/excel.js
- Three UI modules updated with import+call pattern for Excel exports
- Automated tests pass at 2/4 baseline (zero regressions)
- Excel export logic fully extracted from UI modules
- Shared date/filename utilities reusable by Plan 02 (HTML exports)
</success_criteria>

<output>
After completion, create `.planning/phases/07-export-module-extraction/07-01-SUMMARY.md`
</output>
