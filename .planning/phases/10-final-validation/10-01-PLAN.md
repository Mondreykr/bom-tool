---
phase: 10-final-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/core/tree.js
  - js/ui/hierarchy.js
  - js/ui/comparison.js
autonomous: true

must_haves:
  truths:
    - "All 4 automated tests pass (4/4)"
    - "Hierarchy View still displays sorted tree (Component Type > Description > Length)"
    - "Comparison scoped selection tree still displays sorted"
    - "Flat BOM flattening is unaffected"
  artifacts:
    - path: "js/core/tree.js"
      provides: "buildTree without sorting, sortChildren as separate export"
      exports: ["buildTree", "sortChildren", "BOMNode", "getRootPartNumber", "getRootRevision", "getRootDescription", "resetRootInfo"]
    - path: "js/ui/hierarchy.js"
      provides: "Hierarchy View with explicit sortChildren call"
      contains: "sortChildren"
    - path: "js/ui/comparison.js"
      provides: "Comparison tree selection with explicit sortChildren call"
      contains: "sortChildren"
  key_links:
    - from: "js/ui/hierarchy.js"
      to: "js/core/tree.js"
      via: "import sortChildren"
      pattern: "sortChildren"
    - from: "js/ui/comparison.js"
      to: "js/core/tree.js"
      via: "import sortChildren"
      pattern: "sortChildren"
---

<objective>
Fix 2 automated test regressions by separating tree sorting from tree building.

Purpose: In Phase 4, sortChildren was added inside buildTree() to match the original HTML behavior. However, the test baselines were validated against code that did NOT sort before flattening (the Phase 1 modular code). The sort changes traversal order during flattening, causing different duplicate-part instances to populate the aggregation map first, producing different revision values (Test 1: part 1030098 revision "-" vs expected "0") and different descriptions (Test 2: parts 1011523/1016760 show spurious description changes). The fix: extract sortChildren from buildTree so flatten/compare use unsorted trees (matching baselines) while UI modules still sort for display.

Output: 4/4 tests passing, sorted tree display preserved in browser.
</objective>

<execution_context>
@C:/Users/amcallister/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/amcallister/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@js/core/tree.js
@js/ui/hierarchy.js
@js/ui/comparison.js
@test/run-tests.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract sortChildren from buildTree and export as standalone function</name>
  <files>js/core/tree.js</files>
  <action>
In js/core/tree.js, make two changes:

1. Move the sortChildren function definition OUT of buildTree and make it a top-level exported function. The function body stays identical -- it recursively sorts children by Component Type > Description > Length (decimal). Place it after the buildTree function.

```javascript
// Sort tree children recursively (for display purposes)
export function sortChildren(node) {
    if (node.children.length > 0) {
        node.children.sort((a, b) => {
            if (a.componentType !== b.componentType) {
                return a.componentType.localeCompare(b.componentType);
            }
            if (a.description !== b.description) {
                return a.description.localeCompare(b.description, undefined, {
                    numeric: true,
                    sensitivity: 'base'
                });
            }
            if (a.length === null && b.length === null) return 0;
            if (a.length === null) return 1;
            if (b.length === null) return -1;
            return a.length - b.length;
        });
        node.children.forEach(child => sortChildren(child));
    }
}
```

2. Remove the `sortChildren(root);` call AND the nested function definition from inside buildTree(). The buildTree function should go directly from "Get root" to "Capture root info" with no sorting step.

Do NOT change anything else in tree.js. The resetRootInfo, BOMNode, getRootPartNumber/Revision/Description exports all stay the same.
  </action>
  <verify>
Run: cd test && node run-tests.js
Expected: 4/4 tests pass. This single change should fix both Test 1 (REVISION MISMATCH) and Test 2 (CHANGED COUNT mismatch) because flattening now traverses the unsorted tree (matching baseline behavior).
  </verify>
  <done>4/4 automated tests pass. sortChildren is exported but no longer called inside buildTree.</done>
</task>

<task type="auto">
  <name>Task 2: Wire sortChildren into UI modules that display tree structures</name>
  <files>js/ui/hierarchy.js, js/ui/comparison.js</files>
  <action>
Two UI modules display tree structures and need sorted children for proper display. Flat BOM (flat-bom.js) only flattens and does NOT display tree structure -- skip it.

In js/ui/hierarchy.js:
1. Update the import line (line 6) to add sortChildren:
   `import { buildTree, sortChildren, getRootPartNumber, getRootRevision, getRootDescription, resetRootInfo } from '../core/tree.js';`
2. Find the buildTree call (line 138): `state.hierarchyTree = buildTree(state.hierarchyData);`
3. Add sortChildren call immediately after:
   `sortChildren(state.hierarchyTree);`

In js/ui/comparison.js:
1. Update the import line (line 3) to add sortChildren:
   `import { buildTree, sortChildren } from '../core/tree.js';`
2. Find the buildTree call (line 349): `tree = buildTree(rawData);`
3. Add sortChildren call immediately after (inside the try block, before the catch):
   `sortChildren(tree);`

Do NOT change any other logic. The sort is identical to what was previously inside buildTree -- we are just calling it explicitly in the modules that need it for display.
  </action>
  <verify>
1. cd test && node run-tests.js -- must still show 4/4 PASS (UI changes should not affect Node.js tests)
2. grep "sortChildren" js/ui/hierarchy.js -- should show import and call
3. grep "sortChildren" js/ui/comparison.js -- should show import and call
4. grep "sortChildren" js/ui/flat-bom.js -- should show NO results (flat-bom does not need tree sorting)
  </verify>
  <done>Hierarchy View and Comparison scoped selection both sort trees for display. Flat BOM unchanged. Tests still 4/4.</done>
</task>

</tasks>

<verification>
1. `cd test && node run-tests.js` -- 4/4 PASS (mandatory gate)
2. sortChildren exported from tree.js but NOT called inside buildTree
3. sortChildren called in hierarchy.js and comparison.js (display modules)
4. sortChildren NOT called in flat-bom.js (no tree display)
5. Browser re-verification deferred to Plan 02 (push to GitHub Pages first)
</verification>

<success_criteria>
- All 4 automated tests pass (4/4) -- zero tolerance, mandatory for VALID-01
- sortChildren available as exported function for UI code
- Hierarchy View and Comparison tree selection still display sorted children
- No changes to flatten.js, compare.js, parser.js, or utils.js
</success_criteria>

<output>
After completion, create `.planning/phases/10-final-validation/10-01-SUMMARY.md`
</output>
