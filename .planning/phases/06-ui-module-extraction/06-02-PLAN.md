---
phase: 06-ui-module-extraction
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - js/ui/comparison.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "Comparison tab file upload (old and new BOM, click and drag-drop) works identically"
    - "Scoped comparison tree selection works (click to select node, scope display updates)"
    - "Compare operation produces correct results with filtering"
    - "Comparison tab export functions (Excel and HTML) remain functional"
    - "Comparison tab reset (both scope reset and full reset) works identically"
    - "Change File links work for both old and new BOM"
    - "All automated tests pass with identical outputs"
    - "Zero Comparison tab logic remains inline in index.html"
  artifacts:
    - path: "js/ui/comparison.js"
      provides: "Comparison tab UI logic with init() function"
      exports: ["init"]
    - path: "index.html"
      provides: "Application with Comparison tab imported from module"
      contains: "import.*init.*from.*js/ui/comparison.js"
  key_links:
    - from: "index.html"
      to: "js/ui/comparison.js"
      via: "ES6 import + init() call in initializeUI"
      pattern: "import.*init.*from.*comparison.js"
    - from: "js/ui/comparison.js"
      to: "js/ui/state.js"
      via: "ES6 import"
      pattern: "import.*state.*from.*state.js"
    - from: "js/ui/comparison.js"
      to: "js/core/*.js"
      via: "ES6 imports"
      pattern: "import.*from.*core/"
---

<objective>
Extract all BOM Comparison tab UI logic (~1128 lines) from index.html into js/ui/comparison.js as an ES6 module with an exported init() function. This is the largest tab extraction — includes scoped comparison tree selection, dual file upload, filtering, and export handlers.

Purpose: Extract the most complex tab module. After this plan, only Hierarchy tab code remains inline in index.html.

Output: js/ui/comparison.js module, updated index.html with Comparison code removed and module imported.
</objective>

<execution_context>
@C:\Users\amcallister\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\amcallister\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ui-module-extraction/06-RESEARCH.md
@.planning/phases/06-ui-module-extraction/06-01-SUMMARY.md

Critical source files to read before starting:
@js/ui/state.js
@js/ui/flat-bom.js
@js/core/compare.js
@js/core/utils.js
@js/core/tree.js
@js/core/flatten.js
@js/core/parser.js
@index.html
@test/run-tests.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create js/ui/comparison.js module</name>
  <files>js/ui/comparison.js</files>
  <action>
Create js/ui/comparison.js containing all BOM Comparison tab UI logic wrapped in an exported init() function. ALL DOM element queries MUST be inside init() — never at module top level.

**Imports at top of file (module level):**
```javascript
import { state } from './state.js';
import { parseXML } from '../core/parser.js';
import { buildTree } from '../core/tree.js';
import { flattenBOM } from '../core/flatten.js';
import { compareBOMs, extractSubtree } from '../core/compare.js';
import { createDiff } from '../core/utils.js';
```

Note: Verify which utils/core functions are actually referenced in the Comparison section of index.html before finalizing imports. The Comparison tab does NOT use getRootPartNumber/etc (it uses state.oldBomInfo/newBomInfo directly). It does NOT use sortBOM (comparison results have their own sort). It uses createDiff for word-level diff highlighting.

**Structure of init():**

Export a single `init()` function containing ALL Comparison tab logic:

1. **DOM element caching** — Move ALL Comparison DOM element declarations inside init(). Read the current index.html to get the exact list. As of Phase 5, these include approximately 36 DOM element references:
   - Old BOM elements: oldBomZone, oldBomInput, oldBomFileInfo, oldBomFileName, oldBomFileMeta
   - New BOM elements: newBomZone, newBomInput, newBomFileInfo, newBomFileName, newBomFileMeta
   - Control elements: compareBtn, resetCompareBtn, resetScopeBtn, compareMessage, compareResults, compareBody, exportCompareExcelBtn, exportCompareHtmlBtn
   - Tree selection panel elements (old): oldBomTreePanel, oldBomPanelName, oldBomTreeContainer, oldBomSelectedDisplay, oldBomChangeFile, oldBomScopeDisplay
   - Tree selection panel elements (new): newBomTreePanel, newBomPanelName, newBomTreeContainer, newBomSelectedDisplay, newBomChangeFile, newBomScopeDisplay

2. **All event listeners** — Move ALL addEventListener calls from Comparison section inside init():
   - Old BOM upload zone: click, dragover, dragleave, drop
   - Old BOM file input: change
   - New BOM upload zone: click, dragover, dragleave, drop
   - New BOM file input: change
   - compareBtn click
   - resetCompareBtn click (full reset)
   - resetScopeBtn click (scope reset)
   - exportCompareExcelBtn click
   - exportCompareHtmlBtn click
   - oldBomChangeFile click
   - newBomChangeFile click
   - Filter buttons (document.querySelectorAll('.filter-btn'))

3. **All handler functions** — Move ALL functions from Comparison section inside init():
   - renderSelectionTree(tree, type)
   - renderSelectionNode(node, container, type, depth)
   - toggleSelectionChildren(parentRow, type)
   - handleNodeSelection(node, type)
   - updateSelectionDisplay(type)
   - handleCompareFile(type, file)
   - showCompareMessage(text, type)
   - The flatten and compare logic
   - displayComparisonResults()
   - sortComparisonResults(results)
   - renderComparisonTable()
   - All filtering logic
   - Excel export handler logic
   - HTML export handler logic
   - Both reset handler logic blocks (scope reset + full reset)
   - Both changeFile handler logic blocks

**Critical: This is a MECHANICAL MOVE. Preserve ALL existing behavior exactly.** No logic changes, no refactoring, no renaming. The only structural change is wrapping everything inside init().

**The Comparison section in index.html starts at the `// BOM COMPARISON - STATE & DOM ELEMENTS` comment and ends just before the `// HIERARCHY VIEW - STATE & DOM ELEMENTS` comment.** Read the actual current code carefully — the line numbers will have shifted after Plan 01 removed Flat BOM code.

**What NOT to include:**
- Tab switching logic
- Flat BOM code (already extracted in Plan 01)
- Hierarchy View code
  </action>
  <verify>
Verify the file was created and has correct structure:
```bash
node -e "import('./js/ui/comparison.js').then(m => console.log('Exports:', Object.keys(m))).catch(e => console.error(e.message))"
```
Run from project root. Expected output: `Exports: [ 'init' ]`

Verify imports are present:
```bash
grep -n "import.*from" js/ui/comparison.js
```
Expected: imports from state.js, parser.js, tree.js, flatten.js, compare.js, utils.js

Verify init function exists:
```bash
grep -n "export function init" js/ui/comparison.js
```
Expected: exactly 1 match

Verify no top-level DOM queries:
```bash
grep -n "document.getElementById\|document.querySelector" js/ui/comparison.js | head -5
```
Expected: all matches should have line numbers AFTER the `export function init()` line

Verify key functions are present:
```bash
grep -n "function renderSelectionTree\|function handleCompareFile\|function displayComparisonResults\|function renderComparisonTable\|function sortComparisonResults" js/ui/comparison.js
```
Expected: all 5 functions present
  </verify>
  <done>js/ui/comparison.js exists with a single exported init() function containing all Comparison tab logic (~1128 lines). All DOM queries are inside init(). Module imports state.js, parser.js, tree.js, flatten.js, compare.js, and utils.js.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Comparison module into index.html and remove inline code</name>
  <files>index.html</files>
  <action>
Update index.html to import and initialize the Comparison module, then remove all inline Comparison code.

**Step 1: Add comparison.js import**

After the existing flat-bom.js import line (added in Plan 01), add:
```javascript
import { init as initComparison } from './js/ui/comparison.js';
```

**Step 2: Update initializeUI function**

Find the `initializeUI` function (added in Plan 01) and add the Comparison init call:
```javascript
function initializeUI() {
    initFlatBom();
    initComparison();
}
```

**Step 3: Remove inline Comparison code**

Remove ALL Comparison inline code from index.html. This is the entire block from the `// BOM COMPARISON - STATE & DOM ELEMENTS` section header through to just before the `// HIERARCHY VIEW - STATE & DOM ELEMENTS` section header.

Specifically, remove everything between (and including):
- `// ========================================`
- `// BOM COMPARISON - STATE & DOM ELEMENTS`
through to (but NOT including):
- `// ========================================`
- `// HIERARCHY VIEW - STATE & DOM ELEMENTS`

This includes:
- Comparison state comment
- All Comparison DOM element declarations (oldBomZone through newBomScopeDisplay)
- All scoped comparison functions (renderSelectionTree, renderSelectionNode, toggleSelectionChildren, handleNodeSelection, updateSelectionDisplay)
- All file upload handlers and event listeners
- handleCompareFile function
- showCompareMessage function
- Flatten and compare logic
- displayComparisonResults, sortComparisonResults, renderComparisonTable
- Filter button logic
- All export handlers (Excel and HTML)
- Both reset handlers (scope reset + full reset)
- Both changeFile handlers

**Step 4: Remove Comparison-only core imports from index.html**

After removing Comparison code, check which core imports are still needed by the remaining Hierarchy tab code.

Hierarchy tab uses: parseXML, buildTree, getRootPartNumber, getRootRevision, getRootDescription, resetRootInfo, decimalToFractional

Hierarchy tab does NOT use: compareBOMs, extractSubtree, createDiff, flattenBOM, sortBOM, getParentLevel, getCompositeKey, parseLength

Remove these imports from index.html (they are no longer needed by any remaining inline code):
- `compareBOMs, extractSubtree` from compare.js import — remove the entire compare.js import line
- `flattenBOM, sortBOM` from flatten.js import — remove the entire flatten.js import line
- `createDiff` from utils.js import — BUT check if getCompositeKey, getParentLevel, parseLength are used by Hierarchy. If not, trim the utils import to only `decimalToFractional`. If none are used, consider which are still needed.

Actually — be CAREFUL here. Read the actual Hierarchy code to verify exactly which utils are used. The Hierarchy tab uses `decimalToFractional` for length display. Check if it uses any others. Do NOT remove imports that are still needed.

After removing unused imports, the remaining imports should be approximately:
```javascript
import { decimalToFractional } from './js/core/utils.js';
import { buildTree, getRootPartNumber, getRootRevision, getRootDescription, resetRootInfo } from './js/core/tree.js';
import { parseXML } from './js/core/parser.js';
import { state } from './js/ui/state.js';
import { init as initFlatBom } from './js/ui/flat-bom.js';
import { init as initComparison } from './js/ui/comparison.js';
```

Verify by searching the remaining inline code for any references to removed imports.

**Step 5: Run tests**
```bash
cd test && node run-tests.js
```
Expected: tests pass at same level as before.

**Step 6: Verify no Comparison logic remains inline**

Verify the Comparison DOM element IDs are NOT referenced in index.html JS anymore.
  </action>
  <verify>
1. Run tests: `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` — tests pass (same count as before)

2. Verify comparison.js import exists:
```bash
grep -n "import.*initComparison.*from.*comparison" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: exactly 1 match

3. Verify initializeUI calls both inits:
```bash
grep -n "initFlatBom\|initComparison" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: import lines + both calls in initializeUI

4. Verify Comparison DOM element declarations are gone:
```bash
grep -n "const oldBomZone\|const newBomZone\|const compareBtn\|const resetCompareBtn\|const compareBody" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 0 matches

5. Verify Comparison functions are gone:
```bash
grep -n "function renderSelectionTree\|function handleCompareFile\|function displayComparisonResults\|function showCompareMessage\|function renderComparisonTable" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 0 matches

6. Verify Hierarchy code still present:
```bash
grep -c "HIERARCHY VIEW" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: multiple matches

7. Verify compare.js and flatten.js imports are removed:
```bash
grep -n "import.*from.*compare.js\|import.*from.*flatten.js" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 0 matches (these are now only imported in comparison.js and flat-bom.js)
  </verify>
  <done>index.html imports and initializes comparison.js via initComparison() in initializeUI. All Comparison inline code removed from index.html. Unused core imports (compare.js, flatten.js) removed from index.html. Hierarchy code remains inline. Tests pass at same level as before.</done>
</task>

</tasks>

<verification>
1. All automated tests pass: `cd test && node run-tests.js` — same results as before
2. js/ui/comparison.js exists with single exported init() function
3. All DOM queries in comparison.js are inside init() (none at module top level)
4. index.html imports comparison.js and calls initComparison() in initializeUI
5. Zero Comparison handler functions remain in index.html
6. Zero Comparison DOM element declarations remain in index.html script tag
7. Hierarchy code still present and functional in index.html
8. Unused core imports removed from index.html (compare.js, flatten.js lines gone)
</verification>

<success_criteria>
- js/ui/comparison.js exports init() and contains all Comparison tab logic (~1128 lines)
- index.html initializeUI calls both initFlatBom() and initComparison()
- Zero Comparison functions/event listeners/DOM caching remain inline in index.html
- Hierarchy tab code untouched
- Tab switching code untouched
- compare.js and flatten.js imports removed from index.html (no longer needed inline)
- All automated tests pass with identical outputs to baseline
</success_criteria>

<output>
After completion, create `.planning/phases/06-ui-module-extraction/06-02-SUMMARY.md`
</output>
