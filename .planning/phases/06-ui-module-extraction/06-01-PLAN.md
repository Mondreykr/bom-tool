---
phase: 06-ui-module-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/ui/flat-bom.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "Flat BOM tab file upload (click and drag-drop) works identically"
    - "Flat BOM tab flatten operation produces correct results"
    - "Flat BOM tab reset clears all state and UI"
    - "Flat BOM tab export functions (Excel and HTML) remain functional"
    - "All 4 automated tests pass with identical outputs"
    - "Zero Flat BOM tab logic remains inline in index.html"
  artifacts:
    - path: "js/ui/flat-bom.js"
      provides: "Flat BOM tab UI logic with init() function"
      exports: ["init"]
    - path: "index.html"
      provides: "Application with Flat BOM tab imported from module"
      contains: "import.*init.*from.*js/ui/flat-bom.js"
  key_links:
    - from: "index.html"
      to: "js/ui/flat-bom.js"
      via: "ES6 import + init() call"
      pattern: "import.*init.*from.*flat-bom.js"
    - from: "js/ui/flat-bom.js"
      to: "js/ui/state.js"
      via: "ES6 import"
      pattern: "import.*state.*from.*state.js"
    - from: "js/ui/flat-bom.js"
      to: "js/core/*.js"
      via: "ES6 imports"
      pattern: "import.*from.*core/"
---

<objective>
Extract all Flat BOM tab UI logic (~612 lines) from index.html into js/ui/flat-bom.js as an ES6 module with an exported init() function. After this plan, index.html imports and calls initFlatBom() instead of containing inline Flat BOM code.

Purpose: First UI module extraction. Establishes the init() function pattern used by all three tab modules. Removes ~20% of remaining inline JavaScript from index.html.

Output: js/ui/flat-bom.js module, updated index.html with Flat BOM code removed and module imported.
</objective>

<execution_context>
@C:\Users\amcallister\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\amcallister\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ui-module-extraction/06-RESEARCH.md

Critical source files to read before starting:
@js/ui/state.js
@js/core/utils.js
@js/core/tree.js
@js/core/flatten.js
@js/core/parser.js
@index.html
@test/run-tests.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create js/ui/flat-bom.js module</name>
  <files>js/ui/flat-bom.js</files>
  <action>
Create js/ui/flat-bom.js containing all Flat BOM tab UI logic wrapped in an exported init() function. ALL DOM element queries MUST be inside init() (never at module top level) to avoid timing issues.

**Imports at top of file (module level):**
```javascript
import { state } from './state.js';
import { parseXML } from '../core/parser.js';
import { buildTree, getRootPartNumber, getRootRevision, getRootDescription, resetRootInfo } from '../core/tree.js';
import { flattenBOM, sortBOM } from '../core/flatten.js';
import { parseLength, decimalToFractional } from '../core/utils.js';
```

Note: parseLength and decimalToFractional are used in Flat BOM display/export code (fractional length display and Excel export). Verify which utils are actually referenced in the Flat BOM section of index.html before finalizing imports.

**Structure of init():**

Export a single `init()` function that contains:

1. **DOM element caching** — Move ALL `const xxxElement = document.getElementById('xxx')` lines from the Flat BOM section (index.html lines ~404-418) inside init(). These are:
   - uploadZone, fileInput (csvFile), fileInfo, fileNameDisplay (fileName), fileMeta, unitQtyInput (unitQty), flattenBtn, resetBtn, message, results, resultsBody, totalItems, unitQtyDisplay, exportExcelBtn, exportHtmlBtn

2. **Event listeners** — Move ALL addEventListener calls from Flat BOM section (index.html lines ~421-449) inside init():
   - uploadZone click (triggers fileInput.click())
   - uploadZone dragover
   - uploadZone dragleave
   - uploadZone drop (with file validation)
   - fileInput change
   - flattenBtn click -> handleFlatten
   - resetBtn click -> handleReset
   - exportExcelBtn click -> handleExportExcel (or whatever the current handler is)
   - exportHtmlBtn click -> handleExportHtml (or whatever the current handler is)

3. **Handler functions** — Move ALL functions from Flat BOM section inside init() as closures:
   - handleFile(file) — file reader, XML/CSV parsing, updates state and DOM
   - displayResults(items, unitQty) — renders result table, updates stats
   - showMessage(text, type) — displays status messages with auto-hide
   - Excel export handler — the entire exportExcelBtn click handler logic
   - HTML export handler — the entire exportHtmlBtn click handler logic
   - Reset handler — the resetBtn click handler logic (clears state + DOM)

**Critical: Preserve ALL existing behavior exactly.** This is a mechanical move — no logic changes, no refactoring, no renaming. The only changes are:
- Bare state variable names already use `state.xxx` pattern (done in Phase 5)
- Core functions already imported from modules (done in Phase 4)
- All DOM queries wrapped inside init() function scope
- All functions become closures inside init()

**What NOT to include:**
- Tab switching logic (stays in index.html)
- Comparison tab code
- Hierarchy tab code
- The import statements at the top of the current script block (those stay in index.html for now, only Flat BOM-specific imports move to this module)

**Scope:** Lines ~401-1013 of current index.html (Flat BOM section). Read the actual code carefully — the line numbers may have shifted from Phase 5 changes.
  </action>
  <verify>
Verify the file was created and has correct structure:
```bash
node -e "import('./js/ui/flat-bom.js').then(m => console.log('Exports:', Object.keys(m))).catch(e => console.error(e.message))"
```
Run from project root. Expected output: `Exports: [ 'init' ]`

Verify imports are present:
```bash
grep -n "import.*from" js/ui/flat-bom.js
```
Expected: imports from state.js, parser.js, tree.js, flatten.js, utils.js

Verify init function exists:
```bash
grep -n "export function init" js/ui/flat-bom.js
```
Expected: exactly 1 match

Verify no top-level DOM queries:
```bash
grep -n "document.getElementById\|document.querySelector" js/ui/flat-bom.js | head -5
```
Expected: all matches should have line numbers AFTER the `export function init()` line
  </verify>
  <done>js/ui/flat-bom.js exists with a single exported init() function containing all Flat BOM tab logic. All DOM queries are inside init(). Module imports state.js, parser.js, tree.js, flatten.js, and utils.js.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Flat BOM module into index.html and remove inline code</name>
  <files>index.html</files>
  <action>
Update index.html to import and initialize the Flat BOM module, then remove all inline Flat BOM code.

**Step 1: Add flat-bom.js import**

After the existing state.js import line (`import { state } from './js/ui/state.js';`), add:
```javascript
import { init as initFlatBom } from './js/ui/flat-bom.js';
```

**Step 2: Add DOMContentLoaded initialization**

After all the import statements (after the new flat-bom import), add the initialization pattern. This will be extended in Plans 02 and 03 to include Comparison and Hierarchy inits:

```javascript
// Initialize UI modules after DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeUI);
} else {
    initializeUI();
}

function initializeUI() {
    initFlatBom();
}
```

Place this BEFORE the Tab Switching section (`// ========================================` / `// TAB SYSTEM`). The tab switching code currently executes at module top level (not inside DOMContentLoaded), which works because `<script type="module">` is deferred by default. Keep tab switching code as-is for now.

**Step 3: Remove inline Flat BOM code**

Remove ALL Flat BOM inline code from index.html. This is the block starting from the Flat BOM state comment (approximately `// Flat BOM tab state: state.csvData...`) through the `showMessage` function closing brace, just before the Tab System section header.

Specifically, remove:
- The Flat BOM state comment line
- All DOM element const declarations (uploadZone through exportHtmlBtn)
- All event listener attachments (uploadZone.addEventListener through resetBtn)
- The handleFile function
- The displayResults function
- The showMessage function
- ALL export handler code (Excel and HTML export click handlers and their logic)
- The reset handler code

The section to remove starts after the core module imports + state import + flat-bom import + initializeUI block, and ends just before the `// TAB SYSTEM` comment block.

**Step 4: Remove Flat-BOM-only imports from index.html**

Check which imports in index.html are now ONLY used by Flat BOM code (and are already imported in flat-bom.js). After removing Flat BOM inline code, check if any core imports are still needed by the remaining Comparison or Hierarchy code.

Imports used by Comparison tab: parseXML, buildTree, flattenBOM, compareBOMs, extractSubtree, createDiff
Imports used by Hierarchy tab: parseXML, buildTree, getRootPartNumber, getRootRevision, getRootDescription, resetRootInfo, decimalToFractional

ALL current imports are still needed by remaining inline code (Comparison and Hierarchy). Do NOT remove any imports yet. They will be removed when Plans 02 and 03 extract the remaining tabs.

The only import to leave is the one we just added (flat-bom.js). Keep ALL existing core imports until Plans 02 and 03 remove them.

**Step 5: Run tests**
```bash
cd test && node run-tests.js
```
Expected: 4/4 tests pass (or 2/4 if that was the stable baseline — check STATE.md). The tests exercise core logic, not UI, so they should be unaffected.

**Step 6: Verify no Flat BOM logic remains inline**

Verify the following DOM element IDs are NOT referenced in index.html JS anymore (only in HTML markup):
- uploadZone, csvFile, fileInfo, fileName, fileMeta, unitQty, flattenBtn, resetBtn, message (the Flat BOM one), results, resultsBody, totalItems, unitQtyDisplay, exportExcelBtn, exportHtmlBtn

Note: Some of these IDs exist in the HTML markup — that's fine. The check is that no JAVASCRIPT code in the script tag references them anymore.
  </action>
  <verify>
1. Run tests: `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` — tests pass (same count as before)

2. Verify flat-bom.js import exists:
```bash
grep -n "import.*initFlatBom.*from.*flat-bom" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: exactly 1 match

3. Verify DOMContentLoaded initialization exists:
```bash
grep -n "initFlatBom\|initializeUI\|DOMContentLoaded" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: import line + initializeUI function with initFlatBom() call + DOMContentLoaded pattern

4. Verify Flat BOM DOM element declarations are gone from script:
```bash
grep -n "const uploadZone\|const fileInput\|const fileInfo\|const fileNameDisplay\|const fileMeta\|const unitQtyInput\|const flattenBtn\|const resetBtn " C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 0 matches (these now live in flat-bom.js)

5. Verify Flat BOM functions are gone:
```bash
grep -n "function handleFile\|function displayResults\|function showMessage" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 0 matches

6. Verify Comparison and Hierarchy code still present:
```bash
grep -c "BOM COMPARISON\|HIERARCHY VIEW" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: multiple matches (these tabs are still inline)

7. Verify all core imports still present (needed by remaining tabs):
```bash
grep -c "import.*from.*js/core/" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 5 (utils, tree, flatten, parser, compare — all still needed)
  </verify>
  <done>index.html imports and initializes flat-bom.js via initFlatBom() in DOMContentLoaded handler. All Flat BOM inline code (DOM elements, event listeners, handler functions, export handlers, reset handler) removed from index.html. Tab switching, Comparison, and Hierarchy code remain inline. All core imports retained for remaining tabs. Tests pass at same level as before.</done>
</task>

</tasks>

<verification>
1. All automated tests pass: `cd test && node run-tests.js` — same results as before
2. js/ui/flat-bom.js exists with single exported init() function
3. All DOM queries in flat-bom.js are inside init() (none at module top level)
4. index.html imports flat-bom.js and calls initFlatBom() in DOMContentLoaded handler
5. Zero Flat BOM handler functions remain in index.html (handleFile, displayResults, showMessage gone)
6. Zero Flat BOM DOM element declarations remain in index.html script tag
7. Comparison and Hierarchy code still present and functional in index.html
8. All core module imports still present in index.html (needed by remaining inline code)
</verification>

<success_criteria>
- js/ui/flat-bom.js exports init() and contains all Flat BOM tab logic (~612 lines)
- index.html has DOMContentLoaded pattern calling initFlatBom()
- Zero Flat BOM functions/event listeners/DOM caching remain inline in index.html
- Comparison tab code (lines ~1042-2169) untouched
- Hierarchy tab code (lines ~2172-3053) untouched
- Tab switching code untouched
- All automated tests pass with identical outputs to baseline
</success_criteria>

<output>
After completion, create `.planning/phases/06-ui-module-extraction/06-01-SUMMARY.md`
</output>
