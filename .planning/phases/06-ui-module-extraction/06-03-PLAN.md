---
phase: 06-ui-module-extraction
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - js/ui/hierarchy.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "Hierarchy tab file upload (click and drag-drop) works identically"
    - "Hierarchy tab tree rendering with connector lines works identically"
    - "Hierarchy tab expand/collapse individual nodes works"
    - "Hierarchy tab expand all / collapse all works"
    - "Hierarchy tab export functions (Excel and HTML with interactive toggles) remain functional"
    - "Hierarchy tab reset clears all state and UI"
    - "Tab switching between all three tabs works"
    - "All automated tests pass with identical outputs"
    - "Zero UI tab logic remains inline in index.html"
    - "All core module imports removed from index.html (only UI module imports remain)"
  artifacts:
    - path: "js/ui/hierarchy.js"
      provides: "Hierarchy View tab UI logic with init() function"
      exports: ["init"]
    - path: "index.html"
      provides: "Application with all three tabs imported from modules, zero inline UI logic"
      contains: "import.*init.*from.*js/ui/hierarchy.js"
  key_links:
    - from: "index.html"
      to: "js/ui/hierarchy.js"
      via: "ES6 import + init() call in initializeUI"
      pattern: "import.*init.*from.*hierarchy.js"
    - from: "js/ui/hierarchy.js"
      to: "js/ui/state.js"
      via: "ES6 import"
      pattern: "import.*state.*from.*state.js"
    - from: "js/ui/hierarchy.js"
      to: "js/core/*.js"
      via: "ES6 imports"
      pattern: "import.*from.*core/"
    - from: "index.html initializeUI"
      to: "all three tab modules"
      via: "init() calls after DOMContentLoaded"
      pattern: "initFlatBom.*initComparison.*initHierarchy"
---

<objective>
Extract all Hierarchy View tab UI logic (~882 lines) from index.html into js/ui/hierarchy.js, then finalize the index.html script block so it contains ONLY imports, the DOMContentLoaded initialization, and tab switching logic. After this plan, Phase 6 is complete — all three tabs operate as independent ES6 modules.

Purpose: Complete UI module extraction. index.html goes from ~2600 lines of inline JS to ~40 lines (imports + init + tab switching). Establishes clean module boundaries for Phase 7 (export extraction).

Output: js/ui/hierarchy.js module, finalized index.html with all tab logic extracted.
</objective>

<execution_context>
@C:\Users\amcallister\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\amcallister\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ui-module-extraction/06-RESEARCH.md
@.planning/phases/06-ui-module-extraction/06-02-SUMMARY.md

Critical source files to read before starting:
@js/ui/state.js
@js/ui/flat-bom.js
@js/ui/comparison.js
@js/core/tree.js
@js/core/parser.js
@js/core/utils.js
@index.html
@test/run-tests.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create js/ui/hierarchy.js module</name>
  <files>js/ui/hierarchy.js</files>
  <action>
Create js/ui/hierarchy.js containing all Hierarchy View tab UI logic wrapped in an exported init() function. ALL DOM element queries MUST be inside init() — never at module top level.

**Imports at top of file (module level):**
```javascript
import { state } from './state.js';
import { parseXML } from '../core/parser.js';
import { buildTree, getRootPartNumber, getRootRevision, getRootDescription, resetRootInfo } from '../core/tree.js';
import { decimalToFractional } from '../core/utils.js';
```

Note: Verify which utils/core functions are actually referenced in the Hierarchy section of index.html before finalizing imports. The Hierarchy tab uses decimalToFractional for length display in both the live tree and HTML export. Check if it uses parseLength or any other utils.

**Structure of init():**

Export a single `init()` function containing ALL Hierarchy tab logic:

1. **DOM element caching** — Move ALL Hierarchy DOM element declarations inside init(). Read the current index.html to get the exact list (after Plan 02 removed Comparison code). As of Phase 5, these include approximately 20 DOM element references:
   - hierarchyUploadZone, hierarchyFileInput, hierarchyFileInfo, hierarchyFileName, hierarchyFileMeta
   - hierarchyMessage, viewHierarchyBtn, resetHierarchyBtn
   - hierarchyResults, hierarchyTreeBody, hierarchyFilenameDisplay
   - hierarchyAssemblyPartNumDesc, hierarchyAssemblyRev
   - hierarchyUnitQtyInput, hierarchyUnitQtyDisplay
   - hierarchyExpandAllBtn, hierarchyCollapseAllBtn
   - exportHierarchyExcelBtn, exportHierarchyHtmlBtn

2. **All event listeners** — Move ALL addEventListener calls from Hierarchy section inside init():
   - Upload zone: click, dragover, dragleave, drop
   - File input: change
   - viewHierarchyBtn click
   - resetHierarchyBtn click
   - hierarchyExpandAllBtn click
   - hierarchyCollapseAllBtn click
   - exportHierarchyExcelBtn click
   - exportHierarchyHtmlBtn click

3. **All handler functions** — Move ALL functions from Hierarchy section inside init():
   - handleHierarchyFile(file) — file reader, XML/CSV parsing
   - showHierarchyMessage(text, type) — status messages
   - displayHierarchyTree(root) — tree rendering entry point
   - renderTreeNode(node, container, depth, isLastChild, ancestorContinues, unitQty) — recursive tree node rendering with connector lines
   - toggleChildren(parentRow) — expand/collapse individual nodes
   - Expand all handler logic
   - Collapse all handler logic
   - Excel export handler logic (with traverseForExport function)
   - HTML export handler logic (with generateTreeHTML function and inline toggleNode script)
   - Reset handler logic

**Critical notes for Hierarchy extraction:**

a) The `renderTreeNode` function uses `addEventListener('click', ...)` for tree toggles (NOT inline onclick). The toggle handler calls `toggleChildren(row)`. This is already modern — no inline onclick to modernize in the live tree view.

b) The HTML export's `generateTreeHTML` function generates an `onclick="toggleNode(this)"` attribute AND an inline `<script>` block containing a `toggleNode` function. This is CORRECT for the exported HTML file (it needs to be self-contained). Do NOT change this — it's part of the export output, not the live app.

c) The HTML export handler builds a complete standalone HTML document string with embedded CSS and JavaScript. Move this entire block as-is into init().

d) The `resetRootInfo()` call is used in both Flat BOM reset (already in flat-bom.js) and potentially in Hierarchy reset. Check whether the Hierarchy reset handler calls `resetRootInfo()`. If not, do not add it. The Hierarchy tab stores root info in `state.hierarchyRootInfo`, which is separate from the tree.js root info used by Flat BOM.

**This is a MECHANICAL MOVE. Preserve ALL existing behavior exactly.** No logic changes, no refactoring, no renaming.

**The Hierarchy section starts at the `// HIERARCHY VIEW - STATE & DOM ELEMENTS` comment and ends at `</script>`.** Read the actual current code — line numbers will have shifted after Plans 01 and 02.
  </action>
  <verify>
Verify the file was created and has correct structure:
```bash
node -e "import('./js/ui/hierarchy.js').then(m => console.log('Exports:', Object.keys(m))).catch(e => console.error(e.message))"
```
Run from project root. Expected output: `Exports: [ 'init' ]`

Verify imports are present:
```bash
grep -n "import.*from" js/ui/hierarchy.js
```
Expected: imports from state.js, parser.js, tree.js, utils.js

Verify init function exists:
```bash
grep -n "export function init" js/ui/hierarchy.js
```
Expected: exactly 1 match

Verify no top-level DOM queries:
```bash
grep -n "document.getElementById\|document.querySelector" js/ui/hierarchy.js | head -5
```
Expected: all matches should have line numbers AFTER the `export function init()` line

Verify key functions are present:
```bash
grep -n "function renderTreeNode\|function toggleChildren\|function displayHierarchyTree\|function handleHierarchyFile\|function generateTreeHTML" js/ui/hierarchy.js
```
Expected: all 5 functions present
  </verify>
  <done>js/ui/hierarchy.js exists with a single exported init() function containing all Hierarchy tab logic (~882 lines). All DOM queries are inside init(). Module imports state.js, parser.js, tree.js, and utils.js.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Hierarchy module into index.html, remove inline code, and finalize script block</name>
  <files>index.html</files>
  <action>
Update index.html to import and initialize the Hierarchy module, remove all inline Hierarchy code, remove all remaining core imports, and verify the final script block is clean.

**Step 1: Add hierarchy.js import**

After the existing comparison.js import line, add:
```javascript
import { init as initHierarchy } from './js/ui/hierarchy.js';
```

**Step 2: Update initializeUI function**

Add the Hierarchy init call:
```javascript
function initializeUI() {
    initFlatBom();
    initComparison();
    initHierarchy();
}
```

**Step 3: Remove inline Hierarchy code**

Remove ALL Hierarchy inline code from index.html. This is the entire block from the `// HIERARCHY VIEW - STATE & DOM ELEMENTS` section header through to the closing `</script>` tag (but keep the `</script>` tag itself).

Remove everything from:
- `// ========================================`
- `// HIERARCHY VIEW - STATE & DOM ELEMENTS`
through to (but NOT including):
- `</script>`

**Step 4: Remove ALL remaining core imports from index.html**

After removing Hierarchy code, the ONLY remaining inline JS should be:
- UI module imports (flat-bom.js, comparison.js, hierarchy.js)
- state.js import
- The DOMContentLoaded/initializeUI pattern
- Tab switching code

Remove ALL core module imports that are no longer needed:
- `import { decimalToFractional, ... } from './js/core/utils.js';` — REMOVE (was only used by Hierarchy tab, now in hierarchy.js)
- `import { buildTree, getRootPartNumber, ... } from './js/core/tree.js';` — REMOVE (was only used by Hierarchy tab, now in hierarchy.js)
- `import { parseXML } from './js/core/parser.js';` — REMOVE (was only used by Hierarchy tab, now in hierarchy.js)

Also remove the state.js import from the main script block IF it is no longer referenced directly by any remaining inline code (tab switching does not use state). However — check if the DOMContentLoaded handler or tab switching code references `state`. If not, remove the state.js import (each UI module imports state.js directly).

**Step 5: Verify final script block**

After all removals, the entire `<script type="module">` block should contain approximately:

```javascript
import { init as initFlatBom } from './js/ui/flat-bom.js';
import { init as initComparison } from './js/ui/comparison.js';
import { init as initHierarchy } from './js/ui/hierarchy.js';

// Initialize UI modules after DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeUI);
} else {
    initializeUI();
}

function initializeUI() {
    initFlatBom();
    initComparison();
    initHierarchy();

    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.dataset.tab;
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            tabContents.forEach(content => {
                if (content.id === targetTab + 'Tab') {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        });
    });
}
```

This is approximately 30-35 lines. The tab switching logic moves INSIDE the initializeUI function so it also benefits from the DOMContentLoaded guard (even though module scripts are deferred, this is cleaner and consistent).

IMPORTANT: If the tab switching code was previously at module top level (not inside any function), move it inside initializeUI(). This ensures all DOM-dependent code runs after DOMContentLoaded, consistent with the pattern.

**Step 6: Run tests**
```bash
cd test && node run-tests.js
```
Expected: tests pass at same level as before.

**Step 7: Final verification of script block cleanliness**

Count the lines in the script block to verify it is minimal (~30-35 lines). No function definitions except initializeUI. No DOM element declarations outside initializeUI. No handler functions. No export logic.
  </action>
  <verify>
1. Run tests: `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` — tests pass (same count as before)

2. Verify hierarchy.js import exists:
```bash
grep -n "import.*initHierarchy.*from.*hierarchy" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: exactly 1 match

3. Verify initializeUI calls all three inits:
```bash
grep -n "initFlatBom\|initComparison\|initHierarchy" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 3 import lines + 3 calls in initializeUI = 6 matches

4. Verify ALL core imports removed:
```bash
grep -n "import.*from.*js/core/" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 0 matches (all core imports now in UI modules only)

5. Verify state.js import removed (if not used by remaining inline code):
```bash
grep -n "import.*state.*from.*state.js" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 0 matches (state is imported by each UI module directly)

6. Verify NO Hierarchy functions remain:
```bash
grep -n "function renderTreeNode\|function toggleChildren\|function handleHierarchyFile\|function displayHierarchyTree\|function generateTreeHTML\|function showHierarchyMessage" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 0 matches

7. Verify NO Hierarchy DOM element declarations remain:
```bash
grep -n "const hierarchyUploadZone\|const hierarchyFileInput\|const hierarchyTreeBody\|const viewHierarchyBtn" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 0 matches

8. Verify script block is small:
```bash
grep -c "" C:/Users/amcallister/Projects/bom-tool/index.html
```
Compare total line count to pre-Phase-6 (was ~3055 lines). Should be approximately 430 lines (HTML + minimal script).

9. Verify only UI module imports remain in script block:
```bash
grep -n "import.*from" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: 3 imports (flat-bom.js, comparison.js, hierarchy.js) — no core or state imports

10. Verify tab switching logic present:
```bash
grep -n "tab-btn\|tabBtns\|tabContents\|data-tab" C:/Users/amcallister/Projects/bom-tool/index.html
```
Expected: matches in both HTML markup and script block
  </verify>
  <done>index.html imports and initializes all three UI modules via initializeUI() in DOMContentLoaded handler. All Hierarchy inline code removed. All core module imports removed (no js/core/ imports in index.html). state.js import removed (each UI module imports directly). Script block contains only 3 UI module imports, DOMContentLoaded init, and tab switching (~30-35 lines of JS). Total index.html reduced from ~3055 lines to ~430 lines. Tests pass at same level as before.</done>
</task>

</tasks>

<verification>
1. All automated tests pass: `cd test && node run-tests.js` — same results as before
2. js/ui/hierarchy.js exists with single exported init() function
3. All DOM queries in hierarchy.js are inside init()
4. index.html has 3 UI module imports, DOMContentLoaded init pattern, and tab switching
5. ZERO core module imports remain in index.html (no js/core/ imports)
6. ZERO handler functions remain in index.html
7. ZERO DOM element declarations remain in index.html (outside of tab switching)
8. Tab switching still works (inside initializeUI function)
9. index.html script block is ~30-35 lines total
10. All three UI module files exist: js/ui/flat-bom.js, js/ui/comparison.js, js/ui/hierarchy.js
</verification>

<success_criteria>
- js/ui/hierarchy.js exports init() and contains all Hierarchy tab logic (~882 lines)
- index.html initializeUI calls initFlatBom(), initComparison(), initHierarchy()
- Tab switching logic inside initializeUI (DOMContentLoaded-safe)
- Zero core imports remain in index.html (all moved to UI modules)
- Zero state import in index.html (each UI module imports state directly)
- Zero tab-specific logic remains inline in index.html
- Script block is ~30-35 lines (imports + init + tab switching)
- index.html reduced from ~3055 lines to ~430 lines
- All automated tests pass with identical outputs to baseline
- Phase 6 complete: all four requirements (UI-01 through UI-04) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-ui-module-extraction/06-03-SUMMARY.md`
</output>
