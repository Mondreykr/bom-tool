---
phase: 13-validation-system
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - docs/validation-logic.md
autonomous: true

must_haves:
  truths:
    - "Validation logic document captures all rules including ones BOM Tool does not enforce"
    - "Document serves as single source of truth for BOM validation logic across PDM custom solutions"
    - "Logic table matches the validated implementation in validate.js"
  artifacts:
    - path: "docs/validation-logic.md"
      provides: "Complete validation logic reference"
      min_lines: 80
      contains: "NS Item Type"
  key_links:
    - from: "docs/validation-logic.md"
      to: "js/core/validate.js"
      via: "documents the same rules implemented in code"
      pattern: "Rule 0|Rule 1|Rule 2"
---

<objective>
Create a validation logic reference document that captures the full BOM validation logic table, including rules enforced by the BOM Tool AND rules relevant to PDM-NS integration that the tool does not enforce.

Purpose: Per user request, this document serves as a single source of truth for all BOM validation logic, usable when building future PDM custom solutions. It captures both what the BOM Tool checks and what PDM should check but currently does not.

Output: `docs/validation-logic.md` — complete reference document.
</objective>

<execution_context>
@C:/Users/amcallister/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/amcallister/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-validation-system/13-CONTEXT.md
@.planning/phases/13-validation-system/13-01-SUMMARY.md
@js/core/validate.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation logic reference document</name>
  <files>docs/validation-logic.md</files>
  <action>
Create `docs/validation-logic.md` with the following structure. This is a REFERENCE DOCUMENT, not code documentation. Write it for an audience of engineers who work with PDM and NetSuite, not developers.

**Document structure:**

# BOM Validation Logic Reference

Brief intro: This document captures the complete validation logic for IFP BOM artifacts. It covers rules enforced by the BOM Tool and rules relevant to PDM-NS integration that require manual or future automated enforcement.

## Terminology

Define key terms:
- **GA (General Assembly)**: Root node of the BOM tree
- **X(n)**: Current source export from PDM (XML)
- **B(n-1)**: Prior IFP artifact (JSON)
- **B(n)**: New IFP artifact produced by merge
- **Released**: State is "Issued for Purchasing" (IFP) or "Issued for Use" (IFU)
- **WIP (Work In Progress)**: Any state other than IFP or IFU
- **NS Item Type**: The authoritative field for determining node type (Assembly vs non-assembly). Do NOT use Component Type for this purpose.
- **Graft point**: A WIP assembly where the merge engine substitutes content from B(n-1)

## Assembly Identification

Explain that NS Item Type is the authoritative field:
- `NS Item Type = Assembly` -> assembly node (has children)
- `NS Item Type = Inventory` or `Lot Numbered Inventory` -> non-assembly node (leaf)
- `Component Type` is NOT reliable for this purpose. Real PDM data has cases where `Component Type = Manufactured` but `NS Item Type = Assembly` and the item has children.

## Validation Rules (Enforced by BOM Tool)

### Rule 0: GA Must Be Released
- If GA root has WIP state, merge is blocked
- Applies to all revisions (REV0 through REVn)
- Error: "GA {PN} has WIP state '{state}' — Release GA in PDM before creating IFP artifact"

### Rule 1: No WIP Non-Assembly Items Under Released Assemblies
- Any non-assembly child (NS Item Type != Assembly) of a Released assembly that has WIP state blocks the merge
- PDM does not enforce this for IFP state — the BOM Tool catches it
- Error includes full path, part number, and fix action
- Applied recursively at every depth

### Rule 2: Released Assembly Must Have Released Content
- If a Released assembly contains ONLY sub-assembly children (no non-assembly items) AND all sub-assemblies are WIP, merge is blocked
- Rationale: A Released assembly with no usable content cannot produce a meaningful IFP artifact section
- A Released assembly with at least one Released child (non-assembly or sub-assembly) is valid; WIP sub-assemblies become graft points

### Missing NS Item Type
- If any node is missing the NS Item Type field, merge is blocked
- Cannot determine if node is assembly or non-assembly without this field

## Validation Logic Table

Full table from CONTEXT.md:

| Parent State | Child NS Item Type | Child State | Valid? | Action |
|---|---|---|---|---|
| Released | Non-assembly | Released | YES | Pass through (current) |
| Released | Non-assembly | WIP | **NO** | Block — Rule 1 |
| Released | Assembly | Released | YES | Continue checking children |
| Released | Assembly | WIP | YES* | Graft point / empty placeholder |
| WIP | any | any | N/A | WIP parent is graft point; children from B(n-1) |

*Valid only if parent has at least one other released child. If ALL children are WIP sub-assemblies with no non-assembly items -> Block (Rule 2).

## Error Handling

- All errors collected before blocking (full tree walk)
- Each error includes: full ancestor path, part number, rule violated, suggested fix action
- Multiple errors displayed as flat numbered list
- Validation runs on file load (before merge attempt)
- Loading new file auto-clears previous errors

## Rules NOT Enforced by BOM Tool (Future PDM Custom Solutions)

### WIP Assembly Metadata Reliability
- WIP sub-assemblies that become graft points may have unreliable metadata in the PDM export (Part Number, UoM, NS Item Type, Description, Component Type)
- The BOM Tool uses the graft content from B(n-1), which has approved metadata, so this does not affect merge output
- However, PDM-NS integration that reads the WIP export directly would be affected
- **Future enforcement:** A PDM custom solution should block BOM issuance when child assembly metadata fields are missing or inaccurate

### Component Type Consistency
- Component Type field values sometimes do not match the actual NS Item Type
- Example: `Component Type = Manufactured` but `NS Item Type = Assembly`
- This does not affect the BOM Tool (which uses NS Item Type), but could confuse other PDM workflows
- **Future enforcement:** PDM data quality check to align Component Type with NS Item Type

## Revision Behavior

- Same validation rules apply to ALL revisions (REV0 through REVn)
- The only difference is the consequence of finding a WIP assembly:
  - REV0 (no prior artifact): WIP assembly becomes empty placeholder
  - REV1+ (has B(n-1)): WIP assembly content grafted from prior artifact
- Validation happens BEFORE the merge, so the rules are identical regardless of revision

## Document History

| Date | Change |
|---|---|
| {today's date} | Initial version — captures rules as implemented in BOM Tool v2.2 |

Include a note at the bottom: "This document is a reference for engineering and PDM administration. It is NOT auto-generated from code. Update this document when validation rules change."
  </action>
  <verify>
Verify file exists and contains key sections:
- `grep "Rule 0" docs/validation-logic.md` returns match
- `grep "Rule 1" docs/validation-logic.md` returns match
- `grep "Rule 2" docs/validation-logic.md` returns match
- `grep "NS Item Type" docs/validation-logic.md` returns match
- `grep "NOT Enforced" docs/validation-logic.md` returns match
- File is at least 80 lines
  </verify>
  <done>
docs/validation-logic.md exists as a complete reference document covering all validation rules (enforced and not enforced), the logic table, error handling approach, and notes for future PDM custom solutions.
  </done>
</task>

</tasks>

<verification>
1. `docs/validation-logic.md` exists with all required sections
2. Logic table in document matches the implementation in `js/core/validate.js`
3. Document covers both BOM Tool rules and future PDM-NS integration rules
4. No code changes — all tests still pass from Plan 13-01
</verification>

<success_criteria>
- Validation logic reference document serves as single source of truth for BOM validation rules
- Document covers rules enforced by BOM Tool AND rules for future PDM custom solutions
- Non-technical audience (engineers, PDM admins) can understand the document without reading code
</success_criteria>

<output>
After completion, create `.planning/phases/13-validation-system/13-02-SUMMARY.md`
</output>
