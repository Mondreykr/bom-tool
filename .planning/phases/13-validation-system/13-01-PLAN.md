---
phase: 13-validation-system
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - js/core/validate.js
  - js/core/merge.js
  - test/validation-tests.js
  - test/merge-tests.js
autonomous: true

must_haves:
  truths:
    - "WIP non-assembly item under Released assembly blocks merge with descriptive error"
    - "WIP GA root blocks merge with descriptive error"
    - "Released assembly with only WIP sub-assembly children (no non-assembly items) blocks merge"
    - "Missing NS Item Type on any node blocks merge with error"
    - "All validation errors collected before blocking (full tree walk)"
    - "Assembly identification uses nsItemType field, not componentType"
    - "Existing merge engine behavior unchanged after refactor (19 merge tests pass)"
  artifacts:
    - path: "js/core/validate.js"
      provides: "isAssembly, validateBOM exports"
      exports: ["isAssembly", "validateBOM"]
    - path: "test/validation-tests.js"
      provides: "Tests for all validation rules"
      min_lines: 200
    - path: "js/core/merge.js"
      provides: "Refactored to use isAssembly from validate.js"
      contains: "isAssembly"
  key_links:
    - from: "js/core/validate.js"
      to: "js/core/merge.js"
      via: "isAssembly import"
      pattern: "import.*isAssembly.*validate"
    - from: "js/core/merge.js"
      to: "js/core/validate.js"
      via: "isAssembly used for assembly detection"
      pattern: "isAssembly\\("
    - from: "test/validation-tests.js"
      to: "js/core/validate.js"
      via: "import validateBOM, isAssembly"
      pattern: "import.*validateBOM.*validate"
---

<objective>
Implement pre-merge validation system that blocks invalid BOM merges and fix assembly identification to use NS Item Type field.

Purpose: Safety checks prevent producing invalid IFP artifacts. Assembly identification must use the authoritative `nsItemType` field (not `componentType`) per locked user decision based on real PDM data where Component Type is unreliable.

Output: New `js/core/validate.js` module with `isAssembly()` and `validateBOM()`, refactored `merge.js` using `isAssembly()`, comprehensive test suite.
</objective>

<execution_context>
@C:/Users/amcallister/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/amcallister/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-validation-system/13-CONTEXT.md
@.planning/phases/11-core-merge-engine/11-01-SUMMARY.md
@js/core/merge.js
@js/core/tree.js
@test/merge-tests.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for validation rules and assembly identification</name>
  <files>test/validation-tests.js</files>
  <action>
Create `test/validation-tests.js` following the exact same test harness pattern used in `test/merge-tests.js` (runTest function, makeNode helper, assertion-based error collection).

The `makeNode` helper in this file should accept an `nsItemType` parameter (default: based on componentType for backward compat). Use `nsItemType` values from real PDM data:
- `'Assembly'` for assemblies (NS Item Type = Assembly)
- `'Inventory'` for parts/inventory items (NS Item Type = Inventory)
- `'Lot Numbered Inventory'` for lot-tracked items

Import from `../js/core/validate.js`: `isAssembly`, `validateBOM`

Write these tests (all MUST fail initially since validate.js does not exist yet):

**isAssembly tests:**
1. `isAssembly` returns true for node with nsItemType = 'Assembly'
2. `isAssembly` returns false for node with nsItemType = 'Inventory'
3. `isAssembly` returns false for node with nsItemType = 'Lot Numbered Inventory'
4. `isAssembly` returns false for node with nsItemType = undefined/null/empty

**validateBOM tests (Rule 0 — WIP GA):**
5. WIP GA root (state not IFP/IFU) returns error: blocks merge. Error message must include part number and suggested fix ("Release GA {PN} in PDM before creating IFP artifact").
6. Released GA root with all Released children returns empty errors array (valid).

**validateBOM tests (Rule 1 — WIP non-assembly under Released parent):**
7. Released assembly with WIP non-assembly child (nsItemType = 'Inventory') returns error. Error message must include full path ("GA > Assy A > Part X"), the issue ("WIP non-assembly item under released assembly"), and suggested fix ("Release Part X in PDM before creating IFP artifact").
8. Released assembly with Released non-assembly child returns no errors.
9. Multiple WIP non-assembly items under different Released parents — ALL errors collected (not just first).

**validateBOM tests (Rule 2 — Released assembly with only WIP sub-assemblies):**
10. Released assembly with ONLY sub-assembly children (no non-assembly items) where ALL sub-assemblies are WIP returns error. Error message must include the parent assembly path and issue ("Released assembly has no released content — all sub-assemblies are WIP").
11. Released assembly with one WIP sub-assembly and one Released sub-assembly — valid (at least one released child).
12. Released assembly with one WIP sub-assembly and one Released non-assembly — valid (has released content).

**validateBOM tests (Missing NS Item Type):**
13. Node with missing nsItemType (undefined/null/empty string) returns error: "Missing NS Item Type on {PN} at {path} — cannot validate without knowing node type".

**validateBOM tests (Completeness):**
14. Tree with MULTIPLE violations (WIP GA + WIP parts + missing nsItemType) returns ALL errors, not just the first one found. Verify errors array length >= 3.
15. Deep tree (L3) with WIP non-assembly under Released assembly at depth — error includes full path showing all ancestors.

**validateBOM return shape:**
validateBOM(rootNode) returns `{ valid: boolean, errors: Array<{message: string, path: string, rule: string}> }`
- `valid`: false if any errors, true if none
- `errors`: array of error objects with message (human-readable), path (ancestor chain), rule (which rule: 'wip-ga', 'wip-non-assembly', 'no-released-content', 'missing-ns-item-type')

Run tests with: `node test/validation-tests.js`
All tests MUST fail (validate.js does not exist yet).
  </action>
  <verify>Run `node test/validation-tests.js` — all 15 tests should fail (module not found or function not defined). Zero tests should pass.</verify>
  <done>15 failing tests exist in test/validation-tests.js covering isAssembly, Rule 0, Rule 1, Rule 2, missing NS Item Type, and error completeness.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Implement validate.js, refactor merge.js to use isAssembly</name>
  <files>js/core/validate.js, js/core/merge.js, test/merge-tests.js</files>
  <action>
**Part A: Create js/core/validate.js**

Create new module with two exports:

`isAssembly(node)`:
- Returns true if `node.nsItemType === 'Assembly'`, false otherwise.
- Handles undefined/null/empty string — all return false.
- This is the SINGLE authoritative assembly check for the entire codebase. Per locked user decision: "Use NS Item Type field as the authoritative assembly identifier, NOT Component Type."

`validateBOM(rootNode)`:
- Walks entire tree recursively, collecting ALL errors before returning.
- Returns `{ valid: boolean, errors: Array<{message, path, rule}> }`.
- Import `isReleased` from `./merge.js` for state checking.

Validation logic (applied recursively):

1. **Rule 0 — WIP GA:** Check root node. If `!isReleased(rootNode.state)`, add error with rule 'wip-ga', include PN and suggested fix.

2. **Recursive walk:** For each node, track the ancestor path as a string ("GA > Assy A > Assy B"). At each node:
   a. If node is missing nsItemType (undefined, null, or empty string ''), add error with rule 'missing-ns-item-type'.
   b. If node is a Released assembly (isAssembly AND isReleased):
      - Check each child:
        - If child is NOT an assembly (`!isAssembly(child)`) AND child is WIP (`!isReleased(child.state)`): add error with rule 'wip-non-assembly'. Include full path, child PN, and suggested fix.
      - After checking all children, apply Rule 2: If ALL children are assemblies (no non-assembly items) AND all are WIP, add error with rule 'no-released-content'.
      - Recurse into Released assembly children (WIP assembly children are graft points — don't recurse into them, their content comes from B(n-1)).
   c. If node is a WIP assembly: Do NOT recurse (this is a graft point; children will come from B(n-1)).

3. Return `{ valid: errors.length === 0, errors }`.

**Part B: Refactor merge.js to use isAssembly**

Add import at top of merge.js:
```javascript
import { isAssembly } from './validate.js';
```

Replace ALL 6 occurrences of `node.componentType === 'Assembly'` (or `sourceNode.componentType === 'Assembly'` or `child.componentType === 'Assembly'`) with `isAssembly(node)` (or `isAssembly(sourceNode)` or `isAssembly(child)`).

Specific locations to change in merge.js:
- `buildPNIndex` line ~28: `if (node.componentType === 'Assembly')` -> `if (isAssembly(node))`
- `createPlaceholder` line ~83: keep `componentType: 'Assembly'` in the hardcoded placeholder (this is output data, not detection) BUT also add `nsItemType: sourceNode.nsItemType` to preserve the field
- `collectAllAssemblyPNs` line ~144: `if (node.componentType === 'Assembly')` -> `if (isAssembly(node))`
- `walkAndMerge` line ~198: `if (sourceNode.componentType === 'Assembly' && ...)` -> `if (isAssembly(sourceNode) && ...)`
- `walkAndMerge` line ~243: `if (sourceNode.componentType === 'Assembly')` -> `if (isAssembly(sourceNode))`
- `walkAndMerge` line ~249: `if (child.componentType === 'Assembly')` -> `if (isAssembly(child))`

**Part C: Update merge-tests.js makeNode helper**

The existing `makeNode` helper already sets `nsItemType` correctly:
```javascript
'NS Item Type': componentType === 'Assembly' ? 'Assembly Item' : 'Inventory Item',
```

But the actual PDM value for assemblies is `'Assembly'` (not `'Assembly Item'`). Fix the mapping:
- `componentType === 'Assembly'` -> nsItemType should be `'Assembly'` (not `'Assembly Item'`)
- Everything else -> nsItemType should be `'Inventory'` (not `'Inventory Item'`)

This matches real PDM XML data where:
- `NS Item Type` value `"Assembly"` for assemblies
- `NS Item Type` value `"Inventory"` for parts

**Part D: Verify everything**

Run all test suites:
1. `node test/validation-tests.js` — all 15 new tests pass
2. `node test/merge-tests.js` — all 19 existing tests pass (no regressions from isAssembly refactor)
3. `cd test && node run-tests.js` — all 4 baseline tests pass

If any merge tests fail after the refactor, the issue is likely the nsItemType value mismatch in makeNode. Fix makeNode to use the correct values that match what isAssembly expects.
  </action>
  <verify>
Run all three test suites:
- `node test/validation-tests.js` — 15 pass
- `node test/merge-tests.js` — 19 pass (zero regressions)
- `cd C:/Users/amcallister/Projects/bom-tool/test && node run-tests.js` — 4 pass
Total: 38 tests passing.
  </verify>
  <done>
validate.js exports isAssembly and validateBOM. merge.js uses isAssembly for all assembly detection (no more componentType checks for assembly identification). All 38 tests pass. Validation rules block invalid BOMs with descriptive error messages including full path and suggested fix.
  </done>
</task>

</tasks>

<verification>
1. `node test/validation-tests.js` — 15 tests pass covering all validation rules
2. `node test/merge-tests.js` — 19 tests pass (no regressions from isAssembly refactor)
3. `cd test && node run-tests.js` — 4 baseline tests pass
4. `grep -c "componentType === 'Assembly'" js/core/merge.js` returns 0 (all replaced with isAssembly)
5. `grep -c "isAssembly" js/core/merge.js` returns >= 5 (all detection points use isAssembly)
</verification>

<success_criteria>
- VALID-01: WIP non-assembly under Released parent returns blocking error with path and fix suggestion
- VALID-02: WIP GA returns blocking error with fix suggestion
- VALID-03 (partial): Source tagging already exists from Phase 11; assembly-only display is a Phase 14 UI concern
- Assembly identification uses nsItemType throughout merge engine
- All errors collected before blocking (tree fully walked)
- Zero regressions in existing 23 tests (19 merge + 4 baseline)
</success_criteria>

<output>
After completion, create `.planning/phases/13-validation-system/13-01-SUMMARY.md`
</output>
