---
phase: 01-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/core/environment.js
  - js/core/utils.js
  - js/core/tree.js
  - js/core/flatten.js
  - js/core/parser.js
  - js/core/compare.js
autonomous: true

must_haves:
  truths:
    - "All 4 existing validation tests pass against the current single-file codebase (baseline confirmed before extraction)"
    - "Core BOM functions exist as ES6 modules with named exports"
    - "Environment abstraction detects Node.js and provides DOMParser from xmldom"
    - "Module files contain the exact same logic as the copied functions in test/run-tests.js lines 22-462"
    - "No circular dependencies between modules"
    - "tree.js exports getter functions getRootPartNumber(), getRootRevision(), getRootDescription() for accessing root info set by buildTree()"
  artifacts:
    - path: "js/core/environment.js"
      provides: "Runtime detection, DOMParser abstraction, XLSX abstraction"
      exports: ["isBrowser", "isNode", "DOMParser", "XLSX"]
    - path: "js/core/utils.js"
      provides: "Zero-dependency utility functions"
      exports: ["parseLength", "decimalToFractional", "getParentLevel", "getCompositeKey"]
    - path: "js/core/tree.js"
      provides: "BOMNode class, tree construction, and root info getters"
      exports: ["BOMNode", "buildTree", "getRootPartNumber", "getRootRevision", "getRootDescription"]
    - path: "js/core/flatten.js"
      provides: "BOM flattening and sorting"
      exports: ["flattenBOM", "sortBOM"]
    - path: "js/core/parser.js"
      provides: "XML and CSV file parsing"
      exports: ["parseXML", "parseCSV"]
    - path: "js/core/compare.js"
      provides: "BOM comparison and subtree operations"
      exports: ["compareBOMs", "findNodeByPartNumber", "extractSubtree"]
  key_links:
    - from: "js/core/tree.js"
      to: "js/core/utils.js"
      via: "import { parseLength, getParentLevel } from './utils.js'"
      pattern: "import.*from.*utils\\.js"
    - from: "js/core/flatten.js"
      to: "js/core/utils.js"
      via: "import { getCompositeKey, decimalToFractional } from './utils.js'"
      pattern: "import.*from.*utils\\.js"
    - from: "js/core/parser.js"
      to: "js/core/environment.js"
      via: "import { DOMParser, XLSX } from './environment.js'"
      pattern: "import.*from.*environment\\.js"
    - from: "js/core/parser.js"
      to: "js/core/tree.js"
      via: "import { BOMNode } from './tree.js'"
      pattern: "import.*BOMNode.*from.*tree\\.js"
    - from: "js/core/compare.js"
      to: "js/core/tree.js"
      via: "import { BOMNode } from './tree.js'"
      pattern: "import.*BOMNode.*from.*tree\\.js"
---

<objective>
Extract the core BOM processing functions from copied code in the test harness into proper ES6 module files under `js/core/`. These modules become the single source of truth for all business logic, used by both the test harness (Node.js) and eventually the browser application.

Purpose: Create the module files that the test harness will import from, eliminating the ~430 lines of duplicated production code in `test/run-tests.js`. This is the foundation for all subsequent refactoring phases.

Output: Six ES6 module files in `js/core/` with named exports matching the exact function signatures and behavior of the copied functions currently in `test/run-tests.js`.
</objective>

<execution_context>
@C:\Users\amcallister\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\amcallister\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-infrastructure/01-CONTEXT.md
@.planning/phases/01-test-infrastructure/01-RESEARCH.md
@test/run-tests.js
</context>

<tasks>

<task type="auto">
  <name>Task 0: Confirm baseline - all 4 existing tests pass</name>
  <files>(no files modified - verification only)</files>
  <action>
Run the existing test suite to establish the baseline before any extraction work begins. This confirms the starting point is healthy and gives us the exact expected outputs to compare against after extraction.

Run from the project root:
```bash
cd test && node run-tests.js
```

Expected output: `4/4 tests passed` and `ALL TESTS PASSED`.

If any tests fail, STOP. Do not proceed with extraction. Investigate and report the failure. The baseline must be green before extraction begins.

Record the exact console output (test names, pass/fail status, item counts) for comparison after extraction is complete.
  </action>
  <verify>
```bash
cd test && node run-tests.js
```
Expected: `4/4 tests passed` and `ALL TESTS PASSED`. All counts match: 201 flat items, 41/41/19 comparison changes.
  </verify>
  <done>All 4 existing validation tests pass against the current single-file codebase. Baseline is confirmed green.</done>
</task>

<task type="auto">
  <name>Task 1: Create environment abstraction and utility modules</name>
  <files>js/core/environment.js, js/core/utils.js</files>
  <action>
Create the `js/core/` directory structure explicitly:
```bash
mkdir -p js/core
```
(On Windows: `mkdir js\core` if mkdir -p is unavailable. The executor should use whichever works.)

Then create two leaf-level modules (no internal dependencies):

**js/core/environment.js** - Runtime environment detection and platform-specific dependency loading:
- Export `isBrowser` constant: `typeof window !== 'undefined'`
- Export `isNode` constant: `typeof process !== 'undefined' && process.versions?.node`
- Export `DOMParser`: In Node.js, dynamically import from 'xmldom' package. In browser, use `window.DOMParser`.
- Export `XLSX`: In Node.js, dynamically import from 'xlsx' package and call `XLSX.set_fs(fs)`. In browser, use `window.XLSX`.
- Use top-level `await` for dynamic imports (supported in ES modules).
- Include validation: throw helpful error if browser XLSX is undefined.

**js/core/utils.js** - Zero-dependency utility functions (no imports from other js/core/ files):
- Export `parseLength(lengthStr)` - copied exactly from test/run-tests.js lines 28-39
- Export `decimalToFractional(decimal)` - copied exactly from test/run-tests.js lines 112-137
- Export `getParentLevel(level)` - copied exactly from test/run-tests.js lines 42-45
- Export `getCompositeKey(partNumber, length)` - copied exactly from test/run-tests.js lines 104-109

CRITICAL: Copy function bodies EXACTLY from test/run-tests.js. Do not optimize, refactor, or "improve" any logic. The zero-tolerance requirement means identical behavior.
  </action>
  <verify>
Verify both files exist and have correct exports by creating temporary verify scripts (avoids Windows multi-line node -e issues):

Write a file `js/core/_verify-env.mjs` with this content:
```javascript
import { isBrowser, isNode, DOMParser, XLSX } from './environment.js';
console.log('environment.js exports:', ['isBrowser', 'isNode', 'DOMParser', 'XLSX'].join(', '));
console.log('isNode:', !!isNode);
console.log('DOMParser type:', typeof DOMParser);
console.log('PASS: environment.js');
```
Run: `node js/core/_verify-env.mjs`

Write a file `js/core/_verify-utils.mjs` with this content:
```javascript
import { parseLength, decimalToFractional, getParentLevel, getCompositeKey } from './utils.js';
console.log('parseLength test:', parseLength('17.063'));
console.log('fractional test:', decimalToFractional(17.063));
console.log('parentLevel test:', getParentLevel('1.1.1'));
console.log('compositeKey test:', getCompositeKey('PART1', 17.063));
console.log('PASS: utils.js');
```
Run: `node js/core/_verify-utils.mjs`

After verification, delete both temporary files:
```bash
del js\core\_verify-env.mjs js\core\_verify-utils.mjs
```
(Or `rm` on non-Windows.)

Expected: Both scripts print PASS. environment.js exports isBrowser, isNode, DOMParser, XLSX. Utils functions return correct values.
  </verify>
  <done>environment.js and utils.js exist in js/core/ with all named exports. Quick smoke test shows functions return expected values.</done>
</task>

<task type="auto">
  <name>Task 2: Create tree, flatten, parser, and compare modules</name>
  <files>js/core/tree.js, js/core/flatten.js, js/core/parser.js, js/core/compare.js</files>
  <action>
Create four modules that import from environment.js and utils.js:

**js/core/tree.js** - BOMNode class and tree construction:
- `import { parseLength, getParentLevel } from './utils.js';`
- Export `BOMNode` class - copied exactly from test/run-tests.js lines 49-65. Note: constructor calls `parseLength()` for the length field.
- Export `buildTree(rows)` function - copied exactly from test/run-tests.js lines 68-101. `buildTree()` returns `root` (the root BOMNode), same as current behavior.
- **Root info getter pattern**: `buildTree()` currently sets global variables `rootPartNumber`, `rootRevision`, `rootDescription` (lines 96-98). In the module version:
  1. Declare three module-level `let` variables: `let _rootPartNumber = null;`, `let _rootRevision = null;`, `let _rootDescription = null;`
  2. Inside `buildTree()`, set these variables (same as current lines 96-98): `_rootPartNumber = root.partNumber;` etc.
  3. `buildTree()` still returns just `root` (same return signature as current code).
  4. Export three getter functions:
     ```javascript
     export function getRootPartNumber() { return _rootPartNumber; }
     export function getRootRevision() { return _rootRevision; }
     export function getRootDescription() { return _rootDescription; }
     ```
  5. This way, callers that need root info (like the test harness in Plan 01-02) import the getters instead of relying on globals.

**js/core/flatten.js** - BOM flattening and sorting:
- `import { getCompositeKey, decimalToFractional } from './utils.js';`
- Export `flattenBOM(rootNode, unitQty)` - copied exactly from test/run-tests.js lines 140-185. Note: calls getCompositeKey() and decimalToFractional() from utils.
- Export `sortBOM(items)` - copied exactly from test/run-tests.js lines 188-209.

**js/core/parser.js** - XML and CSV parsing:
- `import { DOMParser, XLSX, isNode } from './environment.js';`
- Export `parseXML(xmlText)` - copied exactly from test/run-tests.js lines 212-303. Replace the direct `new DOMParser()` with the imported DOMParser.
- Export `parseCSV(csvTextOrPath)` - Adapted from test/run-tests.js lines 306-339. In Node.js mode, if argument looks like a file path, read it from disk. In browser mode, expect text content directly. The current test version always reads from file path. The function should handle both: if isNode and argument contains path separator, read from disk; otherwise treat as text content.
- IMPORTANT: parseCSV uses `fs.readFileSync` and `XLSX` directly. In the module version, import fs conditionally (only in Node.js) and use the XLSX from environment.js.

**js/core/compare.js** - BOM comparison and subtree operations:
- `import { getCompositeKey, parseLength } from './utils.js';`
- `import { BOMNode } from './tree.js';`
- Export `compareBOMs(oldFlattened, newFlattened)` - copied exactly from test/run-tests.js lines 346-427.
- Export `findNodeByPartNumber(node, targetPartNumber)` - copied exactly from test/run-tests.js lines 430-439.
- Export `extractSubtree(node)` - copied exactly from test/run-tests.js lines 442-462. Note: creates new BOMNode instances, so needs the BOMNode import.

CRITICAL: Copy all function bodies EXACTLY. Do not change any logic, conditionals, or string handling. The only changes allowed are: (1) adding import statements, (2) adding export keywords, (3) replacing direct `new DOMParser()` with the imported abstraction, (4) replacing direct `fs`/`XLSX` references with imported abstractions, (5) the root info getter pattern described above for tree.js.
  </action>
  <verify>
Verify all four modules load correctly in Node.js. Write a temporary verify script to avoid Windows multi-line node -e issues:

Write a file `js/core/_verify-modules.mjs` with this content:
```javascript
import { BOMNode, buildTree, getRootPartNumber, getRootRevision, getRootDescription } from './tree.js';
import { flattenBOM, sortBOM } from './flatten.js';
import { parseXML, parseCSV } from './parser.js';
import { compareBOMs, findNodeByPartNumber, extractSubtree } from './compare.js';
console.log('All modules imported successfully');
console.log('BOMNode:', typeof BOMNode);
console.log('buildTree:', typeof buildTree);
console.log('getRootPartNumber:', typeof getRootPartNumber);
console.log('getRootRevision:', typeof getRootRevision);
console.log('getRootDescription:', typeof getRootDescription);
console.log('flattenBOM:', typeof flattenBOM);
console.log('sortBOM:', typeof sortBOM);
console.log('parseXML:', typeof parseXML);
console.log('parseCSV:', typeof parseCSV);
console.log('compareBOMs:', typeof compareBOMs);
console.log('findNodeByPartNumber:', typeof findNodeByPartNumber);
console.log('extractSubtree:', typeof extractSubtree);
console.log('PASS: all modules');
```
Run: `node js/core/_verify-modules.mjs`
Then delete: `del js\core\_verify-modules.mjs` (or `rm` on non-Windows)

Expected: All imports resolve, all exports are functions (BOMNode is function/class), getters are functions. Script prints PASS.
  </verify>
  <done>All four module files exist in js/core/ with correct imports and exports. tree.js exports getRootPartNumber(), getRootRevision(), getRootDescription() getters. All modules load without errors in Node.js. No circular dependencies.</done>
</task>

<task type="auto">
  <name>Task 3: Quick integration smoke test of extracted modules</name>
  <files>(no new files - tests existing modules)</files>
  <action>
Run a quick integration test to verify the extracted modules can actually process a test file end-to-end. This catches any subtle extraction errors before Plan 02 rewires the full test harness.

Write a temporary smoke test script `js/core/_smoke-test.mjs` with this content:
```javascript
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { parseXML } from './parser.js';
import { buildTree, getRootPartNumber } from './tree.js';
import { flattenBOM, sortBOM } from './flatten.js';
import { compareBOMs } from './compare.js';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const testDataDir = path.join(__dirname, '..', '..', 'test-data');

// Test 1: Flat BOM pipeline
const xmlText = fs.readFileSync(path.join(testDataDir, '258730-Rev2-20260105.XML'), 'utf8');
const rows = parseXML(xmlText);
console.log('Parsed rows:', rows.length);

const root = buildTree(rows);
console.log('Root part:', root.partNumber);
console.log('Root via getter:', getRootPartNumber());

const flattened = flattenBOM(root, 1);
const sorted = sortBOM(flattened);
console.log('Flattened items:', sorted.length);
console.log('Expected: 201 items');
const test1 = sorted.length === 201;
console.log(test1 ? 'TEST 1 PASS' : 'TEST 1 FAIL - count mismatch');

// Test 2: Comparison pipeline
const oldXml = fs.readFileSync(path.join(testDataDir, '258754-Rev0-20251220.XML'), 'utf8');
const newXml = fs.readFileSync(path.join(testDataDir, '258754-Rev1-20260112.XML'), 'utf8');

const oldRows = parseXML(oldXml);
const oldTree = buildTree(oldRows);
const oldFlat = flattenBOM(oldTree, 1);

const newRows = parseXML(newXml);
const newTree = buildTree(newRows);
const newFlat = flattenBOM(newTree, 1);

const results = compareBOMs(oldFlat, newFlat);
console.log('Comparison results:', results.length);
console.log('Expected: 41 changes');
const test2 = results.length === 41;
console.log(test2 ? 'TEST 2 PASS' : 'TEST 2 FAIL - count mismatch');

// Summary
if (test1 && test2) {
    console.log('\nALL SMOKE TESTS PASSED');
} else {
    console.log('\nSMOKE TESTS FAILED');
    process.exit(1);
}
```

Run: `node js/core/_smoke-test.mjs`

If the count does not match 201 or 41, investigate and fix the extraction error in the relevant module file. The counts are confirmed from the current test run output.

After both tests pass, delete the temporary script:
```bash
del js\core\_smoke-test.mjs
```
(Or `rm` on non-Windows.)

Both tests must output PASS. If either fails, fix the module extraction error before completing this task.
  </action>
  <verify>
Run `node js/core/_smoke-test.mjs` and confirm output ends with `ALL SMOKE TESTS PASSED`.
Both item counts match: 201 flat items, 41 comparison changes.
getRootPartNumber() getter returns the correct root part number.
  </verify>
  <done>Extracted modules produce identical outputs to the copied functions for both flat BOM and comparison pipelines. Root info getters work correctly.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Baseline confirmed: existing tests passed 4/4 before extraction (Task 0)
2. `js/core/` directory exists with 6 files: environment.js, utils.js, tree.js, flatten.js, parser.js, compare.js
3. tree.js exports getRootPartNumber(), getRootRevision(), getRootDescription() getter functions
4. All modules import cleanly in Node.js (no missing dependencies, no circular imports)
5. Quick smoke tests confirm flat BOM produces 201 items and comparison produces 41 changes
6. No modifications made to index.html or test/run-tests.js (those happen in Plan 02)
7. No temporary verify scripts remain in js/core/ (all _verify-*.mjs and _smoke-test.mjs cleaned up)
</verification>

<success_criteria>
- Baseline 4/4 tests pass confirmed before extraction begins
- Six ES6 module files exist in js/core/ with correct named exports
- tree.js exports getRootPartNumber, getRootRevision, getRootDescription getters
- Modules use environment abstraction for DOMParser and XLSX (cross-environment compatible)
- All .js extensions present in import paths
- Quick integration smoke tests pass (201 flat items, 41 comparison changes)
- Zero logic changes from the copied functions in test/run-tests.js
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-infrastructure/01-01-SUMMARY.md`
</output>
