---
phase: 01-test-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - test/run-tests.js
  - .planning/phases/01-test-infrastructure/SMOKE-TEST.md
autonomous: false

must_haves:
  truths:
    - "Test runner imports all BOM functions from js/core/ modules, not from copied code"
    - "All 4 validation tests pass with identical results to baseline (201 flat items, 41/41/19 comparison changes)"
    - "Test runner imports successfully from js/core/ modules with zero local function definitions for BOM logic"
    - "Browser smoke test checklist exists for manual visual verification"
    - "Test execution completes in under 10 seconds"
  artifacts:
    - path: "test/run-tests.js"
      provides: "Test runner importing from js/core/ modules"
      min_lines: 300
    - path: ".planning/phases/01-test-infrastructure/SMOKE-TEST.md"
      provides: "Browser smoke test checklist for manual verification"
      min_lines: 15
  key_links:
    - from: "test/run-tests.js"
      to: "js/core/parser.js"
      via: "import { parseXML, parseCSV } from '../js/core/parser.js'"
      pattern: "import.*from.*js/core/parser\\.js"
    - from: "test/run-tests.js"
      to: "js/core/tree.js"
      via: "import { BOMNode, buildTree, getRootPartNumber, getRootRevision, getRootDescription } from '../js/core/tree.js'"
      pattern: "import.*from.*js/core/tree\\.js"
    - from: "test/run-tests.js"
      to: "js/core/flatten.js"
      via: "import { flattenBOM, sortBOM } from '../js/core/flatten.js'"
      pattern: "import.*from.*js/core/flatten\\.js"
    - from: "test/run-tests.js"
      to: "js/core/compare.js"
      via: "import { compareBOMs, findNodeByPartNumber, extractSubtree } from '../js/core/compare.js'"
      pattern: "import.*from.*js/core/compare\\.js"
    - from: "test/run-tests.js"
      to: "js/core/utils.js"
      via: "import { getCompositeKey, parseLength } from '../js/core/utils.js'"
      pattern: "import.*from.*js/core/utils\\.js"
---

<objective>
Rewrite the test harness to import BOM functions from the new `js/core/` module files instead of using copied code. Delete the ~430 lines of duplicated production functions. Verify all 4 validation tests still pass with identical results. Create a browser smoke test checklist for manual visual verification after each phase.

Purpose: Complete the Phase 1 goal -- test harness validates modular code structure. After this plan, the test runner is the safety net for all subsequent refactoring: if modules produce wrong outputs, tests catch it immediately.

Output: Updated test/run-tests.js importing from js/core/ modules. Browser smoke test checklist. All 4 tests passing.
</objective>

<execution_context>
@C:\Users\amcallister\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\amcallister\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-infrastructure/01-CONTEXT.md
@.planning/phases/01-test-infrastructure/01-01-SUMMARY.md
@test/run-tests.js
@js/core/parser.js
@js/core/tree.js
@js/core/flatten.js
@js/core/compare.js
@js/core/utils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite test harness to import from js/core/ modules</name>
  <files>test/run-tests.js</files>
  <action>
Rewrite `test/run-tests.js` to import BOM functions from the new module files instead of containing copied code.

**Step 1: Replace the import section (top of file)**

Current imports (keep these):
```javascript
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
```

Remove these direct imports (now handled by environment.js):
```javascript
import XLSX from 'xlsx';
import { DOMParser } from 'xmldom';
```

Add new module imports:
```javascript
import XLSX from 'xlsx';
import { BOMNode, buildTree, getRootPartNumber, getRootRevision, getRootDescription } from '../js/core/tree.js';
import { flattenBOM, sortBOM } from '../js/core/flatten.js';
import { parseXML, parseCSV } from '../js/core/parser.js';
import { compareBOMs, findNodeByPartNumber, extractSubtree } from '../js/core/compare.js';
import { parseLength, getCompositeKey, decimalToFractional } from '../js/core/utils.js';
```

NOTE: Keep the direct `import XLSX from 'xlsx'` in the test file because the test harness needs XLSX to READ the expected output Excel files (validation baselines). The modules use XLSX internally via environment.js for parsing. The test file needs its own XLSX for `XLSX.readFile()` calls on expected output files.

NOTE: Import `getRootPartNumber`, `getRootRevision`, `getRootDescription` from tree.js. These replace the old global variables `rootPartNumber`, `rootRevision`, `rootDescription`. Any test code that previously read those globals should now call the getter functions instead (e.g., `rootPartNumber` becomes `getRootPartNumber()`).

**Step 2: Delete ALL copied production functions (lines ~22-462)**

Delete everything between the comment blocks:
- `// EXTRACTED FUNCTIONS FROM BOM TOOL.HTML` through to the last function before `// TEST FUNCTIONS`
- This includes: global variables (rootPartNumber, rootRevision, rootDescription), parseLength, getParentLevel, BOMNode, buildTree, getCompositeKey, decimalToFractional, flattenBOM, sortBOM, parseXML, parseCSV, compareBOMs, findNodeByPartNumber, extractSubtree
- Delete the `// COMPARISON FUNCTIONS` section too (compareBOMs, findNodeByPartNumber, extractSubtree are now imported)

**Step 3: Replace global variable references with getter calls**

Search the test functions for any references to `rootPartNumber`, `rootRevision`, `rootDescription` and replace them with `getRootPartNumber()`, `getRootRevision()`, `getRootDescription()` respectively. These are likely used in console.log or assertion statements within the test cases.

**Step 4: Keep ALL test infrastructure functions intact**

Keep these functions exactly as they are (they are test-specific, not production code):
- `testDataPath(filename)` - resolves test data paths
- `compareFlattened(result, expected)` - compares flat BOM results to expected Excel
- `compareComparisonResults(results, expected)` - compares comparison results to expected Excel
- `runTest(testName, testFunc)` - test runner wrapper

**Step 5: Keep ALL test case functions intact**

Keep these functions exactly as they are (except for the getter replacements in Step 3):
- `test1_FlatBOM_XML()`
- `test2_Comparison_CSV()`
- `test3_Comparison_XML()`
- `test4_ScopedComparison()`
- The test runner section at the bottom

The test functions call parseXML, parseCSV, buildTree, flattenBOM, sortBOM, compareBOMs, findNodeByPartNumber, extractSubtree - these now resolve to the imported module functions instead of the deleted copies.

**Step 6: Verify the rewritten file structure is clean**

The resulting file should be approximately:
- ~10 lines of imports (fs, path, url, XLSX, plus 5 module imports)
- ~5 lines of setup (dirname, testDataDir, testDataPath)
- ~215 lines of comparison/test infrastructure functions
- ~180 lines of test cases and runner
- Total: ~410 lines (down from ~883)

IMPORTANT: Do NOT change any logic in compareFlattened, compareComparisonResults, or any test function. These functions use getCompositeKey and parseLength which are now imported instead of local - but the calls are identical.
  </action>
  <verify>
Run the full test suite:
```bash
cd test && node run-tests.js
```

Expected output:
```
4/4 tests passed
ALL TESTS PASSED
```

Also verify no copied functions remain. Search for the old comment block:
```bash
node -e "const fs = require('fs'); const f = fs.readFileSync('test/run-tests.js','utf8'); console.log(f.includes('EXTRACTED FUNCTIONS') ? 'FAIL: old code remains' : 'PASS: no copied functions');"
```
Expected: `PASS: no copied functions`

Verify test execution time is under 10 seconds (just observe the elapsed time from the test run above).
  </verify>
  <done>test/run-tests.js imports all BOM functions from js/core/ modules including getRootPartNumber/getRootRevision/getRootDescription getters. Zero copied production functions remain. All 4 tests pass with identical results. Execution under 10 seconds.</done>
</task>

<task type="auto">
  <name>Task 2: Create browser smoke test checklist</name>
  <files>.planning/phases/01-test-infrastructure/SMOKE-TEST.md</files>
  <action>
Create a short, practical browser smoke test checklist that the user can follow after each phase to manually verify visual correctness. This is NOT for data accuracy (that is the automated tests' job) -- this is purely "does the UI look right."

The checklist should:
1. Reference specific test-data files so it is repeatable
2. Cover all three tabs (Flat BOM, BOM Comparison, Hierarchy View)
3. Be concise -- the user opens the page, loads files, eyeballs the result
4. Note that automated tests handle all data/export correctness

Content for SMOKE-TEST.md:

```markdown
# Browser Smoke Test Checklist

Run this checklist after each refactoring phase to verify visual correctness.
Automated tests (`npm test` in the test/ directory) handle all data accuracy.
This checklist is only for "does the UI look and feel right."

## Prerequisites

- Open `index.html` in your browser (Chrome, Edge, or Firefox)
- Have these test files ready from the `test-data/` folder

## Checklist

### Tab 1: Flat BOM
- [ ] Load `test-data/258730-Rev2-20260105.XML`
- [ ] Results table appears with data (rows visible, columns aligned)
- [ ] Filename displays prominently above the table
- [ ] Part Number and Description shown below filename
- [ ] Statistics bar shows item count

### Tab 2: BOM Comparison
- [ ] Switch to "BOM Comparison" tab
- [ ] Load `test-data/258754-Rev0-20251220.XML` as Old BOM
- [ ] Load `test-data/258754-Rev1-20260112.XML` as New BOM
- [ ] Comparison results table appears with colored rows (green/red/yellow)
- [ ] Filter buttons work (All, Added, Removed, Changed)
- [ ] Statistics bar shows change counts

### Tab 3: Hierarchy View
- [ ] Switch to "Hierarchy View" tab
- [ ] Load `test-data/258730-Rev2-20260105.XML`
- [ ] Tree structure appears with expand/collapse toggles
- [ ] Clicking +/- toggles expand/collapse children
- [ ] "Expand All" and "Collapse All" buttons work
- [ ] Tree connector lines display correctly (vertical and horizontal lines)

### General
- [ ] Tab switching works (click each tab, content changes)
- [ ] Fonts load correctly (JetBrains Mono for data, Work Sans for UI)
- [ ] No console errors (open DevTools with F12 and check Console tab)

## When This Fails

If visual issues appear after a phase:
1. Note which checklist item failed
2. Report to Claude with the specific item and what looks wrong
3. Automated tests should still pass (data is correct even if display is off)
```
  </action>
  <verify>File exists at `.planning/phases/01-test-infrastructure/SMOKE-TEST.md` and contains all three tab sections.</verify>
  <done>Browser smoke test checklist exists with specific test-data file references for all three tabs.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 1 complete: Test harness now imports BOM functions from js/core/ module files instead of using copied code. All 4 validation tests pass. Browser smoke test checklist created.

Summary of changes:
- Created 6 new module files in js/core/ (environment.js, utils.js, tree.js, flatten.js, parser.js, compare.js)
- tree.js exports getter functions (getRootPartNumber, getRootRevision, getRootDescription) replacing global variables
- Rewrote test/run-tests.js to import from modules (all duplicated production code deleted)
- All 4 tests produce identical results to baseline
- Browser smoke test checklist ready for use
  </what-built>
  <how-to-verify>
1. Open a terminal and run: `cd test && node run-tests.js`
   - Confirm output shows: `4/4 tests passed` and `ALL TESTS PASSED`
2. Review the smoke test checklist: `.planning/phases/01-test-infrastructure/SMOKE-TEST.md`
   - Run through the checklist items with index.html in your browser
   - Note: index.html has NOT been modified -- it should work exactly as before
3. Confirm you are comfortable with the module structure before we proceed to Phase 2
  </how-to-verify>
  <resume-signal>Type "approved" to proceed to Phase 2, or describe any issues you notice.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `test/run-tests.js` contains ZERO copied BOM functions (all imported from js/core/)
2. `test/run-tests.js` imports getRootPartNumber, getRootRevision, getRootDescription from js/core/tree.js
3. All 4 validation tests pass: `cd test && node run-tests.js` shows 4/4 passed
4. Test execution completes in under 10 seconds
5. `.planning/phases/01-test-infrastructure/SMOKE-TEST.md` exists with checklist for all 3 tabs
6. `index.html` is UNCHANGED (browser still works from single file)
7. Module dependency chain is clean: utils <- tree <- flatten, parser, compare (no circles)
</verification>

<success_criteria>
- test/run-tests.js imports from ../js/core/*.js modules (5 import statements)
- test/run-tests.js imports getter functions from tree.js (getRootPartNumber, getRootRevision, getRootDescription)
- No "EXTRACTED FUNCTIONS" comment block in test/run-tests.js
- `npm test` in test/ directory passes 4/4
- Execution time under 10 seconds
- SMOKE-TEST.md exists with checklist referencing test-data files
- User approves Phase 1 completion at checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-infrastructure/01-02-SUMMARY.md`
</output>
