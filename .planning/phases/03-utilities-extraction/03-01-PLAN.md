---
phase: 03-utilities-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [js/core/utils.js, index.html]
autonomous: false

must_haves:
  truths:
    - "All 5 utility functions (parseLength, decimalToFractional, getParentLevel, getCompositeKey, createDiff) are exported from js/core/utils.js"
    - "index.html inline script contains zero utility function definitions"
    - "index.html script tag is type='module' with import statement for all 5 utilities"
    - "All 4 automated tests pass with identical outputs"
    - "Application loads in browser without console errors"
  artifacts:
    - path: "js/core/utils.js"
      provides: "All 5 utility functions as named exports"
      exports: ["parseLength", "decimalToFractional", "getParentLevel", "getCompositeKey", "createDiff"]
    - path: "index.html"
      provides: "Module script with imports, no inline utility definitions"
      contains: "import { parseLength, decimalToFractional, getParentLevel, getCompositeKey, createDiff } from './js/core/utils.js'"
  key_links:
    - from: "index.html"
      to: "js/core/utils.js"
      via: "ES6 module import statement"
      pattern: "import.*from.*utils\\.js"
    - from: "test/run-tests.js"
      to: "js/core/utils.js"
      via: "ES6 module import (already working)"
      pattern: "import.*from.*utils\\.js"
---

<objective>
Complete utility function extraction: add the missing `createDiff` function to `js/core/utils.js`, convert the HTML inline script to an ES6 module, import all 5 utility functions, and remove all inline utility function definitions from `index.html`.

Purpose: Eliminates duplicate utility function definitions. After this plan, utility functions exist in exactly one place (`js/core/utils.js`) and are consumed via ES6 imports by both the browser app and the test harness.

Output: Updated `js/core/utils.js` with all 5 exports, updated `index.html` with module script and imports, zero inline utility definitions remaining.
</objective>

<execution_context>
@C:\Users\amcallister\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\amcallister\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-utilities-extraction/03-RESEARCH.md
@js/core/utils.js
@index.html (lines 393, 648-658, 661-665, 742-747, 811-836, 2030-2060)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add createDiff to utils.js and convert HTML to module</name>
  <files>js/core/utils.js, index.html</files>
  <action>
**Step 1: Add createDiff to js/core/utils.js**

Append the `createDiff` function to the end of `js/core/utils.js`. Copy it VERBATIM from `index.html` lines 2030-2060. Add the `export` keyword before `function`. The function signature is:

```javascript
export function createDiff(oldText, newText) {
```

The function returns an object `{ old: string, new: string }` where the strings may contain HTML `<span>` tags for diff highlighting. Do NOT modify any logic — exact copy with `export` added.

**Step 2: Convert HTML script to ES6 module**

In `index.html`, change line 393 from:
```html
<script>
```
to:
```html
<script type="module">
```

**Step 3: Add import statement**

Immediately after the opening `<script type="module">` tag (new line 394), add:
```javascript
        import { parseLength, decimalToFractional, getParentLevel, getCompositeKey, createDiff } from './js/core/utils.js';
```

Use 8 spaces of indentation to match the existing code indentation style in the script block.

**Step 4: Remove inline utility function definitions**

Remove these 5 inline function definitions from `index.html` (including their preceding comment lines and trailing blank lines):

1. `parseLength` — lines 647-658 (comment + function + blank line after closing brace)
2. `getParentLevel` — lines 660-665 (comment + function + blank line after closing brace)
3. `getCompositeKey` — lines 741-747 (comment + function + blank line after closing brace)
4. `decimalToFractional` — lines 810-836 (comment + function + blank line after closing brace)
5. `createDiff` — lines 2029-2060 (comment + function + blank line after closing brace)

**IMPORTANT**: Remove ONLY the function definitions and their comment headers. Do NOT remove surrounding code. Be careful with line numbers — they shift as you remove earlier functions. Work from bottom to top (createDiff first, then decimalToFractional, then getCompositeKey, then getParentLevel, then parseLength) to avoid line number drift.

After removal, verify no orphaned blank lines pile up (one blank line between functions is fine).
  </action>
  <verify>
1. Run `grep -n "function parseLength\|function decimalToFractional\|function getParentLevel\|function getCompositeKey\|function createDiff" index.html` — expect ZERO matches
2. Run `grep -c "export function" js/core/utils.js` — expect exactly 5
3. Run `grep "type=\"module\"" index.html` — expect match on the main script tag
4. Run `grep "import.*utils.js" index.html` — expect the import statement
5. Run `cd test && node run-tests.js` — all 4 tests must pass with identical outputs
  </verify>
  <done>
js/core/utils.js contains all 5 utility functions as named exports. index.html has zero inline utility function definitions. Script tag is type="module" with import statement. All 4 automated tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Browser smoke test — verify all tabs work with module imports</name>
  <what-built>
Converted the HTML inline script from classic to ES6 module. All 5 utility functions now imported from js/core/utils.js instead of being defined inline. This is the first time the browser loads the application as an ES6 module.
  </what-built>
  <how-to-verify>
Open index.html in the browser. **Note: ES6 modules require a web server — file:// protocol may cause CORS errors. If the page doesn't load, try using VS Code Live Server, or run `python -m http.server 8000` from the project root and open http://localhost:8000.**

1. **Check browser console (F12 > Console)**:
   - No `SyntaxError: Cannot use import statement outside a module` (confirms type="module")
   - No `Failed to resolve module specifier` (confirms import path is correct)
   - No `CORS policy` errors (confirms serving correctly)
   - No `ReferenceError` for any utility function name

2. **Test Flat BOM tab**:
   - Upload `test-data/258730-Rev2-20260105.XML`
   - Verify results table appears with fractional lengths (tests `decimalToFractional`, `parseLength`)
   - Verify items are aggregated correctly (tests `getCompositeKey`)

3. **Test BOM Comparison tab**:
   - Upload old: `test-data/258730-Rev1-20260105.XML`
   - Upload new: `test-data/258730-Rev2-20260105.XML`
   - Click Compare
   - Find a "Changed" item and verify red/green word-level diff highlighting appears (tests `createDiff`)

4. **Test Hierarchy View tab**:
   - Upload `test-data/258730-Rev2-20260105.XML`
   - Verify tree renders with expand/collapse toggles (tests `getParentLevel`)

5. **Check DevTools Network tab (F12 > Network)**:
   - Verify `js/core/utils.js` loads successfully (200 status)
   - No 404 errors for module files

If changes don't appear after refresh, try hard refresh (Ctrl+Shift+R) to bypass cache.
  </how-to-verify>
  <resume-signal>Type "approved" if all tabs work correctly, or describe any issues you see.</resume-signal>
</task>

</tasks>

<verification>
1. `grep -n "function parseLength\|function decimalToFractional\|function getParentLevel\|function getCompositeKey\|function createDiff" index.html` returns NO matches
2. `grep -c "export function" js/core/utils.js` returns exactly 5
3. `grep 'type="module"' index.html` matches the main script tag
4. `grep "import.*from.*utils.js" index.html` matches the import statement
5. `node test/run-tests.js` — all 4 tests pass
6. Browser smoke test confirms all three tabs work without console errors
</verification>

<success_criteria>
- js/core/utils.js exports all 5 utility functions (parseLength, decimalToFractional, getParentLevel, getCompositeKey, createDiff)
- index.html contains zero inline utility function definitions
- index.html script tag is type="module" with import statement
- All 4 automated tests pass with identical outputs to before this change
- Browser loads and all three tabs function correctly (verified by user)
</success_criteria>

<output>
After completion, create `.planning/phases/03-utilities-extraction/03-01-SUMMARY.md`
</output>
